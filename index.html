<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Foto Manager - Galerie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #faf6f1;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5ede5;
            --text-primary: #3f352f;
            --text-secondary: #6f615a;
            --accent: #d4a574;
            --accent-hover: #c9945e;
            --border: #e8ddd1;
            --shadow: 0 20px 50px rgba(0,0,0,0.08);
            --lightbox-sidebar-width: 200px;
            --sticky-sidebar-top: 18px;

            /* Gallery topbar/sidebar metrics (computed in JS when gallery is visible) */
            --gallery-fixed-top: calc(var(--sticky-sidebar-top) + env(safe-area-inset-top, 0px));
            --gallery-header-h: 0px;
            --gallery-filters-h: 0px;
            --gallery-topbar-gap: 10px;
            --gallery-topbar-h: calc(var(--gallery-header-h) + var(--gallery-topbar-gap) + var(--gallery-filters-h));
            --gallery-fixed-width: min(1400px, calc(100% - 40px));

            --gallery-layout-gap: 20px;
            --gallery-sidebar-w: 200px;
            --gallery-sidebar-collapsed-w: 40px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: radial-gradient(circle at top, rgba(212, 165, 116, 0.06), transparent 55%), var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        html {
            overflow-x: hidden;
        }

        html {
            scroll-padding-top: calc(var(--gallery-fixed-top) + var(--gallery-topbar-h) + 18px);
        }

        body.dark-mode {
            --bg-primary: #141312;
            --bg-secondary: #1c1a18;
            --bg-tertiary: #23201d;
            --text-primary: #f1ece6;
            --text-secondary: #b7a89c;
            --accent: #d4a574;
            --accent-hover: #e0b07f;
            --border: #2e2a26;
            --shadow: 0 18px 45px rgba(0,0,0,0.55);
            background: radial-gradient(circle at top, rgba(212, 165, 116, 0.10), transparent 55%), var(--bg-primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 22px 20px 56px;
        }

        header.site-header {
            position: relative;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            box-shadow: var(--shadow);
            margin-bottom: 22px;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-text p {
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-link {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9em;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            transition: all 0.2s;
        }

        .admin-link:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .hero-strip {
            margin-top: 18px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 14px;
        }

        .hero-copy h2 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .hero-copy p {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .hero-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        
        .hero-stat {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .hero-stat:hover {
            border-color: var(--accent);
            background: rgba(212, 165, 116, 0.08);
            transform: translateY(-2px);
        }
        
        .hero-stat span {
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }
        
        .hero-stat strong {
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Call-to-Action Bereich */
        .cta-section {
            margin-top: 40px;
            padding: 26px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.12) 0%, rgba(232, 184, 138, 0.08) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .cta-section h2 {
            font-size: 2em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .cta-section p {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 24px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .cta-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cta-button {
            padding: 14px 28px;
            border-radius: 999px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .cta-button.primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(212, 165, 116, 0.4);
        }
        
        .cta-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 165, 116, 0.5);
        }
        
        .cta-button.secondary {
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .cta-button.secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(212, 165, 116, 0.1);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: static;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 0;
            margin-bottom: 20px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .breadcrumb-item:hover {
            color: var(--accent);
        }
        
        .breadcrumb-item.active {
            color: var(--text-primary);
            cursor: default;
        }
        
        .breadcrumb-separator {
            color: var(--text-secondary);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo {
            width: 84px;
            height: 84px;
            border-radius: 16px;
            object-fit: contain;
            background: var(--bg-tertiary);
            padding: 8px;
            border: 1px solid var(--border);
        }
        
        h1 {
            font-size: 2.2em;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Portfolio Slider */
        .portfolio-slider-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 32px;
        }
        
        @media (max-width: 968px) {
            .portfolio-slider-wrapper {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }
        }
        
        .portfolio-slider {
            width: 100%;
            height: 300px;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            border: 1px solid var(--border);
        }

        /* Desktop: Slider-Höhe an Kategorien-Kachel angleichen (wird per JS gesetzt) */
        @media (min-width: 969px) {
            .selector-top .portfolio-slider-wrapper {
                height: var(--portfolio-match-height, auto);
                margin-bottom: 0;
            }

            .selector-top .portfolio-slider {
                height: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .portfolio-slider {
                height: 280px;
            }
        }
        
        .portfolio-slider-container {
            width: 100%;
            height: 100%;
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        
        .portfolio-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }
        
        .portfolio-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .portfolio-slide-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 30px;
            color: white;
        }
        
        .portfolio-slide-overlay h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .portfolio-slide-overlay p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .portfolio-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(212, 165, 116, 0.8);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .portfolio-nav:hover {
            background: rgba(212, 165, 116, 1);
            transform: translateY(-50%) scale(1.1);
        }
        
        .portfolio-nav.prev {
            left: 20px;
        }
        
        .portfolio-nav.next {
            right: 20px;
        }
        
        .portfolio-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .portfolio-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .portfolio-dot.active {
            background: var(--accent);
            transform: scale(1.3);
        }

        /* Startseite: Sidebar + Portfolio (unter Header) */
        .selector-top {
            display: grid;
            grid-template-columns: 180px minmax(0, 1fr);
            gap: 16px;
            margin-top: 16px;
            align-items: start;
        }

        @media (min-width: 1400px) {
            .selector-top {
                grid-template-columns: 220px minmax(0, 1fr);
                gap: 24px;
            }
        }

        @media (max-width: 968px) {
            .selector-top {
                grid-template-columns: 1fr;
            }
        }

        .portfolio-area {
            min-width: 0;
        }

        .selector-top .portfolio-slider-wrapper {
            margin-bottom: 0;
        }

        .galleries-area {
            margin-top: 18px;
        }

        #gallery-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding-top: 8px;
        }

        .gallery-group-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            padding: 0 2px;
        }

        .gallery-group-header h3 {
            margin: 0;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .gallery-group-count {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .gallery-group-grid {
            padding: 0;
            margin-top: 10px;
        }
        
        /* Kategorie-Sidebar für Startseite */
        .category-sidebar {
            width: 180px;
            min-width: 180px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 260px);
            border-radius: 14px;
            box-shadow: var(--shadow);
            position: sticky;
            top: calc(var(--sticky-sidebar-top) + env(safe-area-inset-top, 0px));
            align-self: flex-start;
        }
        
        @media (min-width: 1400px) {
            .category-sidebar {
                width: 220px;
                min-width: 220px;
                padding: 18px;
            }
        }
        
        .category-sidebar h3 {
            font-size: 0.95em;
            margin-bottom: 12px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .category-button {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-button:hover {
            background: rgba(212, 165, 116, 0.10);
            border-color: rgba(212, 165, 116, 0.25);
            transform: translateX(2px);
        }
        
        .category-button.active {
            background: rgba(212, 165, 116, 0.15);
            border-color: var(--accent);
            font-weight: 600;
            color: var(--accent);
        }
        
        .gallery-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 0 4px;
        }

        .gallery-search {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
        }

        .gallery-search input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.9em;
            outline: none;
        }

        .gallery-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 12px;
            padding: 12px 0 6px;
        }
        
        .main-content-with-sidebar {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            align-items: flex-start;
        }
        
        @media (min-width: 1200px) {
            .main-content-with-sidebar {
                gap: 24px;
            }
        }
        
        .gallery-card {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 0;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border 0.25s ease;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }
        
        .gallery-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 26px rgba(0,0,0,0.14);
            border-color: var(--accent);
        }
        
        .gallery-card.locked {
            opacity: 0.85;
        }

        .gallery-card.empty {
            opacity: 0.75;
        }

        .gallery-card-badge {
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            white-space: nowrap;
        }
        
        .gallery-card-preview {
            width: 100%;
            aspect-ratio: 16/10;
            background: var(--bg-tertiary);
            display: block;
            overflow: hidden;
            position: relative;
        }

        .gallery-card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .gallery-card-content {
            padding: 12px;
        }
        
        .gallery-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .gallery-card h3 {
            font-size: 1.05em;
            margin: 0;
            color: var(--text-primary);
            font-weight: 700;
            line-height: 1.3;
            flex: 1;
        }
        
        .gallery-card p {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 0.82em;
            line-height: 1.5;
        }
        
        .gallery-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        
        .gallery-card .image-count {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.82em;
        }
        
        .gallery-folder-header {
            grid-column: 1 / -1;
            margin: 14px 0 8px 0;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .gallery-folder-header h3 {
            margin: 0;
            color: var(--accent);
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        
        .password-form {
            max-width: 400px;
            margin: 40px auto;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .password-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .password-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .password-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .password-form button:hover {
            opacity: 0.9;
        }
        
        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px 18px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.78);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            position: fixed;
            top: var(--gallery-fixed-top);
            left: 50%;
            transform: translateX(-50%);
            width: var(--gallery-fixed-width);
            z-index: 300;
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }

        body.dark-mode .gallery-header {
            background: rgba(28,26,24,0.78);
        }

        .gallery-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .gallery-title h2 {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .gallery-title p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .gallery-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px 6px 14px;
            overflow-x: auto;
            position: fixed;
            top: calc(var(--gallery-fixed-top) + var(--gallery-header-h) + var(--gallery-topbar-gap));
            left: 50%;
            transform: translateX(-50%);
            width: var(--gallery-fixed-width);
            z-index: 290;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0);
            background: rgba(250, 246, 241, 0.45);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }

        body.dark-mode .quick-filters {
            background: rgba(20, 19, 18, 0.55);
        }

        #gallery-container {
            padding-top: calc(var(--gallery-fixed-top) + var(--gallery-topbar-h) + 18px);
        }

        .quick-filter-chip {
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            color: var(--text-primary);
            padding: 7px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 650;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease, color 0.15s ease;
            flex: 0 0 auto;
        }

        .quick-filter-chip:hover {
            border-color: rgba(212, 165, 116, 0.6);
            background: rgba(212, 165, 116, 0.10);
            transform: translateY(-1px);
        }

        .quick-filter-chip.active {
            border-color: var(--accent);
            background: rgba(212, 165, 116, 0.16);
            color: var(--accent);
        }

        /* Light mode: more contrast for chips/buttons */
        body:not(.dark-mode) .quick-filter-chip {
            background: rgba(255,255,255,0.78);
        }

        body:not(.dark-mode) .quick-filter-chip.active {
            background: var(--accent);
            border-color: var(--accent-hover);
            color: #1f1610;
        }

        body:not(.dark-mode) .gallery-chip,
        body:not(.dark-mode) .gallery-chip-button,
        body:not(.dark-mode) .gallery-sort-select {
            background: rgba(255,255,255,0.78);
        }

        .quick-filter-sep {
            width: 1px;
            height: 18px;
            background: var(--border);
            flex: 0 0 auto;
            opacity: 0.9;
        }

        .gallery-chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.04);
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .gallery-chip-button {
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.04);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            cursor: pointer;
            line-height: 1;
        }

        .gallery-chip-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .gallery-sort-select {
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.04);
            color: var(--text-primary);
            padding: 8px 34px 8px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            cursor: pointer;
            line-height: 1;
            background-image: linear-gradient(45deg, transparent 50%, var(--text-secondary) 50%),
                linear-gradient(135deg, var(--text-secondary) 50%, transparent 50%);
            background-position: calc(100% - 16px) calc(50% - 1px), calc(100% - 11px) calc(50% - 1px);
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
        }

        .gallery-sort-select:hover {
            border-color: var(--accent);
        }

        .gallery-sort-select:focus-visible {
            outline: 3px solid rgba(212, 165, 116, 0.35);
            outline-offset: 2px;
        }

        .gallery-chip-button:focus-visible {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.35);
        }

        .back-button {
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            gap: 14px;
            padding: 16px 0;
        }
        
        .gallery-item {
            position: relative;
            aspect-ratio: 4/3;
            overflow: hidden;
            border-radius: 12px;
            cursor: pointer;
            background: #2a2a2a;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .gallery-item:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            z-index: 10;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gallery-item.is-loaded img {
            opacity: 1;
        }
        
        .gallery-item:hover img {
            transform: scale(1.1);
        }

        /* Pro Focus Rings */
        :where(
            button,
            a,
            input,
            select,
            textarea,
            .gallery-item-btn,
            .category-button,
            .theme-toggle,
            .admin-link,
            .sidebar-toggle,
            .gallery-item-checkbox
        ):focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.32);
        }

        /* Bottom Selection Bar */
        .selection-bar {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            width: min(980px, calc(100% - 32px));
            z-index: 120;
        }

        .selection-bar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.78);
            box-shadow: var(--shadow);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
        }

        body.dark-mode .selection-bar-inner {
            background: rgba(28,26,24,0.78);
        }

        .selection-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .selection-bar-count {
            font-weight: 800;
            letter-spacing: 0.01em;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .selection-bar-hint {
            color: var(--text-secondary);
            font-size: 0.85em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selection-bar-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .lightbox-open .selection-bar {
            opacity: 0;
            pointer-events: none;
        }

        .has-selection-bar #gallery-container {
            padding-bottom: calc(92px + env(safe-area-inset-bottom, 0px));
        }

        @media (max-width: 520px) {
            .selection-bar-inner {
                flex-direction: column;
                align-items: stretch;
            }
            .selection-bar-actions {
                justify-content: stretch;
            }
            .selection-bar-actions button {
                width: 100%;
                justify-content: center;
            }
            .selection-bar-hint {
                display: none;
            }
        }

        /* Toasts */
        .toast-container {
            position: fixed;
            right: 16px;
            bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: min(420px, calc(100% - 32px));
        }

        .toast {
            pointer-events: none;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.84);
            color: var(--text-primary);
            box-shadow: var(--shadow);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            transform: translateY(8px);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        body.dark-mode .toast {
            background: rgba(28,26,24,0.84);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast strong {
            display: block;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .toast p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .toast--success { border-color: rgba(107, 207, 127, 0.45); }
        .toast--warning { border-color: rgba(255, 217, 61, 0.45); }
        .toast--danger { border-color: rgba(255, 107, 107, 0.45); }

        /* Modals (Confirm + Help) */
        body.modal-open {
            overflow: hidden;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            z-index: 12000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(18px + env(safe-area-inset-top, 0px)) 18px calc(18px + env(safe-area-inset-bottom, 0px));
            background: rgba(0,0,0,0.55);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }

        .modal-backdrop.is-hidden {
            display: none;
        }

        .modal {
            width: min(720px, 100%);
            max-height: calc(100vh - 56px);
            overflow: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: 0 22px 70px rgba(0,0,0,0.45);
            padding: 16px;
            color: var(--text-primary);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .modal-title {
            font-size: 1.02rem;
            font-weight: 800;
            letter-spacing: 0.01em;
        }

        .modal-close {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 1;
        }

        .modal-close:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal-body {
            margin-top: 10px;
            color: var(--text-secondary);
        }

        .modal-message {
            margin: 0;
            white-space: pre-line;
        }

        .modal-actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn-danger {
            border-color: rgba(255, 107, 107, 0.55) !important;
            background: rgba(255, 107, 107, 0.14) !important;
            color: #ffb7b7 !important;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .shortcuts-section {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
        }

        body.dark-mode .shortcuts-section {
            background: rgba(255,255,255,0.03);
        }

        .shortcuts-section h4 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .shortcut-row {
            display: flex;
            gap: 10px;
            align-items: baseline;
            justify-content: space-between;
            padding: 7px 0;
            border-top: 1px dashed rgba(255,255,255,0.08);
        }

        .shortcut-row:first-of-type {
            border-top: none;
            padding-top: 0;
        }

        .shortcut-row span {
            color: var(--text-secondary);
        }

        kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85em;
            padding: 2px 7px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            color: var(--text-primary);
            white-space: nowrap;
        }

        /* Disabled buttons (pro feedback) */
        button:disabled,
        button[aria-disabled="true"] {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Overlay - erscheint beim Hover */
        .gallery-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.26) 0%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.38) 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            opacity: 1;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        
        .gallery-item-overlay .gallery-item-checkbox,
        .gallery-item-overlay .gallery-item-actions {
            pointer-events: auto;
        }
        
        /* Checkbox oben links */
        .gallery-item-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 6px;
            background: rgba(0,0,0,0.3);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .gallery-item-checkbox:hover {
            background: rgba(212, 165, 116, 0.5);
            border-color: var(--accent);
            transform: scale(1.1);
        }
        
        .gallery-item-checkbox.checked {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border-color: var(--accent);
        }
        
        .gallery-item.selected {
            outline: 3px solid var(--accent);
            outline-offset: -3px;
        }
        
        /* Skeleton Loading Animation */
        .skeleton {
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .skeleton-shimmer {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        /* Actions unten */
        .gallery-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
        }
        
        .gallery-item-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 6px;
            background: transparent;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            border: 0;
            border-radius: 7px;
            color: rgba(255,255,255,0.88);
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: color 0.15s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }
        
        .gallery-item-btn:hover {
            color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .gallery-item-btn .btn-label {
            font-size: 9px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            opacity: 0.95;
        }

        .gallery-item-btn .btn-count {
            font-size: 10px;
            font-variant-numeric: tabular-nums;
            opacity: 0.95;
        }
        
        .gallery-item-like.active {
            background: transparent;
            border-color: transparent;
            color: #ff6b6b;
        }
        
        .gallery-item-like.active:hover {
            background: transparent;
            color: #ff6b6b;
        }

        .gallery-item-badge-stack-left,
        .gallery-item-badge-stack-right {
            position: absolute;
            top: 8px;
            display: flex;
            gap: 6px;
            align-items: center;
            pointer-events: none;
            z-index: 6;
        }

        .gallery-item-badge-stack-left {
            left: 44px;
            max-width: calc(100% - 108px);
            flex-wrap: wrap;
        }

        .gallery-item-badge-stack-right {
            right: 8px;
        }
        
        /* Badges für Markierungen */
        .gallery-item-badge {
            position: static;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            background: transparent;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            box-shadow: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.65);
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.55));
            z-index: 5;
        }

        .gallery-item-badge.badge--reject { color: #ff3b30; }
        .gallery-item-badge.badge--review { color: #ffd60a; }
        .gallery-item-badge.badge--approve { color: #34c759; }
        .gallery-item-badge.badge--final { color: #bf5af2; }
        
        .selection-badge {
            position: static;
            padding: 2px 6px;
            background: transparent;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 1px 2px rgba(0,0,0,0.65);
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.55));
            box-shadow: none;
            z-index: 5;
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.3px;
        }

        .selection-badge.badge-tone-1 { color: #ff2d55; }
        .selection-badge.badge-tone-2 { color: #ff9500; }
        .selection-badge.badge-tone-3 { color: #0a84ff; }
        .selection-badge.badge-tone-4 { color: #30d158; }
        .selection-badge.badge-tone-5 { color: #ffd60a; }
        .selection-badge.badge-tone-6 { color: #bf5af2; }

        .rating-badge {
            position: static;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: #ffd60a;
            background: transparent;
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            box-shadow: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.65);
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.55));
            z-index: 5;
            white-space: nowrap;
            pointer-events: none;
        }

        .storage-warning {
            margin: 10px 0 0 0;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 59, 48, 0.35);
            background: rgba(255, 59, 48, 0.10);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .debug-panel {
            position: fixed;
            right: 12px;
            bottom: 12px;
            width: min(420px, calc(100vw - 24px));
            max-height: 50vh;
            overflow: auto;
            z-index: 2000;
            background: rgba(0,0,0,0.78);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 12px;
            padding: 10px 12px;
            color: rgba(255,255,255,0.9);
            font-size: 12px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .debug-panel h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.86);
        }

        .debug-panel .row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            padding: 4px 0;
            border-top: 1px dashed rgba(255,255,255,0.12);
        }

        .debug-panel .row:first-of-type { border-top: 0; }

        .debug-panel code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.9);
        }

        .debug-panel button {
            margin-top: 8px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
        }

        .debug-panel button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .lightbox-filmstrip {
            margin-top: 10px;
            max-width: 90vw;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 6px 0;
        }

        .lightbox-filmstrip-inner {
            display: flex;
            gap: 8px;
            padding: 0 2px;
            align-items: center;
        }

        .lightbox-thumb {
            width: 64px;
            height: 64px;
            flex: 0 0 auto;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.06);
            cursor: pointer;
            position: relative;
            transition: transform 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
        }

        .lightbox-thumb:hover {
            transform: translateY(-1px);
            border-color: rgba(212, 165, 116, 0.6);
        }

        .lightbox-thumb.active {
            border-color: var(--accent);
            box-shadow: 0 8px 18px rgba(212, 165, 116, 0.22);
        }

        .lightbox-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .culling-overlay,
        .compare-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1100;
            color: rgba(255,255,255,0.92);
        }

        .culling-overlay.active,
        .compare-overlay.active {
            display: flex;
        }

        .culling-overlay {
            flex-direction: column;
            padding: 18px 16px 14px;
            gap: 10px;
        }

        .culling-topbar {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .culling-title {
            font-weight: 800;
            letter-spacing: 0.02em;
        }

        .culling-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .culling-actions .gallery-chip-button {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.18);
            color: rgba(255,255,255,0.92);
        }

        .culling-actions .gallery-chip-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .culling-grid {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            display: grid;
            gap: 12px;
            align-items: center;
            flex: 1;
        }

        .culling-grid--one {
            grid-template-columns: 1fr;
        }

        .culling-grid--two {
            grid-template-columns: 1fr 1fr;
        }

        .culling-frame {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.04);
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 220px;
        }

        .culling-frame.is-selected {
            border-color: var(--accent);
            box-shadow: 0 14px 26px rgba(212, 165, 116, 0.18);
        }

        .culling-frame img {
            max-width: 100%;
            max-height: calc(100vh - 280px);
            object-fit: contain;
            display: block;
        }

        .compare-overlay {
            flex-direction: column;
            padding: 18px 16px;
            gap: 12px;
        }

        .compare-topbar {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .compare-grid {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            flex: 1;
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            align-items: stretch;
        }

        .compare-grid.compare-grid--3,
        .compare-grid.compare-grid--4 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .compare-card {
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.04);
            display: flex;
            flex-direction: column;
            min-height: 240px;
        }

        .compare-card img {
            width: 100%;
            height: 100%;
            max-height: calc(100vh - 280px);
            object-fit: contain;
            background: rgba(0,0,0,0.18);
        }

        .compare-meta {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.10);
            font-size: 12px;
        }

        .compare-meta .name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            opacity: 0.95;
        }

        @media (max-width: 920px) {
            .culling-grid--two {
                grid-template-columns: 1fr;
            }
            .compare-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 20px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 50%;
        }
        
        .lightbox-prev {
            left: 16px;
        }
        
        .lightbox-next {
            right: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }

        .no-results-message {
            text-align: center;
            color: var(--text-secondary);
            grid-column: 1 / -1;
            padding: 40px;
            font-size: 1.1em;
        }

        .gallery-card--highlighted {
            border: 2px solid var(--accent);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
        }
        
        .download-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        /* Lightbox Sidebar */
        .lightbox-sidebar {
            position: fixed;
            left: calc(-1 * var(--lightbox-sidebar-width));
            top: 0;
            width: var(--lightbox-sidebar-width);
            min-width: var(--lightbox-sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #2a2a2a 100%);
            border-right: 1px solid #333;
            padding: 12px;
            overflow-y: auto;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            box-shadow: 4px 0 24px rgba(0,0,0,0.3);
        }
        
        .lightbox-sidebar.open {
            left: 0;
        }
        
        .lightbox-sidebar h3 {
            font-size: 1em;
            margin-bottom: 12px;
            color: #e0e0e0;
            border-bottom: 1px solid var(--accent);
            padding-bottom: 6px;
            font-weight: 600;
        }
        
        .lightbox-sidebar h4 {
            font-size: 0.85em;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-weight: 600;
            margin-top: 12px;
        }
        
        .feedback-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .feedback-section:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        
        /* Rating Stars */
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .star {
            font-size: 18px;
            color: #444;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }
        
        .star:hover {
            transform: scale(1.2);
            color: #ffd700;
        }
        
        .star.active {
            color: #ffd700;
        }
        
        /* Flag Buttons */
        .flag-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .flag-btn {
            padding: 6px 8px;
            border: 2px solid;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(0,0,0,0.3);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        .flag-btn.red {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .flag-btn.red:hover,
        .flag-btn.red.active {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .flag-btn.yellow {
            border-color: #ffd93d;
            color: #ffd93d;
        }
        
        .flag-btn.yellow:hover,
        .flag-btn.yellow.active {
            background: rgba(255, 217, 61, 0.2);
            border-color: #ffd93d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 217, 61, 0.3);
        }
        
        .flag-btn.green {
            border-color: #6bcf7f;
            color: #6bcf7f;
        }
        
        .flag-btn.green:hover,
        .flag-btn.green.active {
            background: rgba(107, 207, 127, 0.2);
            border-color: #6bcf7f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 207, 127, 0.3);
        }
        
        .flag-btn.black {
            border-color: #888;
            color: #888;
        }
        
        .flag-btn.black:hover,
        .flag-btn.black.active {
            background: rgba(136, 136, 136, 0.2);
            border-color: #aaa;
            color: #aaa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(136, 136, 136, 0.3);
        }
        
        /* Comment Input */
        .comment-input {
            width: 100%;
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
            margin-bottom: 6px;
            transition: border-color 0.2s;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }
        
        /* Comment List */
        .comment-list {
            margin-top: 8px;
        }

        /* Lightbox Detail-Ansicht: Desktop ohne Sidebar-Aufklappen & ohne Seiten-Scroll */
        @media (min-width: 1100px) {
            :root {
                --lightbox-sidebar-width: 340px;
            }

            .lightbox.active {
                padding-left: var(--lightbox-sidebar-width);
            }

            #feedback-toggle-btn {
                display: none;
            }

            #lightbox-download-btn {
                display: none;
            }

            #sidebar-download-btn {
                margin-bottom: 10px;
            }

            .lightbox-sidebar {
                left: 0 !important;
                overflow: hidden;
                padding: 8px;
            }

            .lightbox-sidebar .sidebar-close-btn {
                display: none;
            }

            .lightbox-sidebar h3 {
                margin-bottom: 10px;
                font-size: 0.95em;
            }

            .lightbox-sidebar-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                align-content: start;
            }

            .feedback-section {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
            }

            .feedback-section + .feedback-section {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
            }

            .feedback-section--wide {
                grid-column: 1 / -1;
            }

            .lightbox-sidebar h4 {
                margin-top: 0;
                margin-bottom: 6px;
                font-size: 0.78em;
            }

            .rating-stars {
                margin-bottom: 4px;
            }

            .star {
                font-size: 15px;
            }

            .flag-buttons {
                gap: 5px;
            }

            .lightbox-sidebar .btn-primary,
            .lightbox-sidebar .btn-secondary,
            .lightbox-sidebar .gallery-item-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .lightbox-sidebar .flag-btn {
                padding: 5px 6px;
                font-size: 10px;
            }

            .comment-input {
                min-height: 34px;
                resize: none;
            }

            .comment-list {
                margin-top: 6px;
                max-height: 110px;
                overflow: auto;
            }

            .selection-row {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .selection-row .sidebar-input--mb {
                margin-bottom: 0;
                flex: 1;
                min-width: 0;
            }

            .selection-row button {
                white-space: nowrap;
                padding: 6px 10px;
                font-size: 12px;
            }

            #image-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4px 10px;
                font-size: 0.78em;
                line-height: 1.4;
            }

            #image-info > div {
                display: flex;
                gap: 6px;
                align-items: baseline;
                min-width: 0;
                white-space: nowrap;
            }

            #image-info strong {
                flex: 0 0 auto;
                color: rgba(255,255,255,0.75);
                font-weight: 600;
            }

            #image-info span {
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* Extra-kompakt bei weniger Höhe (Browser-Chrome, kleinere Fenster) */
        @media (min-width: 1100px) and (max-height: 900px) {
            :root {
                --lightbox-sidebar-width: 320px;
            }

            .comment-list { max-height: 90px; }
            .lightbox-sidebar-body { gap: 6px; }
            .lightbox-sidebar h3 { margin-bottom: 8px; }
        }
        
        .comment-item {
            background: #1a1a1a;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            border-left: 2px solid var(--accent);
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        
        .comment-text {
            color: #e0e0e0;
            font-size: 0.85em;
            line-height: 1.3;
            margin-bottom: 3px;
        }
        
        .comment-date {
            color: var(--text-secondary);
            font-size: 0.7em;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 165, 116, 0.4);
        }
        
        .btn-secondary {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #333;
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        /* Favorit Button in Lightbox */
        #favorite-btn {
            background: rgba(0,0,0,0.6) !important;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2) !important;
            color: #ffffff !important;
            padding: 6px 8px !important;
            font-size: 12px !important;
        }

        /* Utilities (ersetzt Inline-Styles, reduziert Linter-Warnungen) */
        .is-hidden { display: none; }
        .empty-center { text-align: center; color: var(--text-secondary); padding: 28px 0; }
        .empty-center-grid { text-align: center; color: var(--text-secondary); grid-column: 1 / -1; }
        .center-muted { text-align: center; color: var(--text-secondary); margin-bottom: 20px; }
        .error-text { color: #ff6b6b; margin-top: 10px; }

        .gallery-layout-row { display: flex; gap: 20px; }
        .gallery-main { flex: 1; display: flex; flex-direction: column; }
        .gallery-flex { flex: 1; }

        /* Desktop: keep gallery sidebar always visible (fixed), like Picdrop */
        @media (min-width: 769px) {
            .gallery-layout-row {
                display: block;
            }

            .gallery-sidebar {
                position: fixed;
                left: calc(50% - (var(--gallery-fixed-width) * 0.5));
                z-index: 260;
            }

            .gallery-main {
                margin-left: calc(var(--gallery-sidebar-w) + var(--gallery-layout-gap));
            }

            .gallery-sidebar.collapsed ~ .gallery-main {
                margin-left: calc(var(--gallery-sidebar-collapsed-w) + var(--gallery-layout-gap));
            }
        }

        .sidebar-section--flush { margin-top: 0; padding-top: 0; border-top: none; }
        .sidebar-input { width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px; }
        .sidebar-input--mb { margin-bottom: 12px; }
        .muted-small { color: var(--text-secondary); font-size: 0.75em; margin: 0; }

        .bulk-actions-buttons { display: flex; flex-direction: column; gap: 6px; }
        .bulk-flag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .bulk-flag-hint { margin: 8px 0 6px; }
        .btn-full { width: 100%; }
        .btn-compact { padding: 6px 12px; font-size: 12px; }
        .btn-compact-mt { margin-top: 6px; }
        .btn-clear { background: #444; border-color: #555; }
        .btn-center { justify-content: center; }

        .viewer-actions { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px; z-index: 10; }
        .sidebar-close-btn { position: absolute; top: 12px; left: 8px; background: rgba(212, 165, 116, 0.2); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); font-size: 12px; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .rating-muted { color: var(--text-secondary); font-size: 0.75em; margin-top: 4px; }
        .image-info { font-size: 0.8em; color: var(--text-secondary); line-height: 1.6; }

        .gallery-card-preview--centered { display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); color: var(--text-secondary); }
        .gallery-card-preview--ratio { padding-bottom: 65%; }
        .gallery-card-header-actions { display: flex; align-items: center; gap: 6px; }

        .selection-count { float: right; font-weight: 600; }
        .selection-tag { background: rgba(212, 165, 116, 0.3); color: #ffffff; padding: 4px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; display: inline-block; font-size: 0.8em; font-weight: 500; border: 1px solid rgba(212, 165, 116, 0.5); }

        .progress-title { margin-bottom: 10px; }
        .progress-bar { width: 200px; height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress-bar-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
        .progress-text { margin-top: 10px; font-size: 0.85em; color: var(--text-secondary); }

        /* Progress modal tweaks */
        #progress-modal .progress-bar {
            width: 100%;
            max-width: 520px;
            height: 6px;
            margin-top: 12px;
        }

        #progress-modal .progress-text {
            margin-top: 12px;
        }
        
        #favorite-btn.active {
            background: rgba(255, 107, 107, 0.8) !important;
            border-color: #ff6b6b !important;
            color: #ffffff !important;
        }
        
        #favorite-btn:hover {
            background: rgba(212, 165, 116, 0.8) !important;
            border-color: var(--accent) !important;
        }
        
        #favorite-btn.active:hover {
            background: rgba(255, 107, 107, 1) !important;
        }
        
        #favorite-text {
            color: #ffffff !important;
            font-size: 0.85em !important;
        }
        
        /* Current Selections in Lightbox */
        #current-selections {
            font-size: 0.8em !important;
            color: #e0e0e0 !important;
            margin-top: 8px !important;
        }
        
        #current-selections span {
            background: rgba(212, 165, 116, 0.3) !important;
            color: #ffffff !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            margin-right: 5px !important;
            margin-bottom: 5px !important;
            display: inline-block !important;
            font-size: 0.8em !important;
            font-weight: 500 !important;
            border: 1px solid rgba(212, 165, 116, 0.5) !important;
        }
        
        /* Gallery Sidebar (für Übersicht) */
        .gallery-sidebar {
            position: sticky;
            top: calc(var(--gallery-fixed-top) + var(--gallery-topbar-h) + 18px);
            align-self: flex-start;
            width: var(--gallery-sidebar-w);
            min-width: var(--gallery-sidebar-w);
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-right: 1px solid var(--border);
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - (var(--gallery-fixed-top) + var(--gallery-topbar-h) + 18px) - 18px - env(safe-area-inset-bottom, 0px));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            z-index: 60;
        }
        
        .gallery-sidebar.collapsed {
            width: var(--gallery-sidebar-collapsed-w);
            min-width: var(--gallery-sidebar-collapsed-w);
            padding: 12px 8px;
        }
        
        .gallery-sidebar.collapsed .sidebar-content {
            display: none;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 12px;
            left: 8px;
            background: rgba(212, 165, 116, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .sidebar-toggle:hover {
            background: rgba(212, 165, 116, 0.4);
            transform: scale(1.1);
        }
        
        .gallery-sidebar.collapsed .sidebar-toggle {
            left: 8px;
        }
        
        /* Clickable items */
        .clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clickable:hover {
            background: rgba(212, 165, 116, 0.2) !important;
            transform: translateX(2px);
        }
        
        .clickable.active {
            background: rgba(212, 165, 116, 0.3) !important;
            border-left-color: var(--accent) !important;
            border-left-width: 3px !important;
        }
        
        .sidebar-content h3 {
            font-size: 1em;
            margin-bottom: 12px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--accent);
            padding-bottom: 6px;
            padding-left: 42px;
            font-weight: 600;
        }
        
        .sidebar-content h4 {
            font-size: 0.85em;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-top: 12px;
        }
        
        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 4px;
            border-left: 2px solid var(--accent);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.75em;
        }
        
        .stat-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .sidebar-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .flag-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .flag-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .flag-badge {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .flag-badge.red {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .flag-badge.yellow {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
        }
        
        .flag-badge.green {
            background: rgba(107, 207, 127, 0.2);
            color: #6bcf7f;
        }
        
        .flag-badge.black {
            background: rgba(136, 136, 136, 0.2);
            color: var(--text-secondary);
        }
        
        .flag-count {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85em;
        }

        .rating-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
        }

        .rating-summary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            padding: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            border-left: 2px solid transparent;
            min-width: 0;
        }

        .rating-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 5px;
            border-radius: 999px;
            background: rgba(255, 214, 10, 0.12);
            color: #ffd60a;
            font-size: 11px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: 0.01em;
            white-space: nowrap;
        }

        .rating-count {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.82em;
            font-variant-numeric: tabular-nums;
        }

        @media (min-width: 1200px) {
            .rating-summary {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        .selections-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .selection-row-item {
            display: flex;
            align-items: stretch;
            gap: 6px;
        }

        .selection-row-item .selection-item {
            flex: 1;
            margin-bottom: 0;
        }

        .selection-row-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .selection-mini-btn {
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            line-height: 1;
            white-space: nowrap;
        }

        .selection-mini-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .selection-item {
            padding: 6px 8px;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 4px;
            border-left: 2px solid var(--accent);
            color: var(--text-primary);
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.3;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        
        .selection-item.clickable:hover {
            background: rgba(212, 165, 116, 0.2) !important;
            color: var(--text-primary) !important;
        }
        
        .selection-item.clickable.active {
            background: rgba(212, 165, 116, 0.5) !important;
            border-left-width: 3px !important;
            color: var(--text-primary) !important;
            font-weight: 600;
        }
        
        .selection-item span {
            color: var(--text-primary) !important;
            font-weight: 600;
        }
        
        @media (max-width: 1200px) {
            .gallery-sidebar {
                width: 180px;
                min-width: 180px;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header.site-header {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .logo {
                width: 72px;
                height: 72px;
            }
            
            .theme-toggle {
                padding: 6px 10px;
                font-size: 12px;
            }

            .header-inner {
                flex-direction: column;
                align-items: flex-start;
            }

            .hero-strip {
                grid-template-columns: 1fr;
            }

            .hero-stats {
                grid-template-columns: 1fr;
            }

            .category-sidebar {
                position: static;
                max-height: none;
                width: 100%;
                min-width: 0;
            }

            .main-content-with-sidebar {
                flex-direction: column;
                gap: 14px;
            }
            
            .gallery-selector {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
            }
            
            .gallery-card-preview {
                height: 140px;
            }
            
            .gallery-card-content {
                padding: 12px;
            }
            
            .gallery-card h3 {
                font-size: 0.95em;
            }
            
            .gallery-card p {
                font-size: 0.75em;
            }
            
            .gallery-card .image-count {
                font-size: 0.75em;
            }
            
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .gallery-item {
                border-radius: 8px;
            }
            
            .lightbox-nav {
                padding: 12px;
                font-size: 18px;
            }
            
            .lightbox-prev {
                left: 10px;
            }
            
            .lightbox-next {
                right: 10px;
            }
            
            .logo-container {
                flex-direction: column;
                gap: 10px;
            }

            .gallery-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .gallery-header-left {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .gallery-sidebar {
                position: fixed;
                left: -200px;
                top: 0;
                height: 100vh;
                z-index: 999;
                max-height: 100vh;
                width: 200px;
            }
            
            .gallery-sidebar.open {
                left: 0;
            }
            
            #gallery-container > div {
                flex-direction: column;
            }
            
            .breadcrumb {
                font-size: 0.8em;
                padding: 10px 0;
            }
            
            .lightbox-sidebar {
                width: 100%;
                max-width: 100%;
            }
            
            .lightbox-content {
                max-width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
            
            .gallery-selector {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }
            
            .gallery-card {
                aspect-ratio: 1 / 1.25;
            }
            
            .gallery-card-content {
                padding: 8px;
            }
            
            .gallery-card h3 {
                font-size: 0.8em;
            }
            
            .gallery-card p {
                font-size: 0.65em;
                margin-bottom: 6px;
            }
            
            .gallery-card-footer {
                padding-top: 6px;
            }
            
            .gallery-card .image-count {
                font-size: 0.65em;
            }
        }
        
        /* Touch Gestures für Mobile */
        @media (hover: none) and (pointer: coarse) {
            .gallery-item-overlay {
                opacity: 1;
                pointer-events: all;
            }
            
            .gallery-item-btn {
                padding: 4px 6px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="site-header">
            <div class="header-inner">
                <div class="brand">
                    <img src="./logo.png" alt="WB Foto Manager Logo" class="logo">
                    <div class="brand-text">
                        <h1>WB Foto Manager</h1>
                        <p>Professionelle Kunden-Galerie</p>
                    </div>
                </div>
                <div class="header-actions">
                    <a class="admin-link" href="admin.html">Admin</a>
                    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle" title="Dark/Light Mode wechseln">
                        <span id="theme-label">Dunkel</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Galerie-Auswahl (wird angezeigt wenn mehrere Galerien vorhanden) -->
        <div id="gallery-selector" class="is-hidden">
            <div class="selector-top">
                <!-- Kategorie-Sidebar -->
                <div class="category-sidebar" id="category-sidebar">
                    <h3>Kategorien</h3>
                    <div id="category-buttons"></div>
                </div>

                <!-- Portfolio rechts neben Sidebar -->
                <div class="portfolio-area">
                    <div class="portfolio-slider-wrapper is-hidden" id="portfolio-slider-wrapper">
                        <!-- Slider 1 -->
                        <div class="portfolio-slider" id="portfolio-slider-1">
                            <div class="portfolio-slider-container" id="portfolio-slider-container-1"></div>
                            <button class="portfolio-nav prev" onclick="portfolioPrev(1)">‹</button>
                            <button class="portfolio-nav next" onclick="portfolioNext(1)">›</button>
                            <div class="portfolio-dots" id="portfolio-dots-1"></div>
                        </div>
                        <!-- Slider 2 -->
                        <div class="portfolio-slider" id="portfolio-slider-2">
                            <div class="portfolio-slider-container" id="portfolio-slider-container-2"></div>
                            <button class="portfolio-nav prev" onclick="portfolioPrev(2)">‹</button>
                            <button class="portfolio-nav next" onclick="portfolioNext(2)">›</button>
                            <div class="portfolio-dots" id="portfolio-dots-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="galleries-area">
                <div class="gallery-toolbar">
                    <div class="gallery-search">
                        <input type="search" id="gallery-search-input" placeholder="Galerien durchsuchen…" autocomplete="off">
                    </div>
                </div>
                <div id="gallery-list"></div>

                <!-- Call-to-Action Bereich -->
                <div class="cta-section is-hidden" id="cta-section">
                    <h2>Bereit für dein Shooting?</h2>
                    <p>Buche jetzt einen Termin oder kontaktiere mich für eine individuelle Beratung. Ich freue mich auf deine Anfrage!</p>
                    <div class="cta-buttons">
                        <a href="mailto:w.blaurock80@outlook.com?subject=Shooting-Anfrage" class="cta-button primary">Termin anfragen</a>
                        <a href="tel:+41797514357" class="cta-button secondary">Jetzt anrufen</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Passwort-Formular -->
        <div id="password-form" class="password-form is-hidden">
            <h2>Passwort erforderlich</h2>
            <p class="center-muted" id="gallery-name-display"></p>
            <input type="password" id="password-input" placeholder="Passwort eingeben" autofocus>
            <button onclick="checkPassword()">Anmelden</button>
            <p id="password-error" class="error-text is-hidden">Falsches Passwort</p>
        </div>
        
        <!-- Galerie-Ansicht -->
        <div id="gallery-container" class="is-hidden">
            <div class="gallery-header">
                <div class="gallery-header-left">
                    <button class="back-button is-hidden" onclick="showGallerySelector()" id="back-button">
                        ← Zurück
                    </button>
                    <div class="gallery-title">
                        <h2 id="gallery-title">Galerie</h2>
                        <p id="gallery-subtitle">–</p>
                    </div>
                </div>
                <div class="gallery-header-actions">
                    <span class="gallery-chip" id="gallery-count-chip">– Bilder</span>
                    <span class="gallery-chip" id="gallery-visible-chip">– sichtbar</span>
                    <span class="gallery-chip" id="gallery-filter-chip">Alle</span>
                    <span class="gallery-chip" id="gallery-selected-chip">0 ausgewählt</span>
                    <select id="sort-select" class="gallery-sort-select" title="Sortierung">
                        <option value="default">Sort: Standard</option>
                        <option value="date_desc">Sort: Datum ↓</option>
                        <option value="date_asc">Sort: Datum ↑</option>
                        <option value="name_asc">Sort: Name A→Z</option>
                        <option value="name_desc">Sort: Name Z→A</option>
                        <option value="rating_desc">Sort: Rating ↓</option>
                        <option value="rating_asc">Sort: Rating ↑</option>
                        <option value="flag_desc">Sort: Flag (Final→…)</option>
                        <option value="flag_asc">Sort: Flag (…→Final)</option>
                    </select>
                    <button type="button" class="gallery-chip-button" id="culling-toggle-btn" title="Culling Mode (C)">Culling</button>
                    <button type="button" class="gallery-chip-button" id="shortcuts-help-btn" title="Shortcuts anzeigen (?)">? Hilfe</button>
                </div>
            </div>

            <!-- Quick Filters (Picdrop-inspiriert) -->
            <div class="quick-filters" id="quick-filters" aria-label="Schnellfilter">
                <button type="button" class="quick-filter-chip" data-filter-type="all">Alle</button>
                <button type="button" class="quick-filter-chip" data-filter-type="selected">Ausgewählt</button>
                <button type="button" class="quick-filter-chip" data-filter-type="favorites">Favoriten</button>
                <button type="button" class="quick-filter-chip" data-filter-type="commented">Kommentare</button>
                <button type="button" class="quick-filter-chip" data-filter-type="rated" data-filter-rating="5">5★</button>
                <button type="button" class="quick-filter-chip" data-filter-rating="4">4★</button>
                <button type="button" class="quick-filter-chip" data-filter-rating="3">3★</button>
                <button type="button" class="quick-filter-chip" data-filter-rating="2">2★</button>
                <button type="button" class="quick-filter-chip" data-filter-rating="1">1★</button>
                <span class="quick-filter-sep" aria-hidden="true"></span>
                <button type="button" class="quick-filter-chip" data-filter-flag="reject">✗ Reject</button>
                <button type="button" class="quick-filter-chip" data-filter-flag="review">! Review</button>
                <button type="button" class="quick-filter-chip" data-filter-flag="approve">✓ Approve</button>
                <button type="button" class="quick-filter-chip" data-filter-flag="final">★ Final</button>
            </div>
            <div class="gallery-layout-row">
                <!-- Sidebar für Galerie-Übersicht -->
                <div class="gallery-sidebar" id="gallery-sidebar">
                    <button class="sidebar-toggle" onclick="toggleGallerySidebar()" id="sidebar-toggle-btn">
                        <span id="sidebar-toggle-icon">▶</span>
                    </button>
                    <div class="sidebar-content" id="sidebar-content">
                        <h3>Übersicht</h3>
                        
                        <!-- Suche -->
                        <div class="sidebar-section sidebar-section--flush">
                            <input type="text" id="search-input" placeholder="Suchen..." class="sidebar-input sidebar-input--mb">
                        </div>
                        
                        <div class="sidebar-stats">
                            <div class="stat-item clickable" onclick="filterByType('all')" title="Alle Bilder anzeigen">
                                <span class="stat-label">Gesamt:</span>
                                <span class="stat-value" id="stat-total">0</span>
                            </div>
                            <div class="stat-item clickable" onclick="filterByType('selected')" title="Nur ausgewählte Bilder">
                                <span class="stat-label">Ausgewählt:</span>
                                <span class="stat-value" id="stat-selected">0</span>
                            </div>
                            <div class="stat-item clickable" onclick="filterByType('favorites')" title="Nur Favoriten">
                                <span class="stat-label">Favoriten:</span>
                                <span class="stat-value" id="stat-favorites">0</span>
                            </div>
                            <div class="stat-item clickable" onclick="filterByType('commented')" title="Nur kommentierte Bilder">
                                <span class="stat-label">Kommentiert:</span>
                                <span class="stat-value" id="stat-commented">0</span>
                            </div>
                            <div class="stat-item clickable" onclick="filterByType('rated')" title="Nur bewertete Bilder">
                                <span class="stat-label">Bewertet:</span>
                                <span class="stat-value" id="stat-rated">0</span>
                            </div>
                        </div>
                        
                        <div class="sidebar-section">
                            <h4>Markierungen</h4>
                            <div class="flag-summary" id="flag-summary">
                                <div class="flag-summary-item clickable" onclick="filterByFlag('reject')" title="Nur abgelehnte Bilder">
                                    <span class="flag-badge red">✗</span>
                                    <span class="flag-count" id="flag-reject">0</span>
                                </div>
                                <div class="flag-summary-item clickable" onclick="filterByFlag('review')" title="Nur zu prüfende Bilder">
                                    <span class="flag-badge yellow">!</span>
                                    <span class="flag-count" id="flag-review">0</span>
                                </div>
                                <div class="flag-summary-item clickable" onclick="filterByFlag('approve')" title="Nur genehmigte Bilder">
                                    <span class="flag-badge green">✓</span>
                                    <span class="flag-count" id="flag-approve">0</span>
                                </div>
                                <div class="flag-summary-item clickable" onclick="filterByFlag('final')" title="Nur finale Bilder">
                                    <span class="flag-badge black">★</span>
                                    <span class="flag-count" id="flag-final">0</span>
                                </div>
                            </div>

                            <div class="rating-summary" id="rating-summary" aria-label="Bewertungsübersicht">
                                <div class="rating-summary-item clickable" data-rating="5" onclick="filterByRating(5)" title="Nur 5 Sterne">
                                    <span class="rating-pill">5★</span>
                                    <span class="rating-count" id="rating-count-5">0</span>
                                </div>
                                <div class="rating-summary-item clickable" data-rating="4" onclick="filterByRating(4)" title="Nur 4 Sterne">
                                    <span class="rating-pill">4★</span>
                                    <span class="rating-count" id="rating-count-4">0</span>
                                </div>
                                <div class="rating-summary-item clickable" data-rating="3" onclick="filterByRating(3)" title="Nur 3 Sterne">
                                    <span class="rating-pill">3★</span>
                                    <span class="rating-count" id="rating-count-3">0</span>
                                </div>
                                <div class="rating-summary-item clickable" data-rating="2" onclick="filterByRating(2)" title="Nur 2 Sterne">
                                    <span class="rating-pill">2★</span>
                                    <span class="rating-count" id="rating-count-2">0</span>
                                </div>
                                <div class="rating-summary-item clickable" data-rating="1" onclick="filterByRating(1)" title="Nur 1 Stern">
                                    <span class="rating-pill">1★</span>
                                    <span class="rating-count" id="rating-count-1">0</span>
                                </div>
                            </div>

                            <div class="bulk-flag-controls">
                                <p class="muted-small bulk-flag-hint">Für Auswahl:</p>
                                <div class="flag-buttons" aria-label="Markierung für Auswahl setzen">
                                    <button class="flag-btn red" type="button" data-bulk-flag="reject" title="Auswahl ablehnen">Ablehnen</button>
                                    <button class="flag-btn yellow" type="button" data-bulk-flag="review" title="Auswahl prüfen">Prüfen</button>
                                    <button class="flag-btn green" type="button" data-bulk-flag="approve" title="Auswahl genehmigen">Genehmigen</button>
                                    <button class="flag-btn black" type="button" data-bulk-flag="final" title="Auswahl final">Final</button>
                                </div>

                                <button id="clear-flags-btn" class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-flag" data-bulk-scope="selected" disabled title="Entfernt Markierungen von allen ausgewählten Bildern">
                                    Markierungen entfernen (Auswahl)
                                </button>
                                <button class="btn-secondary btn-full btn-compact btn-compact-mt" type="button" data-bulk-action="clear-flag" data-bulk-scope="visible" title="Entfernt Markierungen von allen aktuell sichtbaren Bildern (Filter/Suche)">
                                    Markierungen entfernen (sichtbar)
                                </button>
                                <button class="btn-secondary btn-full btn-compact btn-compact-mt" type="button" data-bulk-action="clear-flag" data-bulk-scope="gallery" title="Entfernt Markierungen von allen Bildern in dieser Galerie (irreversibel)">
                                    Markierungen entfernen (gesamte Galerie)
                                </button>
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <h4>Zurücksetzen</h4>
                            <p class="muted-small bulk-flag-hint">Diese Aktionen betreffen die gesamte Galerie.</p>
                            <div class="bulk-actions-buttons">
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-favorites" data-bulk-scope="gallery" title="Entfernt Favoriten-Markierungen von allen Bildern dieser Galerie">
                                    Favoriten entfernen (gesamte Galerie)
                                </button>
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-ratings" data-bulk-scope="gallery" title="Entfernt Bewertungen von allen Bildern dieser Galerie">
                                    Bewertungen entfernen (gesamte Galerie)
                                </button>
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-comments" data-bulk-scope="gallery" title="Entfernt Kommentare von allen Bildern dieser Galerie">
                                    Kommentare entfernen (gesamte Galerie)
                                </button>
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-selections" data-bulk-scope="gallery" title="Entfernt Auswahlen-Zuordnungen von allen Bildern dieser Galerie">
                                    Auswahlen entfernen (gesamte Galerie)
                                </button>
                                <button class="btn-primary btn-full btn-compact btn-compact-mt" type="button" data-bulk-action="reset-feedback" data-bulk-scope="gallery" title="Entfernt Markierungen, Favoriten, Bewertungen, Kommentare und Auswahlen für diese Galerie">
                                    Alles Feedback löschen (gesamte Galerie)
                                </button>
                            </div>
                        </div>
                        
                        <div class="sidebar-section">
                            <h4>Auswahlen</h4>
                            <div class="selections-list" id="selections-list">
                                <p class="muted-small">Keine Auswahlen</p>
                            </div>
                        </div>
                        
                        <!-- Bulk-Aktionen -->
                        <div class="sidebar-section is-hidden" id="bulk-actions-section">
                            <h4>Bulk-Aktionen</h4>
                            <div class="bulk-actions-buttons">
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="favorites">Als Favoriten markieren</button>
                                <div class="bulk-flag-grid" aria-label="Markierungen für Auswahl">
                                    <button class="flag-btn red" type="button" data-bulk-flag="reject" title="Auswahl ablehnen">Ablehnen</button>
                                    <button class="flag-btn yellow" type="button" data-bulk-flag="review" title="Auswahl prüfen">Prüfen</button>
                                    <button class="flag-btn green" type="button" data-bulk-flag="approve" title="Auswahl genehmigen">Genehmigen</button>
                                    <button class="flag-btn black" type="button" data-bulk-flag="final" title="Auswahl final">Final</button>
                                </div>
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="clear-flag" data-bulk-scope="selected">Markierungen entfernen (Auswahl)</button>
                                <button class="btn-secondary btn-full btn-compact" type="button" data-bulk-action="add-selection">Zu Auswahl hinzufügen</button>
                                <button class="btn-primary btn-full btn-compact" type="button" data-bulk-action="download">Als ZIP herunterladen</button>
                                <button class="btn-secondary btn-full btn-compact btn-compact-mt" type="button" data-bulk-action="export-pdf">Als PDF exportieren</button>
                                <button class="btn-secondary btn-full btn-compact btn-clear" type="button" data-bulk-action="clear-selection">✗ Auswahl aufheben</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="gallery-main">
                    <!-- Breadcrumb -->
                    <div class="breadcrumb is-hidden" id="breadcrumb"></div>
                    <div class="gallery gallery-flex" id="gallery"></div>
                </div>
            </div>

            <!-- Bottom Selection Bar (immer griffbereit) -->
            <div class="selection-bar is-hidden" id="selection-bar" aria-live="polite" aria-atomic="true">
                <div class="selection-bar-inner">
                    <div class="selection-bar-left">
                        <span class="selection-bar-count" id="selection-bar-count">0 ausgewählt</span>
                        <span class="selection-bar-hint">Download / Export / Reset – plus Favorit & Auswahl</span>
                    </div>
                    <div class="selection-bar-actions">
                        <button class="btn-secondary btn-compact is-hidden" type="button" id="selection-bar-undo" title="Letzte Auswahl wiederherstellen">Undo</button>
                        <button class="btn-secondary btn-compact" type="button" id="selection-bar-reset">Reset</button>
                        <button class="btn-secondary btn-compact" type="button" id="selection-bar-favorite">Favorit</button>
                        <button class="btn-secondary btn-compact" type="button" id="selection-bar-add-selection">Zu Auswahl</button>
                        <button class="btn-secondary btn-compact" type="button" id="selection-bar-export">Export</button>
                        <button class="btn-secondary btn-compact" type="button" id="selection-bar-compare">Compare</button>
                        <button class="btn-primary btn-compact" type="button" id="selection-bar-download">Download</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading is-hidden">
            <p>Lade Bilder...</p>
        </div>
        
        <div id="error" class="error is-hidden">
            <p>Fehler beim Laden der Bilder</p>
        </div>
    </div>
    
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-nav lightbox-prev" onclick="previousImage()">‹</button>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="">
            <div class="viewer-actions">
                <button class="download-btn" id="lightbox-download-btn" onclick="downloadImage()">Download</button>
                <button class="download-btn" onclick="toggleSidebar()" id="feedback-toggle-btn">Feedback</button>
            </div>

            <div class="lightbox-filmstrip" id="lightbox-filmstrip" aria-label="Filmstrip">
                <div class="lightbox-filmstrip-inner" id="lightbox-filmstrip-inner"></div>
            </div>
        </div>
        <button class="lightbox-nav lightbox-next" onclick="nextImage()">›</button>
        
        <!-- Feedback-Sidebar -->
        <div class="lightbox-sidebar" id="feedback-sidebar">
            <button onclick="toggleSidebar()" class="sidebar-close-btn">&times;</button>
            <h3 id="feedback-image-name">Bild Feedback</h3>

            <button class="btn-primary btn-full" id="sidebar-download-btn" type="button" onclick="downloadImage()">Download</button>

            <div class="lightbox-sidebar-body">
                <!-- Bewertung -->
                <div class="feedback-section">
                    <h4>Bewertung</h4>
                    <div class="rating-stars" id="rating-stars">
                        <span class="star" data-rating="1" onclick="setRating(1)">★</span>
                        <span class="star" data-rating="2" onclick="setRating(2)">★</span>
                        <span class="star" data-rating="3" onclick="setRating(3)">★</span>
                        <span class="star" data-rating="4" onclick="setRating(4)">★</span>
                        <span class="star" data-rating="5" onclick="setRating(5)">★</span>
                    </div>
                    <p id="rating-text" class="rating-muted">Keine Bewertung</p>
                    <button class="btn-secondary btn-full btn-compact" onclick="setRating(0)">Bewertung entfernen</button>
                </div>

                <!-- Markierungen (Flags) -->
                <div class="feedback-section">
                    <h4>Markierung</h4>
                    <div class="flag-buttons">
                        <button class="flag-btn red" data-flag="reject" title="Ablehnen" onclick="setFlag('reject')">Ablehnen</button>
                        <button class="flag-btn yellow" data-flag="review" title="Prüfen" onclick="setFlag('review')">Prüfen</button>
                        <button class="flag-btn green" data-flag="approve" title="Genehmigen" onclick="setFlag('approve')">Genehmigen</button>
                        <button class="flag-btn black" data-flag="final" title="Final" onclick="setFlag('final')">Final</button>
                    </div>
                    <button class="btn-secondary btn-full btn-compact" onclick="clearFlag()">Markierung entfernen</button>
                </div>

                <!-- Favorit -->
                <div class="feedback-section">
                    <h4>Favorit</h4>
                    <button class="gallery-item-btn gallery-item-like btn-full btn-center" id="favorite-btn" onclick="toggleFavorite()">
                        <span id="favorite-text">Als Favorit markieren</span>
                    </button>
                </div>

                <!-- Kommentare -->
                <div class="feedback-section feedback-section--wide">
                    <h4>Kommentare</h4>
                    <textarea class="comment-input" id="comment-input" placeholder="Ihr Kommentar..."></textarea>
                    <button class="btn-primary btn-full" onclick="addComment()">Kommentar hinzufügen</button>
                    <div class="comment-list" id="comment-list"></div>
                </div>

                <!-- Auswahl -->
                <div class="feedback-section feedback-section--wide">
                    <h4>Auswahl</h4>
                    <div class="selection-row">
                        <input type="text" id="selection-name" placeholder="Auswahl-Name" class="sidebar-input sidebar-input--mb">
                        <button class="btn-secondary" onclick="addToSelection()">Hinzufügen</button>
                    </div>
                    <div id="current-selections"></div>
                </div>

                <!-- Bild-Info -->
                <div class="feedback-section feedback-section--wide">
                    <h4>Bild-Informationen</h4>
                    <div id="image-info" class="image-info">
                        <div><strong>Name:</strong> <span id="info-name">-</span></div>
                        <div><strong>Größe:</strong> <span id="info-size">-</span></div>
                        <div><strong>Auflösung:</strong> <span id="info-resolution">-</span></div>
                        <div><strong>Upload:</strong> <span id="info-upload">-</span></div>
                        <div><strong>Quelle:</strong> <span id="info-source">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Culling Mode (Picdrop-inspiriert) -->
    <div class="culling-overlay" id="culling-overlay" role="dialog" aria-modal="true" aria-label="Culling Mode">
        <button class="lightbox-close" type="button" id="culling-close" aria-label="Schließen">&times;</button>
        <div class="culling-topbar">
            <div class="culling-title" id="culling-title">Culling</div>
            <div class="culling-actions">
                <button type="button" class="gallery-chip-button" id="culling-layout-btn" title="Layout wechseln">2-up</button>
                <button type="button" class="gallery-chip-button" id="culling-open-lightbox-btn" title="Im Lightbox öffnen">Lightbox</button>
            </div>
        </div>
        <div class="culling-grid culling-grid--two" id="culling-grid">
            <div class="culling-frame" data-slot="0"><img id="culling-image-0" alt=""></div>
            <div class="culling-frame" data-slot="1"><img id="culling-image-1" alt=""></div>
        </div>
        <div class="lightbox-filmstrip" id="culling-filmstrip" aria-label="Filmstrip">
            <div class="lightbox-filmstrip-inner" id="culling-filmstrip-inner"></div>
        </div>
    </div>

    <!-- Compare View (2–4 Bilder) -->
    <div class="compare-overlay" id="compare-overlay" role="dialog" aria-modal="true" aria-label="Vergleich">
        <button class="lightbox-close" type="button" id="compare-close" aria-label="Schließen">&times;</button>
        <div class="compare-topbar">
            <div class="culling-title" id="compare-title">Vergleich</div>
            <div class="culling-actions">
                <button type="button" class="gallery-chip-button" id="compare-open-lightbox-btn" title="Erstes Bild im Lightbox öffnen">Lightbox</button>
            </div>
        </div>
        <div class="compare-grid" id="compare-grid"></div>
    </div>

    <!-- Toasts (Micro-Feedback) -->
    <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Confirm Modal (non-blocking window.confirm replacement) -->
    <div class="modal-backdrop is-hidden" id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-modal-title" aria-describedby="confirm-modal-message">
        <div class="modal" role="document">
            <div class="modal-header">
                <div class="modal-title" id="confirm-modal-title">Bestätigen</div>
                <button type="button" class="modal-close" id="confirm-modal-close" aria-label="Schließen">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="confirm-modal-message"></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="confirm-modal-cancel">Abbrechen</button>
                <button type="button" class="btn-primary" id="confirm-modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Shortcuts Help Modal -->
    <div class="modal-backdrop is-hidden" id="shortcuts-modal" role="dialog" aria-modal="true" aria-labelledby="shortcuts-modal-title">
        <div class="modal" role="document">
            <div class="modal-header">
                <div class="modal-title" id="shortcuts-modal-title">Shortcuts</div>
                <button type="button" class="modal-close" id="shortcuts-modal-close" aria-label="Schließen">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-message">Toggle: <kbd>?</kbd> (Shift + /). Schließen: <kbd>Esc</kbd>.</p>

                <div class="shortcuts-grid">
                    <div class="shortcuts-section">
                        <h4>Navigation</h4>
                        <div class="shortcut-row"><kbd>Esc</kbd><span>Lightbox schließen / Auswahl aufheben</span></div>
                        <div class="shortcut-row"><kbd>←</kbd><span>Vorheriges Bild (Lightbox)</span></div>
                        <div class="shortcut-row"><kbd>→</kbd><span>Nächstes Bild (Lightbox)</span></div>
                        <div class="shortcut-row"><kbd>C</kbd><span>Culling Mode (Galerie)</span></div>
                        <div class="shortcut-row"><kbd>V</kbd><span>Compare View (2–4 ausgewählt)</span></div>
                    </div>

                    <div class="shortcuts-section">
                        <h4>Auswahl</h4>
                        <div class="shortcut-row"><kbd>Shift</kbd> + Click<span>Range-Select (zwischen zwei Bildern)</span></div>
                        <div class="shortcut-row"><kbd>Cmd/Ctrl</kbd> + <kbd>A</kbd><span>Alle sichtbaren auswählen</span></div>
                        <div class="shortcut-row"><kbd>Space</kbd><span>Aktuelles Bild auswählen (Lightbox)</span></div>
                        <div class="shortcut-row"><kbd>U</kbd><span>Undo (zuletzt aufgehobene Auswahl)</span></div>
                    </div>

                    <div class="shortcuts-section">
                        <h4>Aktionen</h4>
                        <div class="shortcut-row"><kbd>D</kbd><span>Download als ZIP</span></div>
                        <div class="shortcut-row"><kbd>E</kbd><span>Export (JSON Liste)</span></div>
                        <div class="shortcut-row"><kbd>F</kbd><span>Favorit togglen (Lightbox) / Favorit setzen (Bulk)</span></div>
                        <div class="shortcut-row"><kbd>S</kbd><span>Zu Auswahl hinzufügen (Bulk)</span></div>
                        <div class="shortcut-row"><kbd>1</kbd>.. <kbd>5</kbd><span>Rating setzen (Lightbox/Culling)</span></div>
                        <div class="shortcut-row"><kbd>R</kbd> / <kbd>X</kbd><span>Reject togglen (Lightbox/Culling)</span></div>
                    </div>

                    <div class="shortcuts-section">
                        <h4>Filter</h4>
                        <div class="shortcut-row"><kbd>Shift</kbd> + <kbd>1</kbd>.. <kbd>5</kbd><span>Rating-Filter</span></div>
                        <div class="shortcut-row"><kbd>Shift</kbd> + <kbd>0</kbd><span>Zurück zu Alle</span></div>
                        <div class="shortcut-row"><kbd>Alt/Option</kbd> + <kbd>1</kbd>.. <kbd>4</kbd><span>Flag-Filter (reject/review/approve/final)</span></div>
                        <div class="shortcut-row"><kbd>Alt/Option</kbd> + <kbd>0</kbd><span>Zurück zu Alle</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Modal (non-blocking window.prompt replacement) -->
    <div class="modal-backdrop is-hidden" id="prompt-modal" role="dialog" aria-modal="true" aria-labelledby="prompt-modal-title" aria-describedby="prompt-modal-message">
        <div class="modal" role="document">
            <div class="modal-header">
                <div class="modal-title" id="prompt-modal-title">Eingabe</div>
                <button type="button" class="modal-close" id="prompt-modal-close" aria-label="Schließen">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="prompt-modal-message"></p>
                <input type="text" class="sidebar-input" id="prompt-modal-input" autocomplete="off" spellcheck="false">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="prompt-modal-cancel">Abbrechen</button>
                <button type="button" class="btn-primary" id="prompt-modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Progress Modal (Download/ZIP progress) -->
    <div class="modal-backdrop is-hidden" id="progress-modal" role="dialog" aria-modal="true" aria-labelledby="progress-modal-title" aria-describedby="progress-modal-message">
        <div class="modal" role="document">
            <div class="modal-header">
                <div class="modal-title" id="progress-modal-title">Download</div>
                <button type="button" class="modal-close" id="progress-modal-close" aria-label="Schließen">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="progress-modal-message">–</p>
                <div class="progress-bar" aria-hidden="true"><div id="progress-modal-bar" class="progress-bar-fill"></div></div>
                <p id="progress-modal-text" class="progress-text">0%</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="progress-modal-cancel">Abbrechen</button>
                <button type="button" class="btn-primary is-hidden" id="progress-modal-ok">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        // Konfiguration
        let galleryConfig = null;
        let currentGallery = null;

        const FEEDBACK_STORAGE_KEY = 'gallery_feedback';
        const FEEDBACK_META_KEY = 'gallery_feedback_meta';
        window.__wbfmDebug = { lastSave: null, lastLoad: null, lastImageId: null };
        let currentImagesOriginal = [];
        let currentImages = [];
        let currentSortKey = 'default';
        let selectedImageIds = new Set();
        let currentImageIndex = 0;
        let searchQuery = '';
        let selectedCategory = 'all';
        let gallerySearchQuery = '';
        let portfolioCurrentSlide = { 1: 0, 2: 0 };
        let portfolioInterval = { 1: null, 2: null };
        
        // Feedback-Daten (wird in localStorage gespeichert)
        let feedbackData = {
            ratings: {},      // { imageId: rating (1-5) }
            flags: {},        // { imageId: 'reject'|'review'|'approve'|'final' }
            favorites: {},    // { imageId: true }
            comments: {},    // { imageId: [{ author, text, date }] }
            selections: {}    // { imageId: ['selection1', 'selection2'] }
        };

        function normalizeFeedbackData(data) {
            const normalized = {
                ratings: {},
                flags: {},
                favorites: {},
                comments: {},
                selections: {}
            };

            if (!data || typeof data !== 'object') return normalized;

            if (data.ratings && typeof data.ratings === 'object') {
                Object.entries(data.ratings).forEach(([key, value]) => {
                    const num = Number(value);
                    if (Number.isFinite(num)) {
                        normalized.ratings[key] = Math.max(0, Math.min(5, Math.round(num)));
                    }
                });
            }

            if (data.flags && typeof data.flags === 'object') {
                Object.entries(data.flags).forEach(([key, value]) => {
                    if (typeof value === 'string' && value) normalized.flags[key] = value;
                });
            }

            if (data.favorites && typeof data.favorites === 'object') {
                Object.entries(data.favorites).forEach(([key, value]) => {
                    if (value) normalized.favorites[key] = true;
                });
            }

            if (data.comments && typeof data.comments === 'object') {
                Object.entries(data.comments).forEach(([key, value]) => {
                    if (Array.isArray(value)) normalized.comments[key] = value;
                });
            }

            if (data.selections && typeof data.selections === 'object') {
                Object.entries(data.selections).forEach(([key, value]) => {
                    if (Array.isArray(value)) normalized.selections[key] = value;
                });
            }

            return normalized;
        }

        function normalizeUrlForId(url) {
            if (!url) return '';
            try {
                const u = new URL(url, window.location.href);
                u.search = '';
                u.hash = '';
                return u.toString();
            } catch {
                return String(url).split('#')[0].split('?')[0];
            }
        }

        function getFeedbackImageId(image, index) {
            const stableIndex = Number.isFinite(Number(image?.__wbfmOriginalIndex))
                ? Number(image.__wbfmOriginalIndex)
                : Number(index);
            const normalizedUrl = normalizeUrlForId(image?.url);
            const base =
                image?.publicId ||
                image?.id ||
                image?.name ||
                normalizedUrl ||
                `img_${stableIndex}`;
            const galleryPrefix = currentGallery?.id ? `${currentGallery.id}::` : '';
            return `${galleryPrefix}${base}`;
        }

        function findImageIndexByFeedbackId(imageId) {
            return currentImages.findIndex((img, idx) => getFeedbackImageId(img, idx) === imageId);
        }

        function migrateLegacyFeedbackIds(images) {
            const buckets = ['ratings', 'flags', 'favorites', 'comments', 'selections'];
            let didChange = false;

            images.forEach((img, index) => {
                const newId = getFeedbackImageId(img, index);
                if (!newId) return;

                const normalizedUrl = normalizeUrlForId(img?.url);
                const prefix = currentGallery?.id ? `${currentGallery.id}::` : '';

                const legacyCandidates = [
                    img?.publicId,
                    img?.id,
                    img?.url,
                    normalizedUrl,
                    img?.name,
                    `img_${index}`
                ].filter(Boolean);

                const legacyIds = [
                    ...legacyCandidates,
                    ...legacyCandidates.map(v => `${prefix}${v}`).filter(Boolean)
                ].filter((v, i, arr) => arr.indexOf(v) === i && v !== newId);

                buckets.forEach((bucket) => {
                    const bag = feedbackData[bucket];
                    if (!bag || typeof bag !== 'object') return;
                    if (bag[newId] !== undefined) return;

                    for (const legacyId of legacyIds) {
                        if (bag[legacyId] !== undefined) {
                            bag[newId] = bag[legacyId];
                            delete bag[legacyId];
                            didChange = true;
                            break;
                        }
                    }
                });
            });

            if (didChange) {
                saveFeedbackData();
            }
        }

        function ensureOriginalIndices(images) {
            if (!Array.isArray(images)) return;
            images.forEach((img, idx) => {
                if (!img || typeof img !== 'object') return;
                if (Number.isFinite(Number(img.__wbfmOriginalIndex))) return;
                try {
                    Object.defineProperty(img, '__wbfmOriginalIndex', {
                        value: idx,
                        writable: false,
                        enumerable: false,
                        configurable: true
                    });
                } catch {
                    img.__wbfmOriginalIndex = idx;
                }
            });
        }

        function safeStorageGet(key) {
            try {
                return localStorage.getItem(key);
            } catch {}

            try {
                return sessionStorage.getItem(key);
            } catch {}

            return null;
        }

        function safeStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch {}

            try {
                sessionStorage.setItem(key, value);
                return true;
            } catch {}

            return false;
        }

        function isIndexedDbAvailable() {
            try {
                return typeof indexedDB !== 'undefined';
            } catch {
                return false;
            }
        }

        let _idbPromise = null;

        function openIdb() {
            if (_idbPromise) return _idbPromise;
            if (!isIndexedDbAvailable()) {
                _idbPromise = Promise.resolve(null);
                return _idbPromise;
            }

            _idbPromise = new Promise((resolve) => {
                const request = indexedDB.open('wbfm', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('kv')) {
                        db.createObjectStore('kv');
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });

            return _idbPromise;
        }

        async function idbGet(key) {
            const db = await openIdb();
            if (!db) return null;

            return await new Promise((resolve) => {
                const tx = db.transaction('kv', 'readonly');
                const store = tx.objectStore('kv');
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ?? null);
                req.onerror = () => resolve(null);
            });
        }

        async function idbSet(key, value) {
            const db = await openIdb();
            if (!db) return false;

            return await new Promise((resolve) => {
                const tx = db.transaction('kv', 'readwrite');
                const store = tx.objectStore('kv');
                const req = store.put(value, key);
                req.onsuccess = () => resolve(true);
                req.onerror = () => resolve(false);
            });
        }

        function ensureStorageWarningVisible(message) {
            const container = document.querySelector('.header-inner');
            if (!container) return;

            let el = document.getElementById('storage-warning');
            if (!el) {
                el = document.createElement('div');
                el.id = 'storage-warning';
                el.className = 'storage-warning';
                container.appendChild(el);
            }
            el.textContent = message;
        }

        function formatTs(ts) {
            const n = Number(ts);
            if (!Number.isFinite(n) || n <= 0) return '—';
            try {
                return new Date(n).toLocaleString();
            } catch {
                return String(ts);
            }
        }

        function isDebugEnabled() {
            try {
                const params = new URLSearchParams(window.location.search);
                return params.get('debug') === '1';
            } catch {
                return false;
            }
        }

        async function runStorageDiagnostics() {
            const diagnostics = {
                origin: window.location.origin,
                path: window.location.pathname,
                localOk: false,
                sessionOk: false,
                idbAvailable: isIndexedDbAvailable(),
                localBytes: 0,
                sessionBytes: 0,
                idbBytes: 0,
                metaLocal: null,
                metaSession: null,
                metaIdb: null
            };

            try {
                const probeKey = '__wbfm_probe__';
                localStorage.setItem(probeKey, '1');
                diagnostics.localOk = localStorage.getItem(probeKey) === '1';
                localStorage.removeItem(probeKey);
            } catch {
                diagnostics.localOk = false;
            }

            try {
                const probeKey = '__wbfm_probe__';
                sessionStorage.setItem(probeKey, '1');
                diagnostics.sessionOk = sessionStorage.getItem(probeKey) === '1';
                sessionStorage.removeItem(probeKey);
            } catch {
                diagnostics.sessionOk = false;
            }

            const localPayload = safeStorageGet(FEEDBACK_STORAGE_KEY);
            const sessionPayload = (() => {
                try { return sessionStorage.getItem(FEEDBACK_STORAGE_KEY); } catch { return null; }
            })();
            diagnostics.localBytes = localPayload ? localPayload.length : 0;
            diagnostics.sessionBytes = sessionPayload ? sessionPayload.length : 0;

            diagnostics.metaLocal = safeStorageGet(FEEDBACK_META_KEY);
            diagnostics.metaSession = (() => {
                try { return sessionStorage.getItem(FEEDBACK_META_KEY); } catch { return null; }
            })();
            diagnostics.metaIdb = await idbGet(FEEDBACK_META_KEY);

            const idbPayload = await idbGet(FEEDBACK_STORAGE_KEY);
            diagnostics.idbBytes = typeof idbPayload === 'string' ? idbPayload.length : 0;
            return diagnostics;
        }

        async function ensureDebugPanel() {
            if (!isDebugEnabled()) return;
            let panel = document.getElementById('debug-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'debug-panel';
                panel.className = 'debug-panel';
                panel.innerHTML = '<h4>Debug: Storage</h4><div id="debug-panel-content"></div><button id="debug-panel-refresh" type="button">Refresh</button>';
                document.body.appendChild(panel);
                const btn = panel.querySelector('#debug-panel-refresh');
                if (btn) btn.addEventListener('click', () => void renderDebugPanel());
            }
            await renderDebugPanel();
        }

        async function renderDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (!panel) return;
            const content = document.getElementById('debug-panel-content');
            if (!content) return;

            const d = await runStorageDiagnostics();
            const lastSave = window.__wbfmDebug?.lastSave;
            const lastLoad = window.__wbfmDebug?.lastLoad;

            content.innerHTML = [
                `<div class="row"><span>Origin</span><code>${d.origin}</code></div>`,
                `<div class="row"><span>Path</span><code>${d.path}</code></div>`,
                `<div class="row"><span>Gallery</span><code>${currentGallery?.id || '—'}</code></div>`,
                `<div class="row"><span>Last ImageId</span><code>${window.__wbfmDebug?.lastImageId || '—'}</code></div>`,
                `<div class="row"><span>Last Save</span><code>${lastSave ? formatTs(lastSave) : '—'}</code></div>`,
                `<div class="row"><span>Last Load</span><code>${lastLoad ? formatTs(lastLoad) : '—'}</code></div>`,
                `<div class="row"><span>localStorage OK</span><code>${d.localOk}</code></div>`,
                `<div class="row"><span>sessionStorage OK</span><code>${d.sessionOk}</code></div>`,
                `<div class="row"><span>IndexedDB</span><code>${d.idbAvailable}</code></div>`,
                `<div class="row"><span>Bytes local</span><code>${d.localBytes}</code></div>`,
                `<div class="row"><span>Bytes session</span><code>${d.sessionBytes}</code></div>`,
                `<div class="row"><span>Bytes idb</span><code>${d.idbBytes}</code></div>`,
                `<div class="row"><span>Meta local</span><code>${formatTs(d.metaLocal)}</code></div>`,
                `<div class="row"><span>Meta session</span><code>${formatTs(d.metaSession)}</code></div>`,
                `<div class="row"><span>Meta idb</span><code>${formatTs(d.metaIdb)}</code></div>`
            ].join('');
        }

        function getSelectionToneClass(selectionName) {
            const text = String(selectionName || '');
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = ((hash << 5) - hash) + text.charCodeAt(i);
                hash |= 0;
            }
            const tone = (Math.abs(hash) % 6) + 1;
            return `badge-tone-${tone}`;
        }
        
        // Theme Management
        function initTheme() {
            const savedTheme = safeStorageGet('theme') || 'light';
            const isDark = savedTheme === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            const themeLabel = document.getElementById('theme-label');
            if (themeLabel) themeLabel.textContent = isDark ? 'Hell' : 'Dunkel';
        }
        
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            safeStorageSet('theme', isDark ? 'dark' : 'light');
            const themeLabel = document.getElementById('theme-label');
            if (themeLabel) themeLabel.textContent = isDark ? 'Hell' : 'Dunkel';
        }
        
        // Breadcrumb Navigation
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!breadcrumb || !currentGallery) {
                if (breadcrumb) breadcrumb.style.display = 'none';
                return;
            }
            
            breadcrumb.style.display = 'flex';
            const parts = [];
            
            // Home
            parts.push('<span class="breadcrumb-item" onclick="showGallerySelector()">Home</span>');
            
            // Folder path
            if (currentGallery.folder) {
                const folderParts = currentGallery.folder.split('/');
                let currentPath = '';
                folderParts.forEach((part, index) => {
                    currentPath += (currentPath ? '/' : '') + part;
                    parts.push(`<span class="breadcrumb-separator">›</span>`);
                    parts.push(`<span class="breadcrumb-item" onclick="filterByFolder('${currentPath}')">${part}</span>`);
                });
            }
            
            // Current Gallery
            parts.push(`<span class="breadcrumb-separator">›</span>`);
            parts.push(`<span class="breadcrumb-item active">${currentGallery.name || 'Galerie'}</span>`);
            
            breadcrumb.innerHTML = parts.join('');
        }
        
        function filterByFolder(folderPath) {
            // Filtere Galerien nach Ordner
            if (!galleryConfig || !galleryConfig.galleries) return;
            
            const filtered = galleryConfig.galleries.filter(g => {
                if (!g.folder) return false;
                return g.folder.startsWith(folderPath);
            });
            
            if (filtered.length > 0) {
                showGallerySelector();
                // Highlight entsprechende Galerien
                setTimeout(() => {
                    document.querySelectorAll('.gallery-card').forEach(card => {
                        card.classList.remove('gallery-card--highlighted');
                        const galleryName = card.querySelector('h3')?.textContent;
                        const gallery = filtered.find(g => g.name === galleryName);
                        if (gallery) {
                            card.classList.add('gallery-card--highlighted');
                        }
                    });
                }, 100);
            }
        }
        
        // Search Functionality
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value.toLowerCase().trim();
                    applySearchAndFilter();
                    updateFilterUI();
                });
            }
        }
        
        function applySearchAndFilter() {
            const items = document.querySelectorAll('.gallery-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const imageId = item.dataset.imageId;
                if (!imageId) {
                    item.style.display = 'none';
                    return;
                }
                
                // Finde Bild
                const imageIndex = findImageIndexByFeedbackId(imageId);
                const image = currentImages[imageIndex];
                
                let shouldShow = true;
                
                // Search Filter
                if (searchQuery) {
                    const searchableText = [
                        image?.name || '',
                        image?.id || '',
                        (feedbackData.comments[imageId] || []).map(c => c.text).join(' '),
                        (feedbackData.selections[imageId] || []).join(' ')
                    ].join(' ').toLowerCase();
                    
                    shouldShow = searchableText.includes(searchQuery);
                }
                
                // Existing Filter
                if (shouldShow) {
                    if (currentFilter.type === 'selected') {
                        shouldShow = item.classList.contains('selected');
                    } else if (currentFilter.type === 'favorites') {
                        shouldShow = feedbackData.favorites[imageId] || false;
                    } else if (currentFilter.type === 'commented') {
                        const comments = feedbackData.comments[imageId] || [];
                        shouldShow = comments.length > 0;
                    } else if (currentFilter.type === 'rated') {
                        const rating = Number(feedbackData.ratings[imageId] || 0);
                        if (currentFilter.ratingValue) {
                            shouldShow = rating === Number(currentFilter.ratingValue);
                        } else {
                            shouldShow = rating > 0;
                        }
                    } else if (currentFilter.type === 'selection' && currentFilter.selectionName) {
                        const selections = feedbackData.selections[imageId] || [];
                        shouldShow = selections.includes(currentFilter.selectionName);
                    }
                    
                    if (shouldShow && currentFilter.flag) {
                        const flag = feedbackData.flags[imageId];
                        shouldShow = flag === currentFilter.flag;
                    }
                }
                
                if (shouldShow) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Zeige Meldung wenn keine Bilder sichtbar
            const gallery = document.getElementById('gallery');
            let noResultsMsg = gallery.querySelector('.no-results-message');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.textContent = searchQuery ? `Keine Ergebnisse für "${searchQuery}"` : 'Keine Bilder entsprechen dem Filter';
                    gallery.appendChild(noResultsMsg);
                } else {
                    noResultsMsg.textContent = searchQuery ? `Keine Ergebnisse für "${searchQuery}"` : 'Keine Bilder entsprechen dem Filter';
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }

            updateGalleryVisibleChip(visibleCount, items.length);
        }

        function updateGalleryVisibleChip(visibleCount, totalCount = null) {
            const chip = document.getElementById('gallery-visible-chip');
            if (!chip) return;

            const total = Number.isFinite(Number(totalCount)) ? Number(totalCount) : null;
            chip.textContent = total !== null ? `${visibleCount} / ${total} sichtbar` : `${visibleCount} sichtbar`;
        }
        
        // Lade Feedback-Daten
        async function loadFeedbackData() {
            const saved = safeStorageGet(FEEDBACK_STORAGE_KEY);
            if (saved) {
                try {
                    feedbackData = normalizeFeedbackData(JSON.parse(saved));
                    window.__wbfmDebug.lastLoad = Date.now();
                    return;
                } catch (e) {
                    console.error('Fehler beim Laden der Feedback-Daten:', e);
                }
            }

            const idbSaved = await idbGet(FEEDBACK_STORAGE_KEY);
            if (typeof idbSaved === 'string' && idbSaved) {
                try {
                    feedbackData = normalizeFeedbackData(JSON.parse(idbSaved));
                    window.__wbfmDebug.lastLoad = Date.now();
                } catch (e) {
                    console.error('Fehler beim Laden der IndexedDB Feedback-Daten:', e);
                }
            }
        }
        
        // Speichere Feedback-Daten
        function saveFeedbackData() {
            const payload = JSON.stringify(normalizeFeedbackData(feedbackData));
            const ok = safeStorageSet(FEEDBACK_STORAGE_KEY, payload);
            // Zusätzlich nach IndexedDB spiegeln (robuster in restriktiven Browsern)
            void idbSet(FEEDBACK_STORAGE_KEY, payload);

            const ts = Date.now();
            window.__wbfmDebug.lastSave = ts;
            safeStorageSet(FEEDBACK_META_KEY, String(ts));
            void idbSet(FEEDBACK_META_KEY, String(ts));

            if (!ok) {
                ensureStorageWarningVisible('Hinweis: Der Browser blockiert Speicher. Bewertungen/Feedback können nach einem Neustart verloren gehen.');
            }

            // Optional: Debug Panel aktualisieren
            void ensureDebugPanel();
        }
        
        // Lade Konfiguration von gallery.json
        async function loadConfig() {
            try {
                // Cache-Busting: Füge Timestamp hinzu um sicherzustellen, dass die neueste Version geladen wird
                const cacheBuster = '?t=' + Date.now();
                const response = await fetch('./gallery.json' + cacheBuster);
                if (response.ok) {
                    galleryConfig = await response.json();
                    console.log('gallery.json geladen', {
                        version: galleryConfig.version,
                        galleries: galleryConfig.galleries?.length || 0,
                        generated: galleryConfig.generated
                    });
                    return true;
                } else {
                    console.error('gallery.json konnte nicht geladen werden:', response.status, response.statusText);
                }
                return false;
            } catch (error) {
                console.error('Fehler beim Laden der Konfiguration:', error);
                return false;
            }
        }
        
        // Portfolio Slider Funktionen
        function initPortfolioSlider() {
            const portfolio = galleryConfig?.portfolio || [];
            const wrapper = document.getElementById('portfolio-slider-wrapper');
            
            if (!portfolio || portfolio.length === 0) {
                if (wrapper) wrapper.style.display = 'none';
                return;
            }
            
            if (wrapper) wrapper.style.display = 'grid';
            
            // Split portfolio in zwei Teile
            const mid = Math.ceil(portfolio.length / 2);
            const portfolio1 = portfolio.slice(0, mid);
            const portfolio2 = portfolio.slice(mid);
            
            // Initialisiere beide Slider
            initPortfolioSliderPart(1, portfolio1);
            initPortfolioSliderPart(2, portfolio2);

            // Höhe an Kategorien-Kachel anpassen (Desktop)
            requestAnimationFrame(syncPortfolioHeightToCategoryTile);
        }

        function syncPortfolioHeightToCategoryTile() {
            try {
                if (window.matchMedia && window.matchMedia('(max-width: 968px)').matches) {
                    document.documentElement.style.removeProperty('--portfolio-match-height');
                    return;
                }

                const sidebar = document.getElementById('category-sidebar');
                const wrapper = document.getElementById('portfolio-slider-wrapper');
                if (!sidebar || !wrapper) return;

                const wrapperStyle = window.getComputedStyle(wrapper);
                if (wrapperStyle.display === 'none') {
                    document.documentElement.style.removeProperty('--portfolio-match-height');
                    return;
                }

                const height = sidebar.getBoundingClientRect().height;
                if (!height || height < 120) return;

                document.documentElement.style.setProperty('--portfolio-match-height', `${Math.round(height)}px`);
            } catch (e) {
                // ignore
            }
        }
        
        function initPortfolioSliderPart(sliderNum, portfolio) {
            const container = document.getElementById(`portfolio-slider-container-${sliderNum}`);
            const dots = document.getElementById(`portfolio-dots-${sliderNum}`);
            
            if (!container || !dots) return;
            
            container.innerHTML = '';
            dots.innerHTML = '';
            
            portfolio.forEach((item, index) => {
                // Slide
                const slide = document.createElement('div');
                slide.className = 'portfolio-slide';
                const img = document.createElement('img');
                img.src = item.image || item.url || '';
                img.alt = item.title || '';
                slide.appendChild(img);
                
                if (item.title || item.description) {
                    const overlay = document.createElement('div');
                    overlay.className = 'portfolio-slide-overlay';
                    if (item.title) {
                        const h3 = document.createElement('h3');
                        h3.textContent = item.title;
                        overlay.appendChild(h3);
                    }
                    if (item.description) {
                        const p = document.createElement('p');
                        p.textContent = item.description;
                        overlay.appendChild(p);
                    }
                    slide.appendChild(overlay);
                }
                
                container.appendChild(slide);
                
                // Dot
                const dot = document.createElement('div');
                dot.className = 'portfolio-dot' + (index === 0 ? ' active' : '');
                dot.onclick = () => goToPortfolioSlide(sliderNum, index);
                dots.appendChild(dot);
            });
            
            // Auto-play
            startPortfolioAutoPlay(sliderNum);
        }
        
        function startPortfolioAutoPlay(sliderNum) {
            if (portfolioInterval[sliderNum]) clearInterval(portfolioInterval[sliderNum]);
            
            // Berechne Länge basierend auf Slider-Nummer
            const portfolio = galleryConfig?.portfolio || [];
            const mid = Math.ceil(portfolio.length / 2);
            const sliderPortfolio = sliderNum === 1 ? portfolio.slice(0, mid) : portfolio.slice(mid);
            
            if (sliderPortfolio.length <= 1) return;
            
            portfolioInterval[sliderNum] = setInterval(() => {
                portfolioNext(sliderNum);
            }, 5000);
        }
        
        function portfolioNext(sliderNum) {
            const portfolio = galleryConfig?.portfolio || [];
            const mid = Math.ceil(portfolio.length / 2);
            const sliderPortfolio = sliderNum === 1 ? portfolio.slice(0, mid) : portfolio.slice(mid);
            
            if (sliderPortfolio.length === 0) return;
            portfolioCurrentSlide[sliderNum] = (portfolioCurrentSlide[sliderNum] + 1) % sliderPortfolio.length;
            updatePortfolioSlider(sliderNum);
        }
        
        function portfolioPrev(sliderNum) {
            const portfolio = galleryConfig?.portfolio || [];
            const mid = Math.ceil(portfolio.length / 2);
            const sliderPortfolio = sliderNum === 1 ? portfolio.slice(0, mid) : portfolio.slice(mid);
            
            if (sliderPortfolio.length === 0) return;
            portfolioCurrentSlide[sliderNum] = (portfolioCurrentSlide[sliderNum] - 1 + sliderPortfolio.length) % sliderPortfolio.length;
            updatePortfolioSlider(sliderNum);
        }
        
        function goToPortfolioSlide(sliderNum, index) {
            portfolioCurrentSlide[sliderNum] = index;
            updatePortfolioSlider(sliderNum);
        }
        
        function updatePortfolioSlider(sliderNum) {
            const container = document.getElementById(`portfolio-slider-container-${sliderNum}`);
            const dots = document.querySelectorAll(`#portfolio-dots-${sliderNum} .portfolio-dot`);
            
            if (container) {
                container.style.transform = `translateX(-${portfolioCurrentSlide[sliderNum] * 100}%)`;
            }
            
            dots.forEach((dot, index) => {
                if (index === portfolioCurrentSlide[sliderNum]) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            // Reset Auto-play
            startPortfolioAutoPlay(sliderNum);
        }
        
        // Kategorie-Sidebar initialisieren
        function initCategorySidebar() {
            const categories = galleryConfig?.categories || [];
            const buttonsContainer = document.getElementById('category-buttons');
            if (!buttonsContainer) return;
            
            buttonsContainer.innerHTML = '';
            
            // "Alle" Button
            const allButton = document.createElement('button');
            allButton.className = 'category-button' + (selectedCategory === 'all' ? ' active' : '');
            allButton.innerHTML = '<span>Alle Galerien</span>';
            allButton.onclick = () => filterByCategory('all');
            buttonsContainer.appendChild(allButton);
            
            // Kategorie-Buttons
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button' + (selectedCategory === category.id ? ' active' : '');
                button.innerHTML = `<span>${category.name}</span>`;
                button.onclick = () => filterByCategory(category.id);
                buttonsContainer.appendChild(button);
            });
        }
        
        // Filter nach Kategorie
        function filterByCategory(categoryId) {
            selectedCategory = categoryId;
            initCategorySidebar();
            displayFilteredGalleries();
        }

        // Zeige gefilterte Galerien
        function displayFilteredGalleries() {
            const galleryList = document.getElementById('gallery-list');
            if (!galleryList) return;
            
            galleryList.innerHTML = '';
            
            if (!galleryConfig || !galleryConfig.galleries || galleryConfig.galleries.length === 0) {
                galleryList.innerHTML = '<p class="empty-center">Keine Galerien gefunden</p>';
                return;
            }
            
            // Filtere Galerien nach Kategorie
            let filteredGalleries = galleryConfig.galleries;
            if (selectedCategory !== 'all') {
                filteredGalleries = galleryConfig.galleries.filter(gallery => {
                    return gallery.category === selectedCategory;
                });
            }

            if (gallerySearchQuery.trim()) {
                const query = gallerySearchQuery.trim().toLowerCase();
                filteredGalleries = filteredGalleries.filter((gallery) => {
                    const name = (gallery.name || '').toLowerCase();
                    const description = (gallery.description || '').toLowerCase();
                    return name.includes(query) || description.includes(query);
                });
            }
            
            if (filteredGalleries.length === 0) {
                galleryList.innerHTML = '<p class="empty-center">Keine Galerien in dieser Kategorie gefunden</p>';
                return;
            }
            
            // Gruppiere nach Kategorien (unterhalb des Headers)
            const categories = galleryConfig?.categories || [];
            const nameById = new Map(categories.map(c => [c.id, c.name]));

            const groups = new Map(categories.map(c => [c.id, []]));
            const uncategorized = [];

            filteredGalleries.forEach((gallery) => {
                const catId = gallery.category;
                if (catId && groups.has(catId)) {
                    groups.get(catId).push(gallery);
                } else {
                    uncategorized.push(gallery);
                }
            });

            const renderGroup = (title, items) => {
                const section = document.createElement('section');
                section.className = 'gallery-group';

                const header = document.createElement('div');
                header.className = 'gallery-group-header';
                header.innerHTML = `<h3>${title}</h3><span class="gallery-group-count">${items.length}</span>`;

                const grid = document.createElement('div');
                grid.className = 'gallery-selector gallery-group-grid';
                items
                    .slice()
                    .sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'de'))
                    .forEach((g) => grid.appendChild(createGalleryCard(g)));

                section.appendChild(header);
                section.appendChild(grid);
                galleryList.appendChild(section);
            };

            if (selectedCategory !== 'all') {
                const title = nameById.get(selectedCategory) || 'Galerien';
                renderGroup(title, filteredGalleries);
                return;
            }

            categories.forEach((c) => {
                const items = groups.get(c.id) || [];
                if (items.length) renderGroup(c.name, items);
            });

            if (uncategorized.length) {
                renderGroup('Weitere', uncategorized);
            }
        }
        
        // Zeige Galerie-Auswahl
        function showGallerySelector() {
            document.getElementById('gallery-selector').style.display = 'block';
            document.getElementById('password-form').style.display = 'none';
            document.getElementById('gallery-container').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Verstecke Breadcrumb
            const breadcrumb = document.getElementById('breadcrumb');
            if (breadcrumb) breadcrumb.style.display = 'none';
            
            // Reset Search
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                searchQuery = '';
            }

            const gallerySearchInput = document.getElementById('gallery-search-input');
            if (gallerySearchInput) {
                gallerySearchInput.value = '';
                gallerySearchQuery = '';
                gallerySearchInput.oninput = (event) => {
                    gallerySearchQuery = event.target.value;
                    displayFilteredGalleries();
                };
            }
            
            // Initialisiere Portfolio und Kategorien
            initPortfolioSlider();
            initCategorySidebar();
            displayFilteredGalleries();

            requestAnimationFrame(syncPortfolioHeightToCategoryTile);
            
            // Zeige CTA-Bereich wenn Galerien vorhanden
            const ctaSection = document.getElementById('cta-section');
            if (ctaSection && galleryConfig && galleryConfig.galleries && galleryConfig.galleries.length > 0) {
                ctaSection.style.display = 'block';
            }
        }
        
        // Erstelle Galerie-Karte
        function createGalleryCard(gallery) {
            const card = document.createElement('div');
            const isEmpty = !gallery.images || gallery.images.length === 0;
            card.className = 'gallery-card' + (gallery.password ? ' locked' : '') + (isEmpty ? ' empty' : '');
            
            // Vorschaubild für nicht geschützte Galerien
            let previewImage = '';
            if (!gallery.password && gallery.images && gallery.images.length > 0) {
                const firstImage = gallery.images[0];
                let thumbnailUrl = firstImage.thumbnailUrl || firstImage.url;
                
                // Optimierte Thumbnail-Qualität für kompakte Galerie-Karten (300x300px)
                if (thumbnailUrl.includes('res.cloudinary.com') && thumbnailUrl.includes('/upload/')) {
                    // Ersetze alte kleine Thumbnails durch optimierte Größe
                    if (thumbnailUrl.includes('/c_limit,h_60,w_90/') || thumbnailUrl.includes('/c_fill,h_60,w_90/')) {
                        thumbnailUrl = thumbnailUrl.replace(
                            /\/upload\/[^\/]+\//,
                            '/upload/c_fill,h_300,w_300,q_auto:good,f_auto/'
                        );
                    } else if (!thumbnailUrl.includes('/c_') && !thumbnailUrl.includes('/w_') && !thumbnailUrl.includes('/h_')) {
                        // Keine Transformation - füge hinzu
                        thumbnailUrl = thumbnailUrl.replace(
                            /\/upload\//,
                            '/upload/c_fill,h_300,w_300,q_auto:good,f_auto/'
                        );
                    } else {
                        // Bereits Transformation vorhanden - optimiere falls zu groß
                        const match = thumbnailUrl.match(/\/upload\/[^\/]+\/(c_[^\/]+)/);
                        if (match) {
                            // Prüfe ob größer als 300px
                            const sizeMatch = thumbnailUrl.match(/[hw]_(\d+)/);
                            if (sizeMatch && parseInt(sizeMatch[1]) > 400) {
                                thumbnailUrl = thumbnailUrl.replace(
                                    /\/upload\/[^\/]+\//,
                                    '/upload/c_fill,h_300,w_300,q_auto:good,f_auto/'
                                );
                            }
                        }
                    }
                }
                
                previewImage = `<div class="gallery-card-preview"><img src="${thumbnailUrl}" alt="${gallery.name}" loading="lazy"></div>`;
            }
            
            if (!previewImage) {
                if (gallery.password) {
                    previewImage = `<div class="gallery-card-preview gallery-card-preview--centered">Geschützt</div>`;
                } else {
                    previewImage = `<div class="gallery-card-preview gallery-card-preview--centered">Keine Bilder</div>`;
                }
            }
            
            // Stelle sicher, dass previewImage ein img-Tag ist oder ein div mit korrektem Styling
            if (previewImage.includes('<img')) {
                // img-Tag vorhanden - alles gut
            } else {
                // div placeholder - muss padding-bottom haben
                previewImage = previewImage.replace('class="gallery-card-preview"', 'class="gallery-card-preview gallery-card-preview--ratio"');
            }
            
            card.innerHTML = `
                ${previewImage}
                <div class="gallery-card-content">
                    <div class="gallery-card-header">
                        <h3>${gallery.name || 'Unbenannte Galerie'}</h3>
                        <div class="gallery-card-header-actions">
                            ${isEmpty ? '<span class="gallery-card-badge">Bald verfügbar</span>' : ''}
                            ${gallery.password ? '<span class="gallery-card-badge">Geschützt</span>' : ''}
                        </div>
                    </div>
                    ${gallery.description ? `<p>${gallery.description}</p>` : ''}
                    <div class="gallery-card-footer">
                        <span class="image-count">${gallery.images?.length || 0} Bilder</span>
                    </div>
                </div>
            `;
            card.onclick = () => selectGallery(gallery);
            return card;
        }
        
        // Wähle eine Galerie aus
        function selectGallery(gallery) {
            currentGallery = gallery;
            
            // Prüfe ob Passwort erforderlich ist
            if (gallery.password) {
                document.getElementById('gallery-selector').style.display = 'none';
                document.getElementById('password-form').style.display = 'block';
                document.getElementById('gallery-name-display').textContent = gallery.name || 'Galerie';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            } else {
                // Kein Passwort - zeige Galerie direkt
                showGallery(gallery);
            }
        }
        
        // Passwort-Prüfung
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');
            
            if (currentGallery && currentGallery.password) {
                if (input === currentGallery.password) {
                    showGallery(currentGallery);
                } else {
                    errorEl.style.display = 'block';
                    setTimeout(() => {
                        errorEl.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        // Enter-Taste für Passwort
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Keep fixed gallery topbar offsets correct on resize/orientation changes.
        let galleryMetricsRaf = 0;
        function scheduleGalleryTopbarMetricsUpdate() {
            if (galleryMetricsRaf) cancelAnimationFrame(galleryMetricsRaf);
            galleryMetricsRaf = requestAnimationFrame(() => {
                galleryMetricsRaf = 0;
                updateGalleryTopbarMetrics();
            });
        }

        window.addEventListener('resize', scheduleGalleryTopbarMetricsUpdate, { passive: true });
        window.addEventListener('orientationchange', scheduleGalleryTopbarMetricsUpdate, { passive: true });
        
        // Zeige Galerie
        function showGallery(gallery) {
            document.getElementById('gallery-selector').style.display = 'none';
            document.getElementById('password-form').style.display = 'none';
            document.getElementById('gallery-container').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            // Reset transient UI state (selection is per-view)
            selectedImageIds = new Set();
            lastSelectionIndex = null;
            clearSelectionUndo();
            currentSortKey = 'default';
            const sortEl = document.getElementById('sort-select');
            if (sortEl) sortEl.value = 'default';
            
            // Zeige Zurück-Button nur wenn mehrere Galerien vorhanden
            if (galleryConfig && galleryConfig.galleries && galleryConfig.galleries.length > 1) {
                document.getElementById('back-button').style.display = 'block';
            } else {
                document.getElementById('back-button').style.display = 'none';
            }
            
            currentImagesOriginal = Array.isArray(gallery.images) ? gallery.images : [];
            ensureOriginalIndices(currentImagesOriginal);
            // Working set (can be sorted/filtered without mutating original list)
            currentImages = Array.from(currentImagesOriginal);
            migrateLegacyFeedbackIds(currentImagesOriginal);
            console.log('Lade', currentImages.length, 'Bilder - "' + (gallery.name || 'Unbekannt') + '"');
            const galleryTitle = document.getElementById('gallery-title');
            const gallerySubtitle = document.getElementById('gallery-subtitle');
            if (galleryTitle) galleryTitle.textContent = gallery.name || 'Galerie';
            if (gallerySubtitle) {
                gallerySubtitle.textContent = gallery.description ? gallery.description : 'Bilder auswählen, bewerten und kommentieren.';
            }
            updateBreadcrumb();
            displayGallery(currentImages);
            document.getElementById('loading').style.display = 'none';

            // Update fixed topbar metrics (header + quick filters) so content/sidebar offsets are correct.
            requestAnimationFrame(() => {
                updateGalleryTopbarMetrics();
                requestAnimationFrame(updateGalleryTopbarMetrics);
            });
        }

        function updateGalleryTopbarMetrics() {
            const galleryContainer = document.getElementById('gallery-container');
            if (!galleryContainer) return;
            // Only compute when visible; avoids polluting CSS vars on start screen.
            if (getComputedStyle(galleryContainer).display === 'none') return;

            const header = galleryContainer.querySelector('.gallery-header');
            const filters = galleryContainer.querySelector('#quick-filters');

            const headerHeight = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
            const filtersHeight = filters ? Math.ceil(filters.getBoundingClientRect().height) : 0;

            document.documentElement.style.setProperty('--gallery-header-h', `${headerHeight}px`);
            document.documentElement.style.setProperty('--gallery-filters-h', `${filtersHeight}px`);
        }
        
        // Skeleton Screen für Ladeanimation
        function createSkeletonItems(count) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'gallery-item skeleton';
                skeleton.innerHTML = '<div class="skeleton-shimmer"></div>';
                gallery.appendChild(skeleton);
            }
        }
        
        // Zeige Galerie-Bilder
        function displayGallery(images) {
            const gallery = document.getElementById('gallery');
            
            if (images.length === 0) {
                gallery.innerHTML = '<p class="empty-center-grid">Keine Bilder gefunden</p>';
                return;
            }
            
            // Zeige Skeleton Screens während des Ladens
            createSkeletonItems(Math.min(images.length, 12));
            
            let loadedCount = 0;
            const totalImages = images.length;
            const items = [];
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                const imageId = getFeedbackImageId(image, index);
                item.dataset.imageId = imageId;
                item.dataset.index = String(index);
                
                // Erstelle hochwertiges Thumbnail-URL mit Progressive Loading
                let imgSrc = image.thumbnailUrl || image.url || `./images/${image.name}`;
                const fullSrc = image.url || `./images/${image.name}`;
                
                // Progressive Loading: Zuerst kleines Thumbnail, dann größeres
                let lowQualitySrc = imgSrc;
                let highQualitySrc = imgSrc;
                
                // Wenn Cloudinary-URL vorhanden, aber altes Format (h_60,w_90), ersetze durch größeres Thumbnail
                if (imgSrc.includes('res.cloudinary.com') && imgSrc.includes('/upload/')) {
                    // Prüfe ob bereits Transformation vorhanden
                    if (imgSrc.includes('/c_limit,h_60,w_90/') || imgSrc.includes('/c_fill,h_60,w_90/')) {
                        // Low Quality für schnelles Laden
                        lowQualitySrc = imgSrc.replace(
                            /\/upload\/[^\/]+\//,
                            '/upload/c_fill,h_200,w_200,q_auto:low,f_auto,blur:200/'
                        );
                        // High Quality Thumbnail (400x400px)
                        highQualitySrc = imgSrc.replace(
                            /\/upload\/[^\/]+\//,
                            '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                        );
                    } else if (!imgSrc.includes('/c_') && !imgSrc.includes('/w_') && !imgSrc.includes('/h_')) {
                        // Keine Transformation vorhanden - füge hinzu
                        lowQualitySrc = imgSrc.replace(
                            /\/upload\//,
                            '/upload/c_fill,h_200,w_200,q_auto:low,f_auto,blur:200/'
                        );
                        highQualitySrc = imgSrc.replace(
                            /\/upload\//,
                            '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                        );
                    } else {
                        // Bereits Transformation vorhanden - füge Low Quality Version hinzu
                        lowQualitySrc = imgSrc.replace(
                            /\/upload\/[^\/]+\//,
                            '/upload/c_fill,h_200,w_200,q_auto:low,f_auto,blur:200/'
                        );
                        highQualitySrc = imgSrc;
                    }
                }
                
                const img = document.createElement('img');
                img.alt = image.name || 'Bild';
                img.loading = 'lazy';
                img.decoding = 'async';

                item.classList.remove('is-loaded');
                img.addEventListener('load', () => {
                    item.classList.add('is-loaded');
                }, { once: true });
                
                // Progressive Loading: Lade zuerst Low Quality, dann High Quality
                img.src = lowQualitySrc;
                img.style.filter = 'blur(5px)';
                img.style.transition = 'filter 0.3s';
                
                // Lade High Quality im Hintergrund
                const highQualityImg = new Image();
                highQualityImg.onload = function() {
                    img.src = highQualitySrc;
                    img.style.filter = 'blur(0)';
                };
                highQualityImg.src = highQualitySrc;
                
                // Fallback: Wenn High Quality nicht lädt, behalte Low Quality
                highQualityImg.onerror = function() {
                    img.style.filter = 'blur(0)';
                };
                
                img.onerror = function() {
                    // Fallback 1: Versuche ohne ./ prefix
                    if (this.src.includes('./')) {
                        this.src = this.src.replace('./', '/');
                        return;
                    }
                    // Fallback 2: Versuche direkte URL wenn thumbnailUrl fehlgeschlagen
                    if (image.url && this.src !== image.url) {
                        // Versuche hochwertiges Thumbnail aus original URL zu erstellen
                        if (image.url.includes('res.cloudinary.com')) {
                            this.src = image.url.replace(
                                /\/upload\//,
                                '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                            );
                        } else {
                            this.src = image.url;
                        }
                        return;
                    }
                    // Fallback 3: Zeige Fehler-Placeholder
                    this.onerror = null; // Verhindere Endlosschleife
                    this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23222" width="200" height="200"/%3E%3Ctext fill="%23888" font-family="sans-serif" font-size="14" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EBild nicht gefunden%3C/text%3E%3C/svg%3E';
                };
                
                // Overlay mit Features
                const overlay = document.createElement('div');
                overlay.className = 'gallery-item-overlay';
                
                // Checkbox für Auswahl
                const checkbox = document.createElement('div');
                checkbox.className = 'gallery-item-checkbox';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleImageSelection(imageId, e);
                };
                overlay.appendChild(checkbox);
                
                // Actions (Like, Kommentare)
                const actions = document.createElement('div');
                actions.className = 'gallery-item-actions';
                
                const isFavorite = feedbackData.favorites[imageId] || false;
                const commentCount = (feedbackData.comments[imageId] || []).length;
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'gallery-item-btn gallery-item-like' + (isFavorite ? ' active' : '');
                likeBtn.innerHTML = `<span class="btn-label">Favorit</span> <span class="btn-count">${isFavorite ? 'Ja' : 'Nein'}</span>`;
                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleFavoriteFromGallery(imageId);
                };
                actions.appendChild(likeBtn);
                
                const commentBtn = document.createElement('button');
                commentBtn.className = 'gallery-item-btn';
                commentBtn.innerHTML = `<span class="btn-label">Komm.</span> <span class="btn-count">${commentCount}</span>`;
                commentBtn.onclick = (e) => {
                    e.stopPropagation();
                    openLightbox(index, fullSrc);
                    setTimeout(() => toggleSidebar(), 300);
                };
                actions.appendChild(commentBtn);
                
                overlay.appendChild(actions);
                
                // Badges für Markierungen
                updateImageBadges(item, imageId);
                
                item.appendChild(img);
                item.appendChild(overlay);

                // Persist selection across rerenders (sorting etc.)
                if (selectedImageIds && selectedImageIds.has(imageId)) {
                    setGalleryItemSelected(item, true);
                }
                item.onclick = () => openLightbox(index, fullSrc);
                
                items.push(item);
            });
            
            // Ersetze Skeletons durch echte Items
            const skeletons = gallery.querySelectorAll('.skeleton');
            items.forEach((item, idx) => {
                if (skeletons[idx]) {
                    skeletons[idx].replaceWith(item);
                } else {
                    gallery.appendChild(item);
                }
            });
            
            // Entferne verbleibende Skeletons
            setTimeout(() => {
                document.querySelectorAll('.skeleton').forEach(s => s.remove());
            }, 500);
            
            // Update alle Badges nach dem Rendern
            updateAllImageBadges();
            
            // Update Sidebar-Statistiken
            updateSidebarStats();

            // Selection Bar initial ausrichten
            updateSelectionBar();
            
            // Filter anwenden
            applyFilter();
            updateFilterUI();
        }
        
        // Aktiver Filter
        let currentFilter = {
            type: 'all',  // 'all', 'selected', 'favorites', 'commented', 'rated', 'selection'
            flag: null,   // 'reject', 'review', 'approve', 'final', null
            selectionName: null,  // Name der Auswahl, wenn type === 'selection'
            ratingValue: null     // 1..5 wenn type === 'rated'
        };

        function parseImageDateMs(image) {
            if (!image) return 0;
            const candidates = [
                image.date,
                image.uploadDate,
                image.createdAt,
                image.timestamp,
                image.exifDate
            ].filter(v => v !== undefined && v !== null && v !== '');

            for (const c of candidates) {
                if (typeof c === 'number' && Number.isFinite(c)) {
                    // Heuristic: seconds vs ms
                    const ms = c < 2_000_000_000 ? c * 1000 : c;
                    if (Number.isFinite(ms)) return ms;
                }
                if (typeof c === 'string') {
                    const t = Date.parse(c);
                    if (Number.isFinite(t)) return t;
                }
            }
            return 0;
        }

        function getImageNameForSort(image) {
            const raw = (image?.name || image?.id || image?.publicId || image?.url || '').toString();
            return raw.toLowerCase();
        }

        function getFlagRank(flag) {
            // Higher rank = "better" (Final first)
            const ranks = { final: 4, approve: 3, review: 2, reject: 1 };
            return ranks[String(flag || '').toLowerCase()] || 0;
        }

        function sortImagesByKey(images, sortKey) {
            const key = String(sortKey || 'default');
            const base = Array.isArray(images) ? Array.from(images) : [];
            if (key === 'default') return base;

            const compareNumber = (a, b) => (a === b ? 0 : a < b ? -1 : 1);

            return base.sort((imgA, imgB) => {
                const idxA = Number.isFinite(Number(imgA?.__wbfmOriginalIndex)) ? Number(imgA.__wbfmOriginalIndex) : 0;
                const idxB = Number.isFinite(Number(imgB?.__wbfmOriginalIndex)) ? Number(imgB.__wbfmOriginalIndex) : 0;
                const idA = getFeedbackImageId(imgA, idxA);
                const idB = getFeedbackImageId(imgB, idxB);

                if (key.startsWith('name_')) {
                    const dir = key.endsWith('_desc') ? -1 : 1;
                    const a = getImageNameForSort(imgA);
                    const b = getImageNameForSort(imgB);
                    const cmp = a.localeCompare(b);
                    return cmp !== 0 ? cmp * dir : compareNumber(idxA, idxB);
                }

                if (key.startsWith('date_')) {
                    const dir = key.endsWith('_desc') ? -1 : 1;
                    const a = parseImageDateMs(imgA);
                    const b = parseImageDateMs(imgB);
                    const cmp = compareNumber(a, b);
                    return cmp !== 0 ? cmp * dir : compareNumber(idxA, idxB);
                }

                if (key.startsWith('rating_')) {
                    const dir = key.endsWith('_desc') ? -1 : 1;
                    const a = Number(feedbackData.ratings[idA] || 0);
                    const b = Number(feedbackData.ratings[idB] || 0);
                    const cmp = compareNumber(a, b);
                    return cmp !== 0 ? cmp * dir : compareNumber(idxA, idxB);
                }

                if (key.startsWith('flag_')) {
                    const dir = key.endsWith('_desc') ? -1 : 1;
                    const a = getFlagRank(feedbackData.flags[idA]);
                    const b = getFlagRank(feedbackData.flags[idB]);
                    const cmp = compareNumber(a, b);
                    return cmp !== 0 ? cmp * dir : compareNumber(idxA, idxB);
                }

                return compareNumber(idxA, idxB);
            });
        }

        function applySort(sortKey, { silent = false } = {}) {
            const next = String(sortKey || 'default');
            currentSortKey = next;

            const selectEl = document.getElementById('sort-select');
            if (selectEl && selectEl.value !== next) selectEl.value = next;

            const activeImage = currentImages?.[currentImageIndex];
            const activeId = activeImage ? getFeedbackImageId(activeImage, currentImageIndex) : null;

            currentImages = sortImagesByKey(currentImagesOriginal, next);

            if (activeId) {
                const idx = currentImages.findIndex((img, i) => getFeedbackImageId(img, i) === activeId);
                if (idx >= 0) currentImageIndex = idx;
            }

            displayGallery(currentImages);

            // If overlays are open, refresh their content
            if (isLightboxActive()) {
                const image = currentImages?.[currentImageIndex];
                if (image) {
                    const imgEl = document.getElementById('lightbox-image');
                    if (imgEl) imgEl.src = getFullImageUrl(image);
                    updateFeedbackSidebar();
                    renderLightboxFilmstrip();
                    updateLightboxFilmstripActive();
                }
            }
            if (isCullingActive()) {
                renderCulling();
            }
            if (isCompareActive()) {
                openCompareView();
            }

            if (!silent) {
                const labels = {
                    default: 'Standard',
                    date_desc: 'Datum ↓',
                    date_asc: 'Datum ↑',
                    name_asc: 'Name A→Z',
                    name_desc: 'Name Z→A',
                    rating_desc: 'Rating ↓',
                    rating_asc: 'Rating ↑',
                    flag_desc: 'Flag (Final→…)',
                    flag_asc: 'Flag (…→Final)'
                };
                showToast('Sortierung', labels[next] || next, 'info');
            }
        }

        function initSortControls() {
            const selectEl = document.getElementById('sort-select');
            if (!selectEl) return;
            selectEl.value = currentSortKey || 'default';
            selectEl.addEventListener('change', () => {
                applySort(selectEl.value);
            });
        }
        
        // Toggle Gallery Sidebar
        function toggleGallerySidebar() {
            const sidebar = document.getElementById('gallery-sidebar');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');
            sidebar.classList.toggle('collapsed');
            toggleIcon.textContent = sidebar.classList.contains('collapsed') ? '◀' : '▶';
        }
        
        // Filter nach Typ
        function filterByType(type) {
            currentFilter.type = type;
            currentFilter.flag = null;
            currentFilter.selectionName = null;
            currentFilter.ratingValue = null;
            applyFilter();
            updateFilterUI();
        }
        
        // Filter nach Flag
        function filterByFlag(flag) {
            if (currentFilter.flag === flag) {
                // Toggle: Wenn bereits aktiv, zurücksetzen
                currentFilter.flag = null;
                currentFilter.type = 'all';
            } else {
                currentFilter.flag = flag;
                currentFilter.type = 'all';
            }
            currentFilter.selectionName = null;
            currentFilter.ratingValue = null;
            applyFilter();
            updateFilterUI();
        }

        // Filter nach Bewertung
        function filterByRating(ratingValue) {
            const nextRating = Number(ratingValue);
            if (!Number.isFinite(nextRating) || nextRating < 1 || nextRating > 5) return;

            if (currentFilter.type === 'rated' && currentFilter.ratingValue === nextRating) {
                currentFilter.type = 'all';
                currentFilter.ratingValue = null;
            } else {
                currentFilter.type = 'rated';
                currentFilter.ratingValue = nextRating;
            }

            currentFilter.flag = null;
            currentFilter.selectionName = null;
            applyFilter();
            updateFilterUI();
        }
        
        // Filter anwenden
        function applyFilter() {
            applySearchAndFilter();
        }
        
        // Update Filter UI (aktive Zustände)
        function updateFilterUI() {
            // Entferne alle aktiven Zustände
            document.querySelectorAll('.stat-item, .flag-summary-item, .rating-summary-item, .selection-item, .quick-filter-chip').forEach(el => {
                el.classList.remove('active');
            });

            // Quick filter chips
            const chips = Array.from(document.querySelectorAll('.quick-filter-chip'));
            chips.forEach(chip => {
                const type = chip.dataset.filterType;
                const flag = chip.dataset.filterFlag;
                const rating = chip.dataset.filterRating;

                if (flag && currentFilter.flag === flag) chip.classList.add('active');
                if (rating && currentFilter.type === 'rated' && Number(currentFilter.ratingValue) === Number(rating)) chip.classList.add('active');
                if (type && currentFilter.type === type) {
                    // Spezialfall: rated chip ohne feste ratingValue ist hier nicht aktiv
                    if (!(type === 'rated' && !chip.dataset.filterRating)) chip.classList.add('active');
                }
                if (type === 'all' && currentFilter.type === 'all' && !currentFilter.flag) chip.classList.add('active');
            });
            
            // Setze aktiven Zustand für Typ-Filter
            if (currentFilter.type === 'all') {
                document.querySelectorAll('.stat-item')[0].classList.add('active');
            } else if (currentFilter.type === 'selection') {
                // Aktiviere entsprechende Auswahl
                const selectionItems = document.querySelectorAll('.selection-item');
                selectionItems.forEach(item => {
                    if (item.textContent.includes(currentFilter.selectionName)) {
                        item.classList.add('active');
                    }
                });
            } else {
                const statItems = document.querySelectorAll('.stat-item');
                const typeMap = {
                    'selected': 1,
                    'favorites': 2,
                    'commented': 3,
                    'rated': 4
                };
                if (typeMap[currentFilter.type] !== undefined) {
                    statItems[typeMap[currentFilter.type]].classList.add('active');
                }
            }
            
            // Setze aktiven Zustand für Flag-Filter
            if (currentFilter.flag) {
                const flagItems = document.querySelectorAll('.flag-summary-item');
                const flagMap = {
                    'reject': 0,
                    'review': 1,
                    'approve': 2,
                    'final': 3
                };
                if (flagMap[currentFilter.flag] !== undefined) {
                    flagItems[flagMap[currentFilter.flag]].classList.add('active');
                }
            }

            // Setze aktiven Zustand für Rating-Filter
            if (currentFilter.type === 'rated' && currentFilter.ratingValue) {
                document.querySelectorAll('.rating-summary-item').forEach(item => {
                    if (Number(item.dataset.rating) === Number(currentFilter.ratingValue)) {
                        item.classList.add('active');
                    }
                });
            }

            // Header Filter Chip
            const filterChip = document.getElementById('gallery-filter-chip');
            if (filterChip) {
                const parts = [];
                if (searchQuery) parts.push(`Suche: ${searchQuery}`);
                if (currentFilter.flag) parts.push(`Flag: ${currentFilter.flag}`);
                if (currentFilter.type === 'rated' && currentFilter.ratingValue) parts.push(`Rating: ${currentFilter.ratingValue}★`);
                else if (currentFilter.type === 'favorites') parts.push('Favoriten');
                else if (currentFilter.type === 'commented') parts.push('Kommentare');
                else if (currentFilter.type === 'selected') parts.push('Ausgewählt');
                else if (currentFilter.type === 'selection' && currentFilter.selectionName) parts.push(`Auswahl: ${currentFilter.selectionName}`);
                else parts.push('Alle');
                filterChip.textContent = parts.join(' · ');
            }
        }

        function initQuickFilters() {
            const container = document.getElementById('quick-filters');
            if (!container) return;

            container.addEventListener('click', (e) => {
                const btn = e.target.closest('.quick-filter-chip');
                if (!btn) return;

                const type = btn.dataset.filterType;
                const flag = btn.dataset.filterFlag;
                const rating = btn.dataset.filterRating;

                if (flag) {
                    filterByFlag(flag);
                    return;
                }
                if (rating) {
                    filterByRating(Number(rating));
                    return;
                }
                if (type) {
                    filterByType(type);
                }
            });
        }
        
        // Update Sidebar Statistiken
        function updateSidebarStats() {
            const total = currentImages.length;
            const selected = document.querySelectorAll('.gallery-item.selected').length;
            const currentIds = new Set(currentImages.map((img, idx) => getFeedbackImageId(img, idx)));
            const favorites = Object.keys(feedbackData.favorites).filter(id => currentIds.has(id)).length;
            const commented = Object.keys(feedbackData.comments).filter(id => {
                const comments = feedbackData.comments[id] || [];
                return comments.length > 0 && currentIds.has(id);
            }).length;
            const rated = Object.entries(feedbackData.ratings).filter(([id, value]) => {
                const rating = Number(value || 0);
                return rating > 0 && currentIds.has(id);
            }).length;

            const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            currentImages.forEach((img, index) => {
                const imageId = getFeedbackImageId(img, index);
                const rating = Number(feedbackData.ratings[imageId] || 0);
                if (Object.prototype.hasOwnProperty.call(ratingCounts, rating)) ratingCounts[rating]++;
            });
            
            // Flag-Zähler
            const flagCounts = {
                reject: 0,
                review: 0,
                approve: 0,
                final: 0
            };
            
            currentImages.forEach((img, index) => {
                const imageId = getFeedbackImageId(img, index);
                const flag = feedbackData.flags[imageId];
                if (flag && flagCounts.hasOwnProperty(flag)) {
                    flagCounts[flag]++;
                }
            });
            
            // Update DOM
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-selected').textContent = selected;
            document.getElementById('stat-favorites').textContent = favorites;
            document.getElementById('stat-commented').textContent = commented;
            document.getElementById('stat-rated').textContent = rated;

            const r1 = document.getElementById('rating-count-1');
            const r2 = document.getElementById('rating-count-2');
            const r3 = document.getElementById('rating-count-3');
            const r4 = document.getElementById('rating-count-4');
            const r5 = document.getElementById('rating-count-5');
            if (r1) r1.textContent = ratingCounts[1];
            if (r2) r2.textContent = ratingCounts[2];
            if (r3) r3.textContent = ratingCounts[3];
            if (r4) r4.textContent = ratingCounts[4];
            if (r5) r5.textContent = ratingCounts[5];

            const galleryCountChip = document.getElementById('gallery-count-chip');
            const gallerySelectedChip = document.getElementById('gallery-selected-chip');
            if (galleryCountChip) galleryCountChip.textContent = `${total} Bilder`;
            if (gallerySelectedChip) gallerySelectedChip.textContent = `${selected} ausgewählt`;

            updateSelectionBar(selected);
            
            document.getElementById('flag-reject').textContent = flagCounts.reject;
            document.getElementById('flag-review').textContent = flagCounts.review;
            document.getElementById('flag-approve').textContent = flagCounts.approve;
            document.getElementById('flag-final').textContent = flagCounts.final;
            
            // Update Auswahlen-Liste
            const selectionsSet = new Set();
            currentImages.forEach((img, index) => {
                const imageId = getFeedbackImageId(img, index);
                const selections = feedbackData.selections[imageId] || [];
                selections.forEach(s => selectionsSet.add(s));
            });
            
            const selectionsList = document.getElementById('selections-list');
            if (selectionsSet.size === 0) {
                selectionsList.innerHTML = '<p class="muted-small">Keine Auswahlen</p>';
            } else {
                selectionsList.innerHTML = Array.from(selectionsSet).map(s => {
                    const count = currentImages.filter((img, index) => {
                        const imageId = getFeedbackImageId(img, index);
                        return (feedbackData.selections[imageId] || []).includes(s);
                    }).length;
                    const esc = s.replace(/'/g, "\\'");
                    return `
                        <div class="selection-row-item">
                            <div class="selection-item clickable" onclick="filterBySelection('${esc}')" title="Nur Bilder in dieser Auswahl">${s} <span class="selection-count">${count}</span></div>
                            <div class="selection-row-actions">
                                <button class="selection-mini-btn" type="button" onclick="exportSelectionByName('${esc}')" title="JSON Export nur dieser Auswahl">JSON</button>
                                <button class="selection-mini-btn" type="button" onclick="downloadSelectionZipByName('${esc}')" title="ZIP Download nur dieser Auswahl">ZIP</button>
                            </div>
                        </div>`;
                }).join('');
            }
        }
        
        // Filter nach Auswahl
        function filterBySelection(selectionName) {
            if (currentFilter.type === 'selection' && currentFilter.selectionName === selectionName) {
                // Toggle: Wenn bereits aktiv, zurücksetzen
                currentFilter.type = 'all';
                currentFilter.selectionName = null;
            } else {
                currentFilter.type = 'selection';
                currentFilter.selectionName = selectionName;
            }
            currentFilter.flag = null;
            currentFilter.ratingValue = null;
            applyFilter();
            updateFilterUI();
        }
        
        // Update Badges für ein Bild
        function updateImageBadges(item, imageId) {
            if (!item || !imageId) return;
            
            // Entferne alte Badges
            const oldBadges = item.querySelectorAll('.gallery-item-badge, .selection-badge, .rating-badge, .gallery-item-badge-stack-left, .gallery-item-badge-stack-right');
            oldBadges.forEach(b => b.remove());

            const leftStack = document.createElement('div');
            leftStack.className = 'gallery-item-badge-stack-left';
            const rightStack = document.createElement('div');
            rightStack.className = 'gallery-item-badge-stack-right';
            
            const flag = feedbackData.flags[imageId];
            if (flag) {
                const badge = document.createElement('div');
                badge.className = `gallery-item-badge badge--${flag}`;
                const flagLabels = {
                    'reject': 'Abgelehnt',
                    'review': 'Prüfen',
                    'approve': 'Genehmigt',
                    'final': 'Final'
                };
                badge.textContent = flagLabels[flag] || flag;
                rightStack.appendChild(badge);
            }
            
            const selections = feedbackData.selections[imageId] || [];
            if (selections.length > 0) {
                const selectionBadge = document.createElement('div');
                const primary = selections[0];
                selectionBadge.className = `selection-badge ${getSelectionToneClass(primary)}`;
                selectionBadge.textContent = `${primary}${selections.length > 1 ? ` +${selections.length - 1}` : ''}`;
                leftStack.appendChild(selectionBadge);
            }

            const rating = feedbackData.ratings[imageId] || 0;
            if (rating > 0) {
                const ratingBadge = document.createElement('div');
                ratingBadge.className = 'rating-badge';
                ratingBadge.textContent = `★ ${rating}`;
                leftStack.appendChild(ratingBadge);
            }

            if (leftStack.childNodes.length > 0) item.appendChild(leftStack);
            if (rightStack.childNodes.length > 0) item.appendChild(rightStack);
        }
        
        // Update alle Badges
        function updateAllImageBadges() {
            const items = document.querySelectorAll('.gallery-item');
            items.forEach(item => {
                const imageId = item.dataset.imageId;
                if (imageId) {
                    updateImageBadges(item, imageId);
                }
            });
        }
        
        // Lightbox
        let lightboxFilmstripCacheKey = null;

        function buildCloudinaryThumb(url, w = 80, h = 80) {
            if (!url || typeof url !== 'string') return url;
            if (!url.includes('res.cloudinary.com') || !url.includes('/upload/')) return url;
            // If URL already has transformations, replace them; else insert.
            if (url.match(/\/upload\/[^\/]+\//)) {
                return url.replace(
                    /\/upload\/[^\/]+\//,
                    `/upload/c_fill,h_${h},w_${w},q_auto:good,f_auto/`
                );
            }
            return url.replace(
                /\/upload\//,
                `/upload/c_fill,h_${h},w_${w},q_auto:good,f_auto/`
            );
        }

        function getFilmstripThumbUrl(image) {
            const raw = image?.thumbnailUrl || image?.url || (image?.name ? `./images/${image.name}` : '');
            if (!raw) return '';
            return buildCloudinaryThumb(raw, 80, 80);
        }

        function renderLightboxFilmstrip() {
            const inner = document.getElementById('lightbox-filmstrip-inner');
            if (!inner) return;

            const galleryId = currentGallery?.id || currentGallery?.name || 'gallery';
            const key = `${galleryId}|${currentImages?.length || 0}`;
            if (lightboxFilmstripCacheKey === key && inner.childElementCount === (currentImages?.length || 0)) {
                updateLightboxFilmstripActive();
                return;
            }

            lightboxFilmstripCacheKey = key;
            inner.innerHTML = '';

            const frag = document.createDocumentFragment();
            (currentImages || []).forEach((img, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'lightbox-thumb';
                btn.dataset.index = String(idx);
                btn.title = img?.name || `Bild ${idx + 1}`;
                btn.setAttribute('aria-label', img?.name || `Bild ${idx + 1}`);

                const imageEl = document.createElement('img');
                imageEl.loading = 'lazy';
                imageEl.decoding = 'async';
                imageEl.alt = img?.name || 'Bild';
                imageEl.src = getFilmstripThumbUrl(img);
                btn.appendChild(imageEl);

                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openLightbox(idx);
                });

                frag.appendChild(btn);
            });
            inner.appendChild(frag);

            updateLightboxFilmstripActive();
        }

        function updateLightboxFilmstripActive() {
            const inner = document.getElementById('lightbox-filmstrip-inner');
            if (!inner) return;
            const thumbs = Array.from(inner.querySelectorAll('.lightbox-thumb'));
            thumbs.forEach(t => t.classList.toggle('active', Number(t.dataset.index) === Number(currentImageIndex)));

            const active = thumbs.find(t => t.classList.contains('active'));
            if (active && typeof active.scrollIntoView === 'function') {
                active.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
            }
        }

        function isLightboxActive() {
            const el = document.getElementById('lightbox');
            return Boolean(el && el.classList.contains('active'));
        }

        function isCullingActive() {
            const el = document.getElementById('culling-overlay');
            return Boolean(el && el.classList.contains('active'));
        }

        function isCompareActive() {
            const el = document.getElementById('compare-overlay');
            return Boolean(el && el.classList.contains('active'));
        }

        function updateBodyOverlayState() {
            const any = isLightboxActive() || isCullingActive() || isCompareActive();
            document.body.classList.toggle('lightbox-open', any);
        }

        let cullingLayout = 2; // 1 or 2
        let cullingFilmstripCacheKey = null;

        function getFullImageUrl(image) {
            return image?.url || (image?.name ? `./images/${image.name}` : '');
        }

        function renderCulling() {
            const overlay = document.getElementById('culling-overlay');
            if (!overlay || !overlay.classList.contains('active')) return;

            const grid = document.getElementById('culling-grid');
            const title = document.getElementById('culling-title');
            const layoutBtn = document.getElementById('culling-layout-btn');
            if (layoutBtn) layoutBtn.textContent = cullingLayout === 2 ? '2-up' : '1-up';

            const total = currentImages?.length || 0;
            const idx = Number(currentImageIndex) || 0;
            if (title) title.textContent = `Culling · ${total ? (idx + 1) : 0}/${total}`;

            if (grid) {
                grid.classList.toggle('culling-grid--one', cullingLayout === 1);
                grid.classList.toggle('culling-grid--two', cullingLayout === 2);
            }

            const slots = [0, 1];
            slots.forEach((slot) => {
                const frame = overlay.querySelector(`.culling-frame[data-slot="${slot}"]`);
                const imgEl = document.getElementById(`culling-image-${slot}`);
                const imageIndex = slot === 0 ? idx : idx + 1;
                const image = currentImages?.[imageIndex];

                if (!imgEl || !frame) return;
                if (cullingLayout === 1 && slot === 1) {
                    frame.style.display = 'none';
                    return;
                }
                frame.style.display = '';

                if (!image) {
                    imgEl.src = '';
                    imgEl.alt = '';
                    frame.classList.remove('is-selected');
                    return;
                }

                const imageUrl = getFullImageUrl(image);
                imgEl.src = imageUrl;
                imgEl.alt = image?.name || 'Bild';

                const imageId = getFeedbackImageId(image, imageIndex);
                frame.classList.toggle('is-selected', Boolean(imageId && selectedImageIds && selectedImageIds.has(imageId)));

                frame.onclick = (e) => {
                    e.preventDefault();
                    if (!imageId) return;
                    toggleImageSelection(imageId, { shiftKey: false });
                };
            });

            renderCullingFilmstrip();
            updateCullingFilmstripActive();
        }

        function renderCullingFilmstrip() {
            const inner = document.getElementById('culling-filmstrip-inner');
            if (!inner) return;

            const galleryId = currentGallery?.id || currentGallery?.name || 'gallery';
            const key = `${galleryId}|${currentImages?.length || 0}`;
            if (cullingFilmstripCacheKey === key && inner.childElementCount === (currentImages?.length || 0)) {
                return;
            }
            cullingFilmstripCacheKey = key;
            inner.innerHTML = '';

            const frag = document.createDocumentFragment();
            (currentImages || []).forEach((img, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'lightbox-thumb';
                btn.dataset.index = String(idx);
                btn.title = img?.name || `Bild ${idx + 1}`;
                btn.setAttribute('aria-label', img?.name || `Bild ${idx + 1}`);

                const imageEl = document.createElement('img');
                imageEl.loading = 'lazy';
                imageEl.decoding = 'async';
                imageEl.alt = img?.name || 'Bild';
                imageEl.src = getFilmstripThumbUrl(img);
                btn.appendChild(imageEl);

                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentImageIndex = idx;
                    renderCulling();
                });

                frag.appendChild(btn);
            });
            inner.appendChild(frag);
        }

        function updateCullingFilmstripActive() {
            const inner = document.getElementById('culling-filmstrip-inner');
            if (!inner) return;

            const idx = Number(currentImageIndex) || 0;
            const second = idx + 1;
            const thumbs = Array.from(inner.querySelectorAll('.lightbox-thumb'));
            thumbs.forEach(t => {
                const i = Number(t.dataset.index);
                const active = cullingLayout === 2 ? (i === idx || i === second) : (i === idx);
                t.classList.toggle('active', active);
            });

            const focusIdx = idx;
            const active = thumbs.find(t => Number(t.dataset.index) === focusIdx);
            if (active && typeof active.scrollIntoView === 'function') {
                active.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
            }
        }

        function openCullingMode(startIndex = 0) {
            const overlay = document.getElementById('culling-overlay');
            if (!overlay) return;

            // If lightbox is open, close it (culling is a separate mode)
            const lightbox = document.getElementById('lightbox');
            if (lightbox && lightbox.classList.contains('active')) {
                lightbox.classList.remove('active');
            }

            currentImageIndex = Math.max(0, Math.min(Number(startIndex) || 0, (currentImages?.length || 1) - 1));
            overlay.classList.add('active');
            updateBodyOverlayState();

            renderCulling();
        }

        function closeCullingMode() {
            const overlay = document.getElementById('culling-overlay');
            if (!overlay) return;
            overlay.classList.remove('active');
            updateBodyOverlayState();
        }

        function toggleCullingMode() {
            if (isCullingActive()) {
                closeCullingMode();
                return;
            }
            openCullingMode(currentImageIndex || 0);
        }

        function toggleCullingLayout() {
            cullingLayout = cullingLayout === 2 ? 1 : 2;
            renderCulling();
        }

        function openCompareView() {
            const overlay = document.getElementById('compare-overlay');
            const grid = document.getElementById('compare-grid');
            if (!overlay || !grid) return;

            const selectedItems = getSelectedItems();
            const ids = selectedItems.map(el => el.dataset.imageId).filter(Boolean);
            if (ids.length < 2) {
                showToast('Vergleich', 'Bitte 2–4 Bilder auswählen.', 'warning');
                return;
            }
            if (ids.length > 4) {
                showToast('Vergleich', 'Maximal 4 Bilder für Compare.', 'warning');
                return;
            }

            overlay.classList.add('active');
            updateBodyOverlayState();

            const title = document.getElementById('compare-title');
            if (title) title.textContent = `Vergleich · ${ids.length} Bild(er)`;

            grid.className = 'compare-grid';
            grid.classList.add(`compare-grid--${ids.length}`);
            grid.innerHTML = '';

            const frag = document.createDocumentFragment();
            ids.forEach((imageId) => {
                const imageIndex = findImageIndexByFeedbackId(imageId);
                const image = currentImages?.[imageIndex];
                if (!image) return;

                const card = document.createElement('div');
                card.className = 'compare-card';

                const imgEl = document.createElement('img');
                imgEl.loading = 'lazy';
                imgEl.decoding = 'async';
                imgEl.alt = image?.name || 'Bild';
                imgEl.src = getFullImageUrl(image);
                imgEl.addEventListener('click', () => {
                    closeCompareView();
                    openLightbox(imageIndex);
                });

                const meta = document.createElement('div');
                meta.className = 'compare-meta';

                const left = document.createElement('div');
                left.className = 'name';
                left.textContent = image?.name || imageId;

                const right = document.createElement('div');
                const rating = Number(feedbackData.ratings[imageId] || 0);
                const flag = feedbackData.flags[imageId] || '';
                const fav = feedbackData.favorites[imageId] ? '♥' : '';
                const ratingText = rating > 0 ? `★${rating}` : '';
                right.textContent = [fav, ratingText, flag].filter(Boolean).join(' ');

                meta.appendChild(left);
                meta.appendChild(right);

                card.appendChild(imgEl);
                card.appendChild(meta);
                frag.appendChild(card);
            });

            grid.appendChild(frag);
        }

        function closeCompareView() {
            const overlay = document.getElementById('compare-overlay');
            if (!overlay) return;
            overlay.classList.remove('active');
            updateBodyOverlayState();
        }

        function initViewModeControls() {
            const cullingToggleBtn = document.getElementById('culling-toggle-btn');
            if (cullingToggleBtn) cullingToggleBtn.addEventListener('click', () => toggleCullingMode());

            const cullingClose = document.getElementById('culling-close');
            if (cullingClose) cullingClose.addEventListener('click', () => closeCullingMode());
            const cullingLayoutBtn = document.getElementById('culling-layout-btn');
            if (cullingLayoutBtn) cullingLayoutBtn.addEventListener('click', () => toggleCullingLayout());
            const cullingOpenLightboxBtn = document.getElementById('culling-open-lightbox-btn');
            if (cullingOpenLightboxBtn) cullingOpenLightboxBtn.addEventListener('click', () => {
                const idx = Number(currentImageIndex) || 0;
                closeCullingMode();
                openLightbox(idx);
            });

            const compareClose = document.getElementById('compare-close');
            if (compareClose) compareClose.addEventListener('click', () => closeCompareView());
            const compareOpenLightboxBtn = document.getElementById('compare-open-lightbox-btn');
            if (compareOpenLightboxBtn) compareOpenLightboxBtn.addEventListener('click', () => {
                const first = getSelectedItems()?.[0];
                const id = first?.dataset?.imageId;
                if (!id) return;
                const idx = findImageIndexByFeedbackId(id);
                closeCompareView();
                openLightbox(idx);
            });
        }

        function openLightbox(index, fullImageUrl = null) {
            currentImageIndex = index;
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-image');
            const sidebar = document.getElementById('feedback-sidebar');
            
            const image = currentImages[index];
            const imageUrl = fullImageUrl || image.url || `./images/${image.name}`;
            
            img.src = imageUrl;
            img.alt = image.name || 'Bild';
            lightbox.classList.add('active');
            updateBodyOverlayState();

            if (sidebar && window.matchMedia && window.matchMedia('(min-width: 1100px)').matches) {
                sidebar.classList.add('open');
            }
            
            // Update Feedback-Sidebar für aktuelles Bild
            updateFeedbackSidebar();

            // Filmstrip
            renderLightboxFilmstrip();
        }
        
        // Toggle Bild-Auswahl (inkl. Shift-Range)
        function toggleImageSelection(imageId, event = null) {
            const item = document.querySelector(`[data-image-id="${imageId}"]`);
            if (!item) return;

            // Wenn der Nutzer nach einem Reset wieder manuell auswählt, Undo invalidieren
            if (!window.__selectionUndoRestoring) {
                clearSelectionUndo();
            }

            const currentIndexRaw = item.dataset.index;
            const currentIndex = currentIndexRaw !== undefined ? Number(currentIndexRaw) : NaN;

            const isShift = Boolean(event && event.shiftKey);
            if (isShift && Number.isFinite(currentIndex) && Number.isFinite(lastSelectionIndex)) {
                const from = Math.min(lastSelectionIndex, currentIndex);
                const to = Math.max(lastSelectionIndex, currentIndex);
                const visibleItems = getBulkTargetItems('visible');

                visibleItems
                    .filter(el => {
                        const idx = Number(el.dataset.index);
                        return Number.isFinite(idx) && idx >= from && idx <= to;
                    })
                    .forEach(el => setGalleryItemSelected(el, true));
            } else {
                const isSelected = item.classList.contains('selected');
                setGalleryItemSelected(item, !isSelected);
            }

            if (Number.isFinite(currentIndex)) {
                lastSelectionIndex = currentIndex;
            }
            
            // Update Sidebar-Statistiken
            updateSidebarStats();
            
            // Zeige/Verstecke Bulk-Aktionen
            updateBulkActionsVisibility();
            
            // Filter neu anwenden (falls "Ausgewählt" Filter aktiv)
            if (currentFilter.type === 'selected') {
                applyFilter();
            }
        }
        
        // Update Bulk-Aktionen Sichtbarkeit
        function updateBulkActionsVisibility() {
            const selectedCount = document.querySelectorAll('.gallery-item.selected').length;
            const bulkSection = document.getElementById('bulk-actions-section');
            if (bulkSection) {
                // Falls ältere Versionen inline display gesetzt haben, neutralisieren
                bulkSection.style.display = '';
                bulkSection.classList.toggle('is-hidden', selectedCount === 0);
                bulkSection.setAttribute('aria-hidden', selectedCount === 0 ? 'true' : 'false');
            }

            const clearFlagsBtn = document.getElementById('clear-flags-btn');
            if (clearFlagsBtn) {
                clearFlagsBtn.disabled = selectedCount === 0;
                clearFlagsBtn.setAttribute('aria-disabled', selectedCount === 0 ? 'true' : 'false');
            }

            // Bulk-Flag Buttons (für Auswahl) deaktivieren/aktivieren
            document.querySelectorAll('[data-bulk-flag]').forEach(btn => {
                btn.disabled = selectedCount === 0;
                btn.setAttribute('aria-disabled', selectedCount === 0 ? 'true' : 'false');
            });

            updateSelectionBar(selectedCount);
        }

        let selectionUndoSnapshot = null;
        let selectionUndoTimer = null;
        let lastSelectionIndex = null;

        function showToast(title, message = '', variant = 'info', ttlMs = 2500) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast--${variant}`;
            toast.innerHTML = `<strong>${String(title || '').replace(/</g, '&lt;')}</strong>${message ? `<p>${String(message).replace(/</g, '&lt;')}</p>` : ''}`;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            window.setTimeout(() => {
                toast.classList.remove('show');
                window.setTimeout(() => toast.remove(), 220);
            }, ttlMs);
        }

        let confirmModalState = {
            resolve: null,
            previousFocus: null
        };

        let promptModalState = {
            resolve: null,
            previousFocus: null,
            validate: null,
            normalize: null
        };

        let progressModalState = {
            abortController: null,
            stage: null, // 'fetch' | 'zip'
            cancelled: false
        };

        let choiceModalState = {
            resolve: null,
            previousFocus: null
        };

        function isModalOpen() {
            const confirmEl = document.getElementById('confirm-modal');
            const shortcutsEl = document.getElementById('shortcuts-modal');
            const promptEl = document.getElementById('prompt-modal');
            const progressEl = document.getElementById('progress-modal');
            const choiceEl = document.getElementById('choice-modal');
            const confirmOpen = confirmEl && !confirmEl.classList.contains('is-hidden');
            const shortcutsOpen = shortcutsEl && !shortcutsEl.classList.contains('is-hidden');
            const promptOpen = promptEl && !promptEl.classList.contains('is-hidden');
            const progressOpen = progressEl && !progressEl.classList.contains('is-hidden');
            const choiceOpen = choiceEl && !choiceEl.classList.contains('is-hidden');
            return Boolean(confirmOpen || shortcutsOpen || promptOpen || progressOpen || choiceOpen);
        }

        function closeShortcutsModal() {
            const el = document.getElementById('shortcuts-modal');
            if (!el) return;
            el.classList.add('is-hidden');
            if (!isModalOpen()) document.body.classList.remove('modal-open');
        }

        function openShortcutsModal() {
            const el = document.getElementById('shortcuts-modal');
            if (!el) return;
            el.classList.remove('is-hidden');
            document.body.classList.add('modal-open');
            const closeBtn = document.getElementById('shortcuts-modal-close');
            if (closeBtn) closeBtn.focus();
        }

        function toggleShortcutsModal(force) {
            const el = document.getElementById('shortcuts-modal');
            if (!el) return;
            const shouldOpen = typeof force === 'boolean' ? force : el.classList.contains('is-hidden');
            if (shouldOpen) openShortcutsModal();
            else closeShortcutsModal();
        }

        function closeConfirmModal(result) {
            const el = document.getElementById('confirm-modal');
            if (el) el.classList.add('is-hidden');

            const prev = confirmModalState.previousFocus;
            confirmModalState.previousFocus = null;

            const resolver = confirmModalState.resolve;
            confirmModalState.resolve = null;

            if (!isModalOpen()) document.body.classList.remove('modal-open');
            if (prev && typeof prev.focus === 'function') {
                try { prev.focus(); } catch (_) {}
            }

            if (typeof resolver === 'function') resolver(Boolean(result));
        }

        function closePromptModal(value) {
            const el = document.getElementById('prompt-modal');
            if (el) el.classList.add('is-hidden');

            const prev = promptModalState.previousFocus;
            promptModalState.previousFocus = null;

            const resolver = promptModalState.resolve;
            promptModalState.resolve = null;
            promptModalState.validate = null;
            promptModalState.normalize = null;

            if (!isModalOpen()) document.body.classList.remove('modal-open');
            if (prev && typeof prev.focus === 'function') {
                try { prev.focus(); } catch (_) {}
            }

            if (typeof resolver === 'function') resolver(value);
        }

        function isProgressModalOpen() {
            const el = document.getElementById('progress-modal');
            return Boolean(el && !el.classList.contains('is-hidden'));
        }

        function setProgressModalCancelable(cancelable) {
            const cancelBtn = document.getElementById('progress-modal-cancel');
            const okBtn = document.getElementById('progress-modal-ok');
            if (cancelBtn) cancelBtn.classList.toggle('is-hidden', !cancelable);
            if (okBtn) okBtn.classList.toggle('is-hidden', cancelable);
        }

        function openProgressModal({ title = 'Download', message = 'Bitte warten…', cancelable = true } = {}) {
            const el = document.getElementById('progress-modal');
            const titleEl = document.getElementById('progress-modal-title');
            const msgEl = document.getElementById('progress-modal-message');
            const barEl = document.getElementById('progress-modal-bar');
            const textEl = document.getElementById('progress-modal-text');
            if (!el || !titleEl || !msgEl || !barEl || !textEl) return;

            titleEl.textContent = String(title || 'Download');
            msgEl.textContent = String(message || 'Bitte warten…');
            barEl.style.width = '0%';
            textEl.textContent = '0%';

            setProgressModalCancelable(Boolean(cancelable));
            el.classList.remove('is-hidden');
            document.body.classList.add('modal-open');

            const focusBtn = document.getElementById(cancelable ? 'progress-modal-cancel' : 'progress-modal-ok');
            if (focusBtn) focusBtn.focus();
        }

        function updateProgressModal({ title, message, percent, text } = {}) {
            const titleEl = document.getElementById('progress-modal-title');
            const msgEl = document.getElementById('progress-modal-message');
            const barEl = document.getElementById('progress-modal-bar');
            const textEl = document.getElementById('progress-modal-text');
            if (titleEl && title !== undefined) titleEl.textContent = String(title);
            if (msgEl && message !== undefined) msgEl.textContent = String(message);
            if (barEl && typeof percent === 'number' && Number.isFinite(percent)) {
                const clamped = Math.max(0, Math.min(100, percent));
                barEl.style.width = `${clamped}%`;
            }
            if (textEl && text !== undefined) textEl.textContent = String(text);
        }

        function closeProgressModal() {
            const el = document.getElementById('progress-modal');
            if (el) el.classList.add('is-hidden');
            if (!isModalOpen()) document.body.classList.remove('modal-open');
        }

        function ensureChoiceModal() {
            let el = document.getElementById('choice-modal');
            if (el) return el;

            el = document.createElement('div');
            el.id = 'choice-modal';
            el.className = 'modal-backdrop is-hidden';
            el.setAttribute('role', 'dialog');
            el.setAttribute('aria-modal', 'true');
            el.innerHTML = `
                <div class="modal" role="document">
                    <div class="modal-header">
                        <div class="modal-title" id="choice-modal-title">Aktion</div>
                        <button type="button" class="modal-close" id="choice-modal-close" aria-label="Schließen">×</button>
                    </div>
                    <div class="modal-body">
                        <p class="modal-message" id="choice-modal-message"></p>
                        <div class="modal-actions" id="choice-modal-actions"></div>
                    </div>
                </div>
            `.trim();
            document.body.appendChild(el);

            const closeBtn = el.querySelector('#choice-modal-close');
            if (closeBtn) closeBtn.addEventListener('click', () => closeChoiceModal(null));

            el.addEventListener('click', (e) => {
                if (e.target === el) closeChoiceModal(null);
            });

            el.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeChoiceModal(null);
                }
            });

            return el;
        }

        function closeChoiceModal(value) {
            const el = document.getElementById('choice-modal');
            if (el) el.classList.add('is-hidden');

            const prev = choiceModalState.previousFocus;
            choiceModalState.previousFocus = null;

            const resolver = choiceModalState.resolve;
            choiceModalState.resolve = null;

            if (!isModalOpen()) document.body.classList.remove('modal-open');
            if (prev && typeof prev.focus === 'function') {
                try { prev.focus(); } catch (_) {}
            }

            if (typeof resolver === 'function') resolver(value);
        }

        function choiceAction({ title = 'Aktion', message = '', choices = [] } = {}) {
            const el = ensureChoiceModal();
            const titleEl = el.querySelector('#choice-modal-title');
            const msgEl = el.querySelector('#choice-modal-message');
            const actionsEl = el.querySelector('#choice-modal-actions');
            if (!titleEl || !msgEl || !actionsEl) return Promise.resolve(null);

            if (choiceModalState.resolve) {
                closeChoiceModal(null);
            }

            choiceModalState.previousFocus = document.activeElement;
            titleEl.textContent = String(title || 'Aktion');
            msgEl.textContent = String(message || '');
            actionsEl.innerHTML = '';

            (Array.isArray(choices) ? choices : []).forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = c.primary ? 'btn-primary' : 'btn-secondary';
                if (c.dangerous) btn.classList.add('btn-danger');
                btn.textContent = String(c.label || c.id || 'OK');
                btn.addEventListener('click', () => closeChoiceModal(c.id));
                actionsEl.appendChild(btn);
                if (idx === 0) {
                    // focus first action by default
                    requestAnimationFrame(() => {
                        try { btn.focus(); } catch (_) {}
                    });
                }
            });

            el.classList.remove('is-hidden');
            document.body.classList.add('modal-open');

            return new Promise((resolve) => {
                choiceModalState.resolve = resolve;
            });
        }

        function cancelProgressModal() {
            if (!isProgressModalOpen()) return;
            if (progressModalState.stage === 'zip') {
                showToast('Abbrechen', 'Während ZIP-Erstellung nicht mehr abbrechbar.', 'warning', 3200);
                return;
            }
            progressModalState.cancelled = true;
            if (progressModalState.abortController) {
                try { progressModalState.abortController.abort(); } catch (_) {}
            }
            updateProgressModal({ title: 'Abbrechen…', message: 'Stoppe Downloads…' });
        }

        function confirmAction({
            title = 'Bestätigen',
            message = '',
            confirmText = 'OK',
            cancelText = 'Abbrechen',
            dangerous = false
        } = {}) {
            const el = document.getElementById('confirm-modal');
            const titleEl = document.getElementById('confirm-modal-title');
            const msgEl = document.getElementById('confirm-modal-message');
            const okBtn = document.getElementById('confirm-modal-ok');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            if (!el || !titleEl || !msgEl || !okBtn || !cancelBtn) {
                return Promise.resolve(false);
            }

            if (confirmModalState.resolve) {
                closeConfirmModal(false);
            }

            confirmModalState.previousFocus = document.activeElement;

            titleEl.textContent = String(title || 'Bestätigen');
            msgEl.textContent = String(message || '');
            okBtn.textContent = String(confirmText || 'OK');
            cancelBtn.textContent = String(cancelText || 'Abbrechen');
            const hasCancel = cancelText !== null && cancelText !== undefined && String(cancelText).length > 0;
            cancelBtn.classList.toggle('is-hidden', !hasCancel);
            okBtn.classList.toggle('btn-danger', Boolean(dangerous));

            el.classList.remove('is-hidden');
            document.body.classList.add('modal-open');
            okBtn.focus();

            return new Promise((resolve) => {
                confirmModalState.resolve = resolve;
            });
        }

        function promptAction({
            title = 'Eingabe',
            message = '',
            placeholder = '',
            defaultValue = '',
            okText = 'OK',
            cancelText = 'Abbrechen',
            validate = null,
            normalize = (v) => String(v ?? '').trim(),
            invalidMessage = 'Bitte gültige Eingabe machen.'
        } = {}) {
            const el = document.getElementById('prompt-modal');
            const titleEl = document.getElementById('prompt-modal-title');
            const msgEl = document.getElementById('prompt-modal-message');
            const inputEl = document.getElementById('prompt-modal-input');
            const okBtn = document.getElementById('prompt-modal-ok');
            const cancelBtn = document.getElementById('prompt-modal-cancel');

            if (!el || !titleEl || !msgEl || !inputEl || !okBtn || !cancelBtn) {
                return Promise.resolve(null);
            }

            if (promptModalState.resolve) {
                closePromptModal(null);
            }

            promptModalState.previousFocus = document.activeElement;
            promptModalState.validate = typeof validate === 'function' ? validate : null;
            promptModalState.normalize = typeof normalize === 'function' ? normalize : null;

            titleEl.textContent = String(title || 'Eingabe');
            msgEl.textContent = String(message || '');
            inputEl.placeholder = String(placeholder || '');
            inputEl.value = String(defaultValue ?? '');
            okBtn.textContent = String(okText || 'OK');
            cancelBtn.textContent = String(cancelText || 'Abbrechen');

            el.classList.remove('is-hidden');
            document.body.classList.add('modal-open');

            requestAnimationFrame(() => {
                try {
                    inputEl.focus();
                    inputEl.select();
                } catch (_) {}
            });

            return new Promise((resolve) => {
                promptModalState.resolve = resolve;

                const tryOk = () => {
                    const raw = inputEl.value;
                    const normalized = promptModalState.normalize ? promptModalState.normalize(raw) : String(raw ?? '').trim();
                    if (promptModalState.validate && !promptModalState.validate(normalized)) {
                        showToast('Eingabe', String(invalidMessage || 'Ungültig.'), 'warning', 3200);
                        try { inputEl.focus(); } catch (_) {}
                        return;
                    }
                    closePromptModal(normalized);
                };

                // Replace any existing handlers
                okBtn.onclick = (e) => {
                    e.preventDefault();
                    tryOk();
                };
                cancelBtn.onclick = (e) => {
                    e.preventDefault();
                    closePromptModal(null);
                };
            });
        }

        function initOverlays() {
            const confirmEl = document.getElementById('confirm-modal');
            const confirmClose = document.getElementById('confirm-modal-close');
            const confirmCancel = document.getElementById('confirm-modal-cancel');
            const confirmOk = document.getElementById('confirm-modal-ok');

            if (confirmClose) confirmClose.addEventListener('click', () => closeConfirmModal(false));
            if (confirmCancel) confirmCancel.addEventListener('click', () => closeConfirmModal(false));
            if (confirmOk) confirmOk.addEventListener('click', () => closeConfirmModal(true));
            if (confirmEl) {
                confirmEl.addEventListener('click', (e) => {
                    if (e.target === confirmEl) closeConfirmModal(false);
                });
                confirmEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closeConfirmModal(false);
                    }
                    if (e.key === 'Enter') {
                        const cancelBtn = document.getElementById('confirm-modal-cancel');
                        const hasCancel = cancelBtn && !cancelBtn.classList.contains('is-hidden');
                        if (!hasCancel) {
                            e.preventDefault();
                            closeConfirmModal(true);
                        }
                    }
                });
            }

            const shortcutsEl = document.getElementById('shortcuts-modal');
            const shortcutsClose = document.getElementById('shortcuts-modal-close');
            if (shortcutsClose) shortcutsClose.addEventListener('click', () => closeShortcutsModal());
            if (shortcutsEl) {
                shortcutsEl.addEventListener('click', (e) => {
                    if (e.target === shortcutsEl) closeShortcutsModal();
                });
            }

            const helpBtn = document.getElementById('shortcuts-help-btn');
            if (helpBtn) helpBtn.addEventListener('click', () => toggleShortcutsModal(true));

            const promptEl = document.getElementById('prompt-modal');
            const promptClose = document.getElementById('prompt-modal-close');
            const promptCancel = document.getElementById('prompt-modal-cancel');
            const promptOk = document.getElementById('prompt-modal-ok');
            const promptInput = document.getElementById('prompt-modal-input');

            if (promptClose) promptClose.addEventListener('click', () => closePromptModal(null));
            if (promptCancel) promptCancel.addEventListener('click', () => closePromptModal(null));
            if (promptEl) {
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) closePromptModal(null);
                });
                promptEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closePromptModal(null);
                        return;
                    }
                    if (e.key === 'Enter') {
                        if (document.activeElement === promptInput) {
                            e.preventDefault();
                            if (promptOk) promptOk.click();
                        }
                    }
                });
            }

            const progressEl = document.getElementById('progress-modal');
            const progressClose = document.getElementById('progress-modal-close');
            const progressCancel = document.getElementById('progress-modal-cancel');
            const progressOk = document.getElementById('progress-modal-ok');
            if (progressClose) progressClose.addEventListener('click', () => cancelProgressModal());
            if (progressCancel) progressCancel.addEventListener('click', () => cancelProgressModal());
            if (progressOk) progressOk.addEventListener('click', () => closeProgressModal());
            if (progressEl) {
                progressEl.addEventListener('click', (e) => {
                    if (e.target === progressEl) cancelProgressModal();
                });
                progressEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelProgressModal();
                    }
                });
            }
        }

        function getSelectedItems() {
            return Array.from(document.querySelectorAll('.gallery-item.selected'));
        }

        function setGalleryItemSelected(item, selected) {
            if (!item) return;
            item.classList.toggle('selected', Boolean(selected));
            const imageId = item.dataset.imageId;
            if (imageId) {
                if (selected) selectedImageIds.add(imageId);
                else selectedImageIds.delete(imageId);
            }
            const checkbox = item.querySelector('.gallery-item-checkbox');
            if (checkbox) {
                checkbox.classList.toggle('checked', Boolean(selected));
                checkbox.textContent = selected ? '✓' : '';
            }
        }

        function selectAllVisible() {
            const items = getBulkTargetItems('visible');
            if (items.length === 0) {
                showToast('Keine Bilder', 'Nichts sichtbar zum Auswählen.', 'warning');
                return;
            }
            items.forEach(item => setGalleryItemSelected(item, true));
            updateBulkActionsVisibility();
            updateSidebarStats();
            showToast('Auswahl', `${items.length} sichtbar ausgewählt`, 'success');
        }

        function hasSelectionUndo() {
            return Boolean(selectionUndoSnapshot && Array.isArray(selectionUndoSnapshot.imageIds) && selectionUndoSnapshot.imageIds.length > 0);
        }

        function setSelectionUndo(imageIds) {
            if (!Array.isArray(imageIds) || imageIds.length === 0) return;
            selectionUndoSnapshot = { imageIds: Array.from(new Set(imageIds)), createdAt: Date.now() };

            if (selectionUndoTimer) window.clearTimeout(selectionUndoTimer);
            selectionUndoTimer = window.setTimeout(() => {
                clearSelectionUndo();
                updateSelectionBar();
            }, 20000);

            updateSelectionBar();
        }

        function clearSelectionUndo() {
            selectionUndoSnapshot = null;
            if (selectionUndoTimer) {
                window.clearTimeout(selectionUndoTimer);
                selectionUndoTimer = null;
            }
            const undoBtn = document.getElementById('selection-bar-undo');
            if (undoBtn) undoBtn.classList.add('is-hidden');
        }

        function restoreSelectionUndo() {
            if (!hasSelectionUndo()) return;
            const ids = selectionUndoSnapshot.imageIds;

            window.__selectionUndoRestoring = true;
            try {
                ids.forEach(imageId => {
                    const item = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (!item) return;
                    setGalleryItemSelected(item, true);
                });
            } finally {
                window.__selectionUndoRestoring = false;
            }

            clearSelectionUndo();
            updateBulkActionsVisibility();
            updateSidebarStats();
        }

        function updateSelectionBar(selectedCount = null) {
            const count = (selectedCount === null || selectedCount === undefined)
                ? document.querySelectorAll('.gallery-item.selected').length
                : Number(selectedCount);

            const bar = document.getElementById('selection-bar');
            const countEl = document.getElementById('selection-bar-count');
            if (!bar || !countEl) return;

            countEl.textContent = `${count} ausgewählt`;

            const undoBtn = document.getElementById('selection-bar-undo');
            if (undoBtn) undoBtn.classList.toggle('is-hidden', !hasSelectionUndo());

            const resetBtn = document.getElementById('selection-bar-reset');
            const exportBtn = document.getElementById('selection-bar-export');
            const compareBtn = document.getElementById('selection-bar-compare');
            const downloadBtn = document.getElementById('selection-bar-download');
            const favoriteBtn = document.getElementById('selection-bar-favorite');
            const addSelectionBtn = document.getElementById('selection-bar-add-selection');

            const disableActions = count === 0;
            [resetBtn, exportBtn, downloadBtn, favoriteBtn, addSelectionBtn].forEach(btn => {
                if (!btn) return;
                btn.disabled = disableActions;
                btn.setAttribute('aria-disabled', disableActions ? 'true' : 'false');
            });

            if (compareBtn) {
                const ok = count >= 2 && count <= 4;
                compareBtn.disabled = !ok;
                compareBtn.setAttribute('aria-disabled', ok ? 'false' : 'true');
            }

            const galleryContainer = document.getElementById('gallery-container');
            const galleryVisible = galleryContainer && galleryContainer.style.display !== 'none';
            const shouldShow = (count > 0 || hasSelectionUndo()) && galleryVisible;

            bar.classList.toggle('is-hidden', !shouldShow);
            document.body.classList.toggle('has-selection-bar', shouldShow);
        }

        function exportSelectedList() {
            const selectedItems = Array.from(document.querySelectorAll('.gallery-item.selected'));
            if (selectedItems.length === 0) {
                showToast('Keine Auswahl', 'Bitte erst Bilder auswählen.', 'warning');
                return 0;
            }

            const items = selectedItems
                .map(item => item.dataset.imageId)
                .filter(Boolean)
                .map(imageId => {
                    const imageIndex = findImageIndexByFeedbackId(imageId);
                    const image = currentImages?.[imageIndex];
                    if (!image) return null;

                    const imageUrl = image.url || `./images/${image.name}`;
                    let downloadUrl = imageUrl;
                    if (imageUrl.includes('res.cloudinary.com') && imageUrl.includes('/upload/')) {
                        downloadUrl = imageUrl.replace(/\/upload\/[^\/]+\//, '/upload/');
                    }

                    return {
                        id: imageId,
                        name: image.name || `image_${imageIndex}`,
                        url: downloadUrl
                    };
                })
                .filter(Boolean);

            const payload = {
                exportedAt: new Date().toISOString(),
                gallery: currentGallery?.name || null,
                count: items.length,
                items
            };

            const date = new Date().toISOString().split('T')[0];
            downloadJsonFile(`selection-export-${date}.json`, payload);

            showToast('Export erstellt', `${items.length} Bild(er) als JSON exportiert.`, 'success');
            return items.length;
        }

        function getImageIdsForSelectionName(selectionName) {
            const name = String(selectionName || '').trim();
            if (!name) return [];
            const result = [];
            (currentImagesOriginal || []).forEach((img, index) => {
                const imageId = getFeedbackImageId(img, index);
                if (!imageId) return;
                const selections = feedbackData.selections[imageId] || [];
                if (Array.isArray(selections) && selections.includes(name)) {
                    result.push(imageId);
                }
            });
            return result;
        }

        function exportSelectionByName(selectionName) {
            const name = String(selectionName || '').trim();
            if (!name) {
                showToast('Export', 'Ungültiger Auswahl-Name.', 'warning');
                return 0;
            }

            const imageIds = getImageIdsForSelectionName(name);
            if (imageIds.length === 0) {
                showToast('Export', `Keine Bilder in „${name}“.`, 'warning');
                return 0;
            }

            const items = imageIds
                .map((imageId) => {
                    const imageIndex = findImageIndexByFeedbackId(imageId);
                    const image = currentImages?.[imageIndex];
                    if (!image) return null;

                    const imageUrl = image.url || `./images/${image.name}`;
                    let downloadUrl = imageUrl;
                    if (imageUrl.includes('res.cloudinary.com') && imageUrl.includes('/upload/')) {
                        downloadUrl = imageUrl.replace(/\/upload\/[^\/]+\//, '/upload/');
                    }

                    return {
                        id: imageId,
                        name: image.name || `image_${imageIndex}`,
                        url: downloadUrl
                    };
                })
                .filter(Boolean);

            const payload = {
                exportedAt: new Date().toISOString(),
                gallery: currentGallery?.name || null,
                selection: name,
                count: items.length,
                items
            };

            const date = new Date().toISOString().split('T')[0];
            downloadJsonFile(`selection-${name.replace(/[^a-z0-9_-]+/gi, '_')}-${date}.json`, payload);
            showToast('Export erstellt', `„${name}“: ${items.length} Bild(er) als JSON.`, 'success');
            return items.length;
        }

        async function downloadSelectionZipByName(selectionName) {
            const name = String(selectionName || '').trim();
            if (!name) {
                showToast('Download', 'Ungültiger Auswahl-Name.', 'warning');
                return;
            }

            const imageIds = getImageIdsForSelectionName(name);
            if (imageIds.length === 0) {
                showToast('Download', `Keine Bilder in „${name}“.`, 'warning');
                return;
            }

            // Temporär Auswahl setzen, Download starten, danach Auswahl wiederherstellen
            const prevSelected = new Set(selectedImageIds || []);
            const idSet = new Set(imageIds);

            try {
                document.querySelectorAll('.gallery-item').forEach(item => {
                    const id = item.dataset.imageId;
                    if (!id) return;
                    setGalleryItemSelected(item, idSet.has(id));
                });
                updateBulkActionsVisibility();
                updateSidebarStats();

                await bulkDownload({
                    confirmTitle: 'Download',
                    confirmMessage: `Auswahl „${name}“ (${imageIds.length} Bild(er)) als ZIP herunterladen?`,
                    confirmText: 'Download'
                });
            } finally {
                selectedImageIds = new Set(prevSelected);
                document.querySelectorAll('.gallery-item').forEach(item => {
                    const id = item.dataset.imageId;
                    if (!id) return;
                    setGalleryItemSelected(item, prevSelected.has(id));
                });
                updateBulkActionsVisibility();
                updateSidebarStats();
            }
        }

        function downloadJsonFile(fileName, payload) {
            try {
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = String(fileName || 'export.json');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                return true;
            } catch (e) {
                console.error('JSON Export fehlgeschlagen:', e);
                return false;
            }
        }

        function initSelectionBar() {
            const resetBtn = document.getElementById('selection-bar-reset');
            const exportBtn = document.getElementById('selection-bar-export');
            const compareBtn = document.getElementById('selection-bar-compare');
            const downloadBtn = document.getElementById('selection-bar-download');
            const favoriteBtn = document.getElementById('selection-bar-favorite');
            const addSelectionBtn = document.getElementById('selection-bar-add-selection');
            const undoBtn = document.getElementById('selection-bar-undo');

            if (resetBtn) resetBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.gallery-item.selected'))
                    .map(el => el.dataset.imageId)
                    .filter(Boolean);
                if (selectedIds.length === 0) {
                    showToast('Keine Auswahl', 'Nichts zum Zurücksetzen.', 'warning');
                    return;
                }
                setSelectionUndo(selectedIds);
                clearSelection();
                showToast('Auswahl aufgehoben', 'Undo ist kurz verfügbar.', 'warning', 3200);
            });
            if (exportBtn) exportBtn.addEventListener('click', () => exportSelectedList());
            if (compareBtn) compareBtn.addEventListener('click', () => openCompareView());
            if (downloadBtn) downloadBtn.addEventListener('click', () => {
                const count = document.querySelectorAll('.gallery-item.selected').length;
                if (count === 0) {
                    showToast('Keine Auswahl', 'Nichts zum Download.', 'warning');
                    return;
                }
                Promise.resolve(bulkDownload()).catch(err => console.error(err));
            });
            if (favoriteBtn) favoriteBtn.addEventListener('click', () => {
                const changed = bulkAddToFavorites();
                if (!changed) {
                    showToast('Keine Auswahl', 'Bitte erst Bilder auswählen.', 'warning');
                    return;
                }
                showToast('Favoriten gesetzt', `${changed} Bild(er) markiert.`, 'success');
            });
            if (addSelectionBtn) addSelectionBtn.addEventListener('click', () => {
                Promise.resolve(bulkAddToSelection()).then((result) => {
                    if (!result) return;
                    showToast('Zur Auswahl hinzugefügt', `${result.count} Bild(er) → „${result.name}“`, 'success');
                }).catch(err => console.error(err));
            });
            if (undoBtn) undoBtn.addEventListener('click', () => {
                if (!hasSelectionUndo()) return;
                restoreSelectionUndo();
                showToast('Undo', 'Auswahl wiederhergestellt.', 'success');
            });

            updateSelectionBar();
        }
        
        // Bulk-Aktionen
        function initBulkActionButtons() {
            document.querySelectorAll('[data-bulk-action]').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const action = button.dataset.bulkAction;
                    const scope = button.dataset.bulkScope || 'selected';

                    switch (action) {
                        case 'favorites':
                            bulkAddToFavorites();
                            break;
                        case 'clear-flag':
                            void bulkClearFlag(scope);
                            break;
                        case 'add-selection':
                            bulkAddToSelection();
                            break;
                        case 'download':
                            void bulkDownload();
                            break;
                        case 'export-pdf':
                            void exportAsPDF();
                            break;
                        case 'clear-selection':
                            clearSelection();
                            break;
                        case 'clear-favorites':
                            void bulkClearFavorites(scope);
                            break;
                        case 'clear-ratings':
                            void bulkClearRatings(scope);
                            break;
                        case 'clear-comments':
                            void bulkClearComments(scope);
                            break;
                        case 'clear-selections':
                            void bulkClearSelections(scope);
                            break;
                        case 'reset-feedback':
                            void bulkResetFeedback(scope);
                            break;
                        default:
                            break;
                    }
                });
            });

            document.querySelectorAll('[data-bulk-flag]').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const flag = button.dataset.bulkFlag;
                    if (!flag) return;
                    bulkApplyFlag(flag, 'selected');
                });
            });
        }

        function getBulkTargetItems(scope = 'selected') {
            const items = Array.from(document.querySelectorAll('.gallery-item'));
            if (scope === 'visible') {
                return items.filter(item => item.style.display !== 'none');
            }
            // Default: selected
            return items.filter(item => item.classList.contains('selected'));
        }

        function getBulkTargetImageIds(scope = 'selected') {
            if (scope === 'gallery') {
                return currentImages
                    .map((img, idx) => getFeedbackImageId(img, idx))
                    .filter(Boolean);
            }
            const targets = getBulkTargetItems(scope);
            return targets
                .map(item => item.dataset.imageId)
                .filter(Boolean);
        }

        async function confirmBulkReset(scope, whatLabel) {
            if (scope !== 'gallery') return true;
            const galleryName = currentGallery?.name || 'diese Galerie';
            return await confirmAction({
                title: 'Achtung',
                message: `ACHTUNG: ${whatLabel} in "${galleryName}" löschen?\n\nDas kann nicht rückgängig gemacht werden.`,
                confirmText: 'Löschen',
                cancelText: 'Abbrechen',
                dangerous: true
            });
        }

        function refreshGalleryAfterBulkChange(affectedImageIds = null) {
            // Badges (Flags, Selections, Ratings)
            updateAllImageBadges();

            // Likes + Kommentarzähler in Gallery aktualisieren (falls betroffen)
            const ids = Array.isArray(affectedImageIds)
                ? affectedImageIds
                : Array.from(document.querySelectorAll('.gallery-item')).map(el => el.dataset.imageId).filter(Boolean);

            ids.forEach(imageId => {
                // Favorit-Button
                updateFavoriteUI(imageId);

                // Kommentarzähler
                const item = document.querySelector(`[data-image-id="${imageId}"]`);
                if (!item) return;
                const commentBtn = item.querySelector('.gallery-item-actions .gallery-item-btn:last-child');
                if (!commentBtn) return;
                const count = (feedbackData.comments[imageId] || []).length;
                commentBtn.innerHTML = `<span class="btn-label">Komm.</span> <span class="btn-count">${count}</span>`;
            });

            updateSidebarStats();
            applyFilter();

            // Falls Lightbox offen: Sidebar neu rendern
            const lightbox = document.getElementById('lightbox');
            if (lightbox && lightbox.classList.contains('active')) {
                updateFeedbackSidebar();
            }
        }

        function bulkApplyFlag(flag, scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Auswahl', scope === 'visible' ? 'Keine sichtbaren Bilder.' : 'Keine Bilder ausgewählt.', 'warning');
                return;
            }

            imageIds.forEach(imageId => {
                feedbackData.flags[imageId] = flag;
            });

            saveFeedbackData();
            updateAllImageBadges();
            updateSidebarStats();

            // Filter neu anwenden (Flags können Sichtbarkeit ändern)
            applyFilter();
        }

        function bulkAddToFavorites() {
            const selected = document.querySelectorAll('.gallery-item.selected');
            if (selected.length === 0) return 0;
            selected.forEach(item => {
                const imageId = item.dataset.imageId;
                if (imageId) {
                    feedbackData.favorites[imageId] = true;
                    updateFavoriteUI(imageId);
                }
            });
            saveFeedbackData();
            updateAllImageBadges();
            updateSidebarStats();
            return selected.length;
        }
        
        async function bulkSetFlag() {
            // Legacy (wird nicht mehr von UI verwendet): belassen für Abwärtskompatibilität
            const flag = await promptAction({
                title: 'Markierung',
                message: 'Markierung wählen:\n1 = Abgelehnt\n2 = Prüfen\n3 = Genehmigt\n4 = Final',
                placeholder: '1-4',
                defaultValue: '3',
                okText: 'Setzen',
                cancelText: 'Abbrechen',
                validate: (v) => ['1', '2', '3', '4'].includes(String(v)),
                invalidMessage: 'Bitte 1–4 eingeben.'
            });
            if (!flag) return;

            const flagMap = { '1': 'reject', '2': 'review', '3': 'approve', '4': 'final' };
            const selectedFlag = flagMap[flag];
            if (!selectedFlag) return;

            bulkApplyFlag(selectedFlag, 'selected');
        }

        async function bulkClearFlag(scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Auswahl', scope === 'visible' ? 'Keine sichtbaren Bilder.' : 'Keine Bilder ausgewählt.', 'warning');
                return;
            }

            if (scope === 'gallery') {
                if (!await confirmBulkReset(scope, 'Markierungen')) return;
            } else {
                const label = scope === 'visible' ? 'sichtbaren' : 'ausgewählten';
                const ok = await confirmAction({
                    title: 'Markierungen entfernen',
                    message: `Markierungen von ${imageIds.length} ${label} Bild(er)n entfernen?`,
                    confirmText: 'Entfernen',
                    cancelText: 'Abbrechen',
                    dangerous: true
                });
                if (!ok) return;
            }

            imageIds.forEach(imageId => {
                delete feedbackData.flags[imageId];
            });

            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }

        async function bulkClearFavorites(scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Bilder', 'Keine Bilder gefunden.', 'warning');
                return;
            }
            if (!await confirmBulkReset(scope, 'Favoriten')) return;

            imageIds.forEach(imageId => {
                delete feedbackData.favorites[imageId];
            });
            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }

        async function bulkClearRatings(scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Bilder', 'Keine Bilder gefunden.', 'warning');
                return;
            }
            if (!await confirmBulkReset(scope, 'Bewertungen')) return;

            imageIds.forEach(imageId => {
                delete feedbackData.ratings[imageId];
            });
            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }

        async function bulkClearComments(scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Bilder', 'Keine Bilder gefunden.', 'warning');
                return;
            }
            if (!await confirmBulkReset(scope, 'Kommentare')) return;

            imageIds.forEach(imageId => {
                delete feedbackData.comments[imageId];
            });
            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }

        async function bulkClearSelections(scope = 'selected') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Bilder', 'Keine Bilder gefunden.', 'warning');
                return;
            }
            if (!await confirmBulkReset(scope, 'Auswahlen')) return;

            imageIds.forEach(imageId => {
                delete feedbackData.selections[imageId];
            });
            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }

        async function bulkResetFeedback(scope = 'gallery') {
            const imageIds = getBulkTargetImageIds(scope);
            if (imageIds.length === 0) {
                showToast('Keine Bilder', 'Keine Bilder gefunden.', 'warning');
                return;
            }
            if (!await confirmBulkReset(scope, 'ALLES Feedback')) return;

            imageIds.forEach(imageId => {
                delete feedbackData.flags[imageId];
                delete feedbackData.favorites[imageId];
                delete feedbackData.ratings[imageId];
                delete feedbackData.comments[imageId];
                delete feedbackData.selections[imageId];
            });

            saveFeedbackData();
            refreshGalleryAfterBulkChange(imageIds);
        }
        
        async function bulkAddToSelection() {
            const selected = document.querySelectorAll('.gallery-item.selected');
            if (selected.length === 0) {
                showToast('Keine Auswahl', 'Bitte erst Bilder auswählen.', 'warning');
                return null;
            }

            const selectionName = await promptAction({
                title: 'Zur Auswahl hinzufügen',
                message: `Auswahl-Name eingeben (für ${selected.length} Bild(er))`,
                placeholder: 'z.B. "Finale Auswahl"',
                defaultValue: '',
                okText: 'Hinzufügen',
                cancelText: 'Abbrechen',
                validate: (v) => String(v).trim().length > 0,
                invalidMessage: 'Bitte einen Auswahl-Namen eingeben.'
            });
            if (!selectionName) return null;

            const trimmed = String(selectionName).trim();
            let changed = 0;
            selected.forEach(item => {
                const imageId = item.dataset.imageId;
                if (imageId) {
                    if (!feedbackData.selections[imageId]) {
                        feedbackData.selections[imageId] = [];
                    }
                    if (!feedbackData.selections[imageId].includes(trimmed)) {
                        feedbackData.selections[imageId].push(trimmed);
                        changed++;
                    }
                }
            });
            saveFeedbackData();
            updateAllImageBadges();
            updateSidebarStats();

            return { name: trimmed, count: changed };
        }
        
        function clearSelection() {
            // Fast path: clear Set first, then update DOM
            selectedImageIds = new Set();
            document.querySelectorAll('.gallery-item.selected').forEach(item => {
                setGalleryItemSelected(item, false);
            });
            lastSelectionIndex = null;
            updateBulkActionsVisibility();
            updateSidebarStats();
        }
        
        // Export als ZIP (mit JSZip)
        async function bulkDownload(options = {}) {
            const selected = document.querySelectorAll('.gallery-item.selected');
            if (selected.length === 0) {
                showToast('Keine Auswahl', 'Bitte erst Bilder auswählen.', 'warning');
                return;
            }

            const opts = options && typeof options === 'object' ? options : {};
            const confirmTitle = String(opts.confirmTitle || 'Download');
            const confirmMessage = String(opts.confirmMessage || `${selected.length} Bild(er) als ZIP herunterladen?`);
            const confirmText = String(opts.confirmText || 'Download');

            const ok = await confirmAction({
                title: confirmTitle,
                message: confirmMessage,
                confirmText,
                cancelText: 'Abbrechen'
            });
            if (!ok) return;

            progressModalState.abortController = new AbortController();
            progressModalState.stage = 'fetch';
            progressModalState.cancelled = false;

            openProgressModal({
                title: 'Download',
                message: `Lade ${selected.length} Bild(er)…`,
                cancelable: true
            });
            
            // Lade JSZip dynamisch
            if (!window.JSZip) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            const zip = new JSZip();

            const workItems = [];
            for (const item of selected) {
                const imageId = item.dataset.imageId;
                if (!imageId) continue;

                const imageIndex = findImageIndexByFeedbackId(imageId);
                const image = currentImages[imageIndex];
                if (!image) continue;

                const imageUrl = image.url || `./images/${image.name}`;
                let downloadUrl = imageUrl;

                // Für Cloudinary: Entferne Transformationen
                if (imageUrl.includes('res.cloudinary.com') && imageUrl.includes('/upload/')) {
                    downloadUrl = imageUrl.replace(/\/upload\/[^\/]+\//, '/upload/');
                }

                const fileName = image.name || `image_${imageIndex}.jpg`;
                workItems.push({ imageId, imageIndex, image, downloadUrl, fileName });
            }

            if (workItems.length === 0) {
                closeProgressModal();
                showToast('Keine Bilder', 'Keine gültigen Bilder zum Download gefunden.', 'warning');
                return;
            }

            const fetchAndAdd = async (wi, signal) => {
                const response = await fetch(wi.downloadUrl, { signal });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const blob = await response.blob();
                zip.file(wi.fileName, blob);
            };

            const processItems = async (items, label) => {
                let done = 0;
                const failed = [];

                updateProgressModal({
                    title: 'Download',
                    message: `${label}…`,
                    percent: 0,
                    text: `0 / ${items.length}`
                });

                for (const wi of items) {
                    if (progressModalState.cancelled) break;

                    try {
                        await fetchAndAdd(wi, progressModalState.abortController?.signal);
                    } catch (error) {
                        if (error && (error.name === 'AbortError' || String(error).includes('AbortError'))) {
                            progressModalState.cancelled = true;
                            break;
                        }
                        failed.push({ wi, error });
                    } finally {
                        done++;
                        const progress = (done / items.length) * 100;
                        updateProgressModal({
                            title: 'Download',
                            message: `${label}…`,
                            percent: progress,
                            text: `${done} / ${items.length}`
                        });
                    }
                }

                return { done, failed };
            };
            
            try {
                const firstPass = await processItems(workItems, `Lade ${workItems.length} Bild(er)`);

                if (progressModalState.cancelled) {
                    closeProgressModal();
                    showToast('Download abgebrochen', 'Der Download wurde abgebrochen.', 'warning', 3200);
                    return;
                }

                let failed = firstPass.failed;

                if (failed.length > 0) {
                    closeProgressModal();
                    const exportFailures = () => {
                        const payload = {
                            exportedAt: new Date().toISOString(),
                            gallery: currentGallery?.name || null,
                            attempted: workItems.length,
                            failed: failed.length,
                            items: failed.map(f => ({
                                fileName: f.wi?.fileName || null,
                                url: f.wi?.downloadUrl || null,
                                error: String(f.error?.message || f.error || 'Unbekannt')
                            }))
                        };
                        const date = new Date().toISOString().split('T')[0];
                        const ok = downloadJsonFile(`download-failures-${date}.json`, payload);
                        showToast('Fehlerliste', ok ? 'Als JSON exportiert.' : 'Export fehlgeschlagen.', ok ? 'success' : 'danger', 3200);
                    };

                    let choice = null;
                    while (true) {
                        choice = await choiceAction({
                            title: 'Einige Bilder fehlgeschlagen',
                            message: `${failed.length} von ${workItems.length} Bild(er)n konnten nicht geladen werden.\n\nWas möchtest du tun?`,
                            choices: [
                                { id: 'retry', label: 'Retry', primary: true },
                                { id: 'continue', label: 'Weiter ohne', primary: false },
                                { id: 'export', label: 'Fehler exportieren', primary: false },
                                { id: 'abort', label: 'Abbrechen', dangerous: true }
                            ]
                        });

                        if (choice === 'export') {
                            exportFailures();
                            continue;
                        }
                        break;
                    }

                    if (choice === 'abort' || choice === null) {
                        showToast('Abgebrochen', 'ZIP-Download wurde abgebrochen.', 'warning', 3200);
                        return;
                    }

                    if (choice === 'retry') {
                        // retry only failed items
                        progressModalState.abortController = new AbortController();
                        progressModalState.stage = 'fetch';
                        progressModalState.cancelled = false;
                        openProgressModal({
                            title: 'Retry',
                            message: `Versuche ${failed.length} Bild(er) erneut…`,
                            cancelable: true
                        });

                        const retryItems = failed.map(f => f.wi);
                        const retryPass = await processItems(retryItems, `Retry ${retryItems.length} Bild(er)`);

                        if (progressModalState.cancelled) {
                            closeProgressModal();
                            showToast('Retry abgebrochen', 'Der Retry wurde abgebrochen.', 'warning', 3200);
                            return;
                        }

                        failed = retryPass.failed;
                        closeProgressModal();
                    }

                    if (failed.length > 0) {
                        const examples = failed.slice(0, 4).map(f => f.wi?.fileName).filter(Boolean);
                        showToast(
                            'Übersprungen',
                            `${failed.length} Bild(er) konnten nicht geladen werden${examples.length ? ` (z.B. ${examples.join(', ')})` : ''}.`,
                            'warning',
                            4200
                        );
                    }

                    // reopen progress modal for zip stage
                    openProgressModal({ title: 'ZIP', message: 'Erstelle ZIP…', cancelable: false });
                }

                // ZIP stage (not cancellable)
                progressModalState.stage = 'zip';
                setProgressModalCancelable(false);
                updateProgressModal({
                    title: 'ZIP',
                    message: 'Erstelle ZIP…',
                    percent: 0,
                    text: '0%'
                });
                
                // Erstelle ZIP
                const zipBlob = await zip.generateAsync(
                    { type: 'blob' },
                    (metadata) => {
                        const pct = Number(metadata?.percent);
                        if (Number.isFinite(pct)) {
                            updateProgressModal({
                                percent: pct,
                                text: `${Math.round(pct)}%`
                            });
                        }
                    }
                );
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `galerie-export-${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                closeProgressModal();
                const totalOk = workItems.length - (failed?.length || 0);
                showToast('Download fertig', `${totalOk} Bild(er) als ZIP heruntergeladen.`, 'success', 3200);
            } catch (error) {
                closeProgressModal();
                showToast('Download fehlgeschlagen', String(error?.message || error || 'Unbekannter Fehler'), 'danger', 4500);
            } finally {
                progressModalState.abortController = null;
                progressModalState.stage = null;
                progressModalState.cancelled = false;
            }
        }
        
        // Export als PDF (einfache Version)
        async function exportAsPDF() {
            const selected = document.querySelectorAll('.gallery-item.selected');
            if (selected.length === 0) {
                showToast('Keine Auswahl', 'Bitte erst Bilder auswählen.', 'warning');
                return;
            }

            await confirmAction({
                title: 'PDF-Export',
                message: 'PDF-Export ist aktuell noch nicht implementiert.\n\nHinweis: Für vollständigen PDF-Export wird eine externe Bibliothek benötigt. Aktuell können Sie die Bilder als ZIP herunterladen.',
                confirmText: 'OK',
                cancelText: null
            });
            // TODO: PDF-Export mit jsPDF implementieren
        }
        
        // Toggle Favorit
        // Toggle Favorit (für Sidebar)
        function toggleFavorite() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            if (feedbackData.favorites[imageId]) {
                delete feedbackData.favorites[imageId];
            } else {
                feedbackData.favorites[imageId] = true;
            }
            saveFeedbackData();
            updateFavoriteUI(imageId);
            updateAllImageBadges();
        }
        
        // Toggle Favorit (für Gallery Item)
        function toggleFavoriteFromGallery(imageId) {
            if (feedbackData.favorites[imageId]) {
                delete feedbackData.favorites[imageId];
            } else {
                feedbackData.favorites[imageId] = true;
            }
            saveFeedbackData();
            updateFavoriteUI(imageId);
            updateAllImageBadges();
            updateSidebarStats();
            
            // Filter neu anwenden (falls "Favoriten" Filter aktiv)
            if (currentFilter.type === 'favorites') {
                applyFilter();
            }
        }
        
        // Update Favorit-UI
        function updateFavoriteUI(imageId) {
            const isFavorite = feedbackData.favorites[imageId] || false;
            
            // Update in Gallery
            const item = document.querySelector(`[data-image-id="${imageId}"]`);
            if (item) {
                const likeBtn = item.querySelector('.gallery-item-like');
                if (likeBtn) {
                    likeBtn.innerHTML = `<span class="btn-label">Favorit</span> <span class="btn-count">${isFavorite ? 'Ja' : 'Nein'}</span>`;
                    likeBtn.classList.toggle('active', isFavorite);
                }
            }
            
            // Update in Sidebar
            const favoriteBtn = document.getElementById('favorite-btn');
            const favoriteText = document.getElementById('favorite-text');
            if (favoriteBtn && favoriteText) {
                favoriteText.textContent = isFavorite ? 'Als Favorit entfernen' : 'Als Favorit markieren';
                favoriteBtn.classList.toggle('active', isFavorite);
            }
        }
        
        // Update Feedback-Sidebar
        function updateFeedbackSidebar() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            
            // Bild-Name
            document.getElementById('feedback-image-name').textContent = image.name || 'Bild Feedback';
            
            // Bild-Info
            updateImageInfo(image);
            
            // Bewertung
            const rating = feedbackData.ratings[imageId] || 0;
            updateRatingStars(rating);
            
            // Markierung
            const flag = feedbackData.flags[imageId] || null;
            updateFlagButtons(flag);
            
            // Favorit
            updateFavoriteUI(imageId);
            
            // Kommentare
            displayComments(imageId);
            
            // Auswahlen
            displaySelections(imageId);
        }
        
        // Update Bild-Informationen
        function updateImageInfo(image) {
            if (!image) return;
            
            document.getElementById('info-name').textContent = image.name || '-';
            
            // Größe
            if (image.width && image.height) {
                const mp = ((image.width * image.height) / 1000000).toFixed(1);
                document.getElementById('info-size').textContent = `${mp} MP`;
            } else {
                document.getElementById('info-size').textContent = '-';
            }
            
            // Auflösung
            if (image.width && image.height) {
                document.getElementById('info-resolution').textContent = `${image.width} × ${image.height}`;
            } else {
                document.getElementById('info-resolution').textContent = '-';
            }
            
            // Upload-Datum
            if (image.uploadDate) {
                const date = new Date(image.uploadDate);
                document.getElementById('info-upload').textContent = date.toLocaleDateString('de-CH') + ' ' + date.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
            } else {
                document.getElementById('info-upload').textContent = '-';
            }
            
            // Quelle
            const sourceLabels = {
                'cloudinary': 'Cloudinary',
                'github': 'GitHub',
                'local': 'Lokal'
            };
            document.getElementById('info-source').textContent = sourceLabels[image.source] || image.source || '-';
        }
        
        // Update Rating Stars
        function updateRatingStars(rating) {
            const stars = document.querySelectorAll('.star');
            const ratingText = document.getElementById('rating-text');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            if (ratingText) {
                ratingText.textContent = rating > 0 ? `${rating} von 5 Sternen` : 'Keine Bewertung';
            }
        }
        
        // Update Flag Buttons
        function updateFlagButtons(flag) {
            const sidebar = document.getElementById('feedback-sidebar');
            const flagButtons = sidebar ? sidebar.querySelectorAll('.flag-btn[data-flag]') : [];
            flagButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.flag === flag) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Display Comments
        function displayComments(imageId) {
            const commentList = document.getElementById('comment-list');
            const comments = feedbackData.comments[imageId] || [];
            
            commentList.innerHTML = '';
            
            if (comments.length === 0) {
                commentList.innerHTML = '<p class="muted-small">Noch keine Kommentare</p>';
                return;
            }
            
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <div class="comment-author">${comment.author || 'Anonym'}</div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-date">${new Date(comment.date).toLocaleString('de-CH')}</div>
                `;
                commentList.appendChild(commentItem);
            });
        }
        
        // Display Selections
        function displaySelections(imageId) {
            const selectionsDiv = document.getElementById('current-selections');
            const selections = feedbackData.selections[imageId] || [];
            
            if (selections.length === 0) {
                selectionsDiv.innerHTML = '<p class="muted-small">Nicht in einer Auswahl</p>';
            } else {
                selectionsDiv.innerHTML = selections.map(s => `<span class="selection-tag">${s}</span>`).join('');
            }
        }
        
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('feedback-sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Add Comment
        function addComment() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            const commentInput = document.getElementById('comment-input');
            const text = commentInput.value.trim();
            
            if (!text) {
                showToast('Kommentar', 'Bitte einen Kommentar eingeben.', 'warning');
                try { commentInput.focus(); } catch (_) {}
                return;
            }
            
            if (!feedbackData.comments[imageId]) {
                feedbackData.comments[imageId] = [];
            }
            
            feedbackData.comments[imageId].push({
                author: 'Kunde', // Könnte später aus localStorage kommen
                text: text,
                date: new Date().toISOString()
            });
            
            saveFeedbackData();
            commentInput.value = '';
            displayComments(imageId);
            updateAllImageBadges();
            
            // Update Kommentar-Zähler in Gallery
            const item = document.querySelector(`[data-image-id="${imageId}"]`);
            if (item) {
                const commentBtn = item.querySelector('.gallery-item-actions .gallery-item-btn:last-child');
                if (commentBtn) {
                    const count = feedbackData.comments[imageId].length;
                    commentBtn.innerHTML = `<span class="btn-label">Komm.</span> <span class="btn-count">${count}</span>`;
                }
            }
        }
        
        // Add to Selection
        function addToSelection() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            const selectionName = document.getElementById('selection-name').value.trim();
            
            if (!selectionName) {
                showToast('Auswahl', 'Bitte einen Auswahl-Namen eingeben.', 'warning');
                const input = document.getElementById('selection-name');
                if (input) {
                    try { input.focus(); } catch (_) {}
                }
                return;
            }
            
            if (!feedbackData.selections[imageId]) {
                feedbackData.selections[imageId] = [];
            }
            
            if (!feedbackData.selections[imageId].includes(selectionName)) {
                feedbackData.selections[imageId].push(selectionName);
                saveFeedbackData();
                document.getElementById('selection-name').value = '';
                displaySelections(imageId);
                updateAllImageBadges();
                updateSidebarStats();
            }
        }
        
        // Set Rating
        function setRating(rating) {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            window.__wbfmDebug.lastImageId = imageId;
            if (Number(rating) > 0) {
                feedbackData.ratings[imageId] = Number(rating);
            } else {
                delete feedbackData.ratings[imageId];
            }
            saveFeedbackData();
            updateRatingStars(Number(rating) > 0 ? Number(rating) : 0);
            updateAllImageBadges();
            updateSidebarStats();
            void ensureDebugPanel();
        }
        
        // Set Flag
        function setFlag(flag) {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = getFeedbackImageId(image, currentImageIndex);
            
            // Toggle: Wenn bereits gesetzt, entfernen
            if (feedbackData.flags[imageId] === flag) {
                delete feedbackData.flags[imageId];
            } else {
                feedbackData.flags[imageId] = flag;
            }
            
            saveFeedbackData();
            updateFlagButtons(feedbackData.flags[imageId] || null);
            updateAllImageBadges();
            updateSidebarStats();
            
            // Filter neu anwenden (falls Flag-Filter aktiv)
            if (currentFilter.flag) {
                applyFilter();
            }
        }

        // Clear Flag
        function clearFlag() {
            const image = currentImages[currentImageIndex];
            if (!image) return;

            const imageId = getFeedbackImageId(image, currentImageIndex);
            if (!feedbackData.flags[imageId]) return;

            delete feedbackData.flags[imageId];
            saveFeedbackData();
            updateFlagButtons(null);
            updateAllImageBadges();
            updateSidebarStats();

            if (currentFilter.flag) {
                applyFilter();
            }
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            updateBodyOverlayState();
        }
        
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            document.getElementById('lightbox-image').src = imageUrl;
            updateFeedbackSidebar();
            updateLightboxFilmstripActive();
        }
        
        function previousImage() {
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            document.getElementById('lightbox-image').src = imageUrl;
            updateFeedbackSidebar();
            updateLightboxFilmstripActive();
        }
        
        async function downloadImage() {
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            const fileName = image.name || 'image.jpg';
            
            try {
                // Für Cloudinary-URLs: Lade Bild als Blob und starte Download
                if (imageUrl.includes('res.cloudinary.com')) {
                    // Entferne Transformationen für Original-Download
                    let downloadUrl = imageUrl;
                    // Entferne Transformationen aus der URL um Original zu bekommen
                    if (downloadUrl.includes('/upload/')) {
                        // Finde die Version/Public ID nach den Transformationen
                        const match = downloadUrl.match(/\/upload\/[^\/]+\/(v\d+\/)?([^\/]+)$/);
                        if (match) {
                            // Erstelle URL ohne Transformationen (Original)
                            const cloudName = downloadUrl.match(/res\.cloudinary\.com\/([^\/]+)/)?.[1];
                            const version = match[1] || '';
                            const publicId = match[2];
                            downloadUrl = `https://res.cloudinary.com/${cloudName}/image/upload/${version}${publicId}`;
                        }
                    }
                    
                    // Lade Bild als Blob
                    const response = await fetch(downloadUrl);
                    if (!response.ok) {
                        throw new Error('Bild konnte nicht geladen werden');
                    }
                    
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    
                    // Erstelle Download-Link
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Cleanup
                    window.URL.revokeObjectURL(blobUrl);
                } else {
                    // Für lokale Bilder: Direkter Download
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error('Download-Fehler:', error);
                // Fallback: Öffne in neuem Tab
                window.open(imageUrl, '_blank');
            }
        }
        
        // Tastatur (Picdrop-inspiriert)
        document.addEventListener('keydown', (e) => {
            const activeEl = document.activeElement;
            const isTyping = !!activeEl && (
                activeEl.tagName === 'INPUT' ||
                activeEl.tagName === 'TEXTAREA' ||
                activeEl.tagName === 'SELECT' ||
                activeEl.isContentEditable
            );
            if (isTyping) return;

            // Modals first
            if (isModalOpen()) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeShortcutsModal();
                    closeConfirmModal(false);
                    closePromptModal(null);
                    cancelProgressModal();
                    closeChoiceModal(null);
                }
                return;
            }

            // Help (Picdrop-style)
            if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
                e.preventDefault();
                toggleShortcutsModal();
                return;
            }

            // Overlays (non-modal): Culling / Compare
            const cullingActive = isCullingActive();
            const compareActive = isCompareActive();

            if (cullingActive) {
                const total = currentImages?.length || 0;
                if (e.key === 'Escape' || key === 'c') {
                    e.preventDefault();
                    closeCullingMode();
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (!total) return;
                    currentImageIndex = (Number(currentImageIndex) + 1) % total;
                    renderCulling();
                    return;
                }
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (!total) return;
                    currentImageIndex = (Number(currentImageIndex) - 1 + total) % total;
                    renderCulling();
                    return;
                }
                if (e.key === ' ') {
                    e.preventDefault();
                    const image = currentImages?.[currentImageIndex];
                    if (!image) return;
                    const imageId = getFeedbackImageId(image, currentImageIndex);
                    if (!imageId) return;
                    toggleImageSelection(imageId, { shiftKey: false });
                    renderCulling();
                    return;
                }
                if (key === 'f') {
                    e.preventDefault();
                    toggleFavorite();
                    renderCulling();
                    return;
                }
                if (['1', '2', '3', '4', '5'].includes(e.key)) {
                    e.preventDefault();
                    setRating(Number(e.key));
                    renderCulling();
                    return;
                }
                if (e.key === '0') {
                    e.preventDefault();
                    setRating(0);
                    renderCulling();
                    return;
                }
                if (key === 'r' || key === 'x') {
                    e.preventDefault();
                    setFlag('reject');
                    renderCulling();
                    return;
                }
                if (key === 'l') {
                    e.preventDefault();
                    const idx = Number(currentImageIndex) || 0;
                    closeCullingMode();
                    openLightbox(idx);
                    return;
                }
                return;
            }

            if (compareActive) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeCompareView();
                    return;
                }
                return;
            }

            const lightbox = document.getElementById('lightbox');
            const lightboxActive = lightbox && lightbox.classList.contains('active');
            const key = (e.key || '').toLowerCase();

            if (lightboxActive) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeLightbox();
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextImage();
                    return;
                }
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousImage();
                    return;
                }
                if (e.key === ' ') {
                    // Space: Auswahl togglen für aktuelles Bild
                    e.preventDefault();
                    const image = currentImages?.[currentImageIndex];
                    if (!image) return;
                    const imageId = getFeedbackImageId(image, currentImageIndex);
                    if (!imageId) return;
                    toggleImageSelection(imageId, { shiftKey: false });
                    return;
                }
                if (key === 'f') {
                    e.preventDefault();
                    toggleFavorite();
                    showToast('Favorit', 'Für aktuelles Bild umgeschaltet.', 'success');
                    return;
                }

                // Culling-style shortcuts in Lightbox
                if (['1', '2', '3', '4', '5'].includes(e.key)) {
                    e.preventDefault();
                    setRating(Number(e.key));
                    showToast('Rating', `${e.key}★`, 'success');
                    return;
                }
                if (e.key === '0') {
                    e.preventDefault();
                    setRating(0);
                    showToast('Rating', 'Entfernt', 'info');
                    return;
                }
                if (key === 'r' || key === 'x') {
                    e.preventDefault();
                    setFlag('reject');
                    showToast('Markierung', 'Reject toggled', 'warning');
                    return;
                }
                return;
            }

            const galleryContainer = document.getElementById('gallery-container');
            const galleryVisible = galleryContainer && galleryContainer.style.display !== 'none';
            if (!galleryVisible) return;

            // Quick Filter Shortcuts
            // Shift+1..5 => Rating filter, Shift+0 => reset
            if (e.shiftKey && !e.altKey && !e.metaKey && !e.ctrlKey) {
                if (['1', '2', '3', '4', '5'].includes(e.key)) {
                    e.preventDefault();
                    filterByRating(Number(e.key));
                    showToast('Filter', `Rating ${e.key}★`, 'success');
                    return;
                }
                if (e.key === '0') {
                    e.preventDefault();
                    filterByType('all');
                    showToast('Filter', 'Zurück zu Alle', 'success');
                    return;
                }
            }

            // Alt/Option+1..4 => Flag filter, Alt/Option+0 => reset
            if (e.altKey && !e.metaKey && !e.ctrlKey) {
                const flagMap = { '1': 'reject', '2': 'review', '3': 'approve', '4': 'final' };
                if (flagMap[e.key]) {
                    e.preventDefault();
                    filterByFlag(flagMap[e.key]);
                    showToast('Filter', `Flag ${flagMap[e.key]}`, 'success');
                    return;
                }
                if (e.key === '0') {
                    e.preventDefault();
                    filterByType('all');
                    showToast('Filter', 'Zurück zu Alle', 'success');
                    return;
                }
            }

            // Cmd/Ctrl + A: alle sichtbaren auswählen
            if ((e.metaKey || e.ctrlKey) && key === 'a') {
                e.preventDefault();
                selectAllVisible();
                return;
            }

            const selectedCount = document.querySelectorAll('.gallery-item.selected').length;

            // C: Culling Mode
            if (key === 'c') {
                e.preventDefault();
                let start = 0;
                const firstSelected = getSelectedItems()?.[0];
                const firstVisible = Array.from(document.querySelectorAll('.gallery-item')).find(el => el.style.display !== 'none');
                const candidate = firstSelected || firstVisible;
                const imageId = candidate?.dataset?.imageId;
                if (imageId) {
                    const idx = findImageIndexByFeedbackId(imageId);
                    if (idx >= 0) start = idx;
                }
                openCullingMode(start);
                return;
            }

            // V: Compare View (2–4)
            if (key === 'v') {
                e.preventDefault();
                openCompareView();
                return;
            }

            if (e.key === 'Escape') {
                if (selectedCount > 0) {
                    e.preventDefault();
                    clearSelection();
                    showToast('Auswahl', 'Aufgehoben.', 'warning');
                }
                return;
            }

            // D: Download (ZIP)
            if (key === 'd') {
                if (selectedCount === 0) {
                    showToast('Keine Auswahl', 'Nichts zum Download.', 'warning');
                    return;
                }
                e.preventDefault();
                Promise.resolve(bulkDownload()).catch(err => console.error(err));
                return;
            }

            // E: Export (JSON)
            if (key === 'e') {
                if (selectedCount === 0) {
                    showToast('Keine Auswahl', 'Nichts zum Export.', 'warning');
                    return;
                }
                e.preventDefault();
                exportSelectedList();
                return;
            }

            // F: Favorit setzen (bulk)
            if (key === 'f') {
                if (selectedCount === 0) {
                    showToast('Keine Auswahl', 'Nichts zu favorisieren.', 'warning');
                    return;
                }
                e.preventDefault();
                const changed = bulkAddToFavorites();
                showToast('Favoriten gesetzt', `${changed} Bild(er) markiert.`, 'success');
                return;
            }

            // S: Zu Auswahl hinzufügen
            if (key === 's') {
                if (selectedCount === 0) {
                    showToast('Keine Auswahl', 'Nichts hinzuzufügen.', 'warning');
                    return;
                }
                e.preventDefault();
                Promise.resolve(bulkAddToSelection()).then((result) => {
                    if (result) showToast('Zur Auswahl hinzugefügt', `${result.count} Bild(er) → „${result.name}“`, 'success');
                }).catch(err => console.error(err));
                return;
            }

            // U: Undo (Reset)
            if (key === 'u') {
                if (!hasSelectionUndo()) return;
                e.preventDefault();
                restoreSelectionUndo();
                showToast('Undo', 'Auswahl wiederhergestellt.', 'success');
                return;
            }
        });

        window.addEventListener('resize', () => {
            requestAnimationFrame(syncPortfolioHeightToCategoryTile);
        });
        
        // Initialisierung
        (async () => {
            // Theme initialisieren
            initTheme();

            // Feedback initialisieren (inkl. IndexedDB Fallback)
            await loadFeedbackData();

            // Debug Panel (optional via ?debug=1)
            await ensureDebugPanel();
            
            // Suche initialisieren
            initSearch();

            // Quick Filters initialisieren
            initQuickFilters();

            // Sortierung initialisieren
            initSortControls();

            // Culling / Compare Controls
            initViewModeControls();

            // Overlays (Confirm + Help)
            initOverlays();

            // Bulk-Aktionen initialisieren
            initBulkActionButtons();

            // Bottom Selection Bar initialisieren
            initSelectionBar();
            
            await loadConfig();
            
            if (!galleryConfig) {
                document.getElementById('error').style.display = 'block';
                return;
            }
            
            // Prüfe ob mehrere Galerien vorhanden sind
            console.log('Galerien gefunden:', galleryConfig.galleries?.length || 0);
            if (galleryConfig.galleries && galleryConfig.galleries.length > 0) {
                // Zeige immer Galerie-Auswahl (auch bei nur einer Galerie)
                console.log('Zeige Galerie-Auswahl');
                showGallerySelector();
            } else {
                // Fallback: Alte Struktur (nur images Array)
                if (galleryConfig.images && galleryConfig.images.length > 0) {
                    // Konvertiere alte Struktur zu neuer
                    currentImagesOriginal = Array.isArray(galleryConfig.images) ? galleryConfig.images : [];
                    ensureOriginalIndices(currentImagesOriginal);
                    currentImages = Array.from(currentImagesOriginal);
                    migrateLegacyFeedbackIds(currentImagesOriginal);
                    document.getElementById('gallery-container').style.display = 'block';
                    displayGallery(currentImages);
                } else {
                    document.getElementById('error').style.display = 'block';
                }
            }
        })();
    </script>
</body>
</html>
