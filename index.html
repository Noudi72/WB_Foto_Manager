<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Foto Manager - Galerie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 40px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            object-fit: contain;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gallery-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        
        .gallery-card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        
        .gallery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            border-color: #667eea;
        }
        
        .gallery-card.locked {
            opacity: 0.7;
        }
        
        .gallery-card-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #1a1a1a;
        }
        
        .gallery-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #e0e0e0;
        }
        
        .gallery-card p {
            color: #888;
            margin-bottom: 15px;
        }
        
        .gallery-card .image-count {
            color: #667eea;
            font-weight: 600;
        }
        
        .gallery-card .lock-icon {
            float: right;
            font-size: 1.2em;
            color: #888;
        }
        
        .password-form {
            max-width: 400px;
            margin: 40px auto;
            padding: 30px;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .password-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .password-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 16px;
        }
        
        .password-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .password-form button:hover {
            opacity: 0.9;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: #333;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        
        .gallery-item {
            position: relative;
            aspect-ratio: 4/3;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            background: #2a2a2a;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 20px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 50%;
        }
        
        .lightbox-prev {
            left: -60px;
        }
        
        .lightbox-next {
            right: -60px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }
        
        .download-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        @media (max-width: 768px) {
            .lightbox-nav {
                padding: 15px;
                font-size: 20px;
            }
            
            .lightbox-prev {
                left: 10px;
            }
            
            .lightbox-next {
                right: 10px;
            }
            
            .logo-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="./logo.png" alt="WB Foto Manager Logo" class="logo">
                <div>
                    <h1>WB Foto Manager</h1>
                    <p>Galerie</p>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <a href="admin.html" style="color: #667eea; text-decoration: none; font-size: 0.9em;">‚öôÔ∏è Admin</a>
            </div>
        </header>
        
        <!-- Galerie-Auswahl (wird angezeigt wenn mehrere Galerien vorhanden) -->
        <div id="gallery-selector" style="display: none;">
            <div class="gallery-selector" id="gallery-list"></div>
        </div>
        
        <!-- Passwort-Formular -->
        <div id="password-form" class="password-form" style="display: none;">
            <h2>Passwort erforderlich</h2>
            <p style="text-align: center; color: #888; margin-bottom: 20px;" id="gallery-name-display"></p>
            <input type="password" id="password-input" placeholder="Passwort eingeben" autofocus>
            <button onclick="checkPassword()">Anmelden</button>
            <p id="password-error" style="color: #ff6b6b; margin-top: 10px; display: none;">Falsches Passwort</p>
        </div>
        
        <!-- Galerie-Ansicht -->
        <div id="gallery-container" style="display: none;">
            <button class="back-button" onclick="showGallerySelector()" id="back-button" style="display: none;">
                ‚Üê Zur√ºck zur Galerie-Auswahl
            </button>
            <div class="gallery" id="gallery"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <p>Lade Bilder...</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <p>Fehler beim Laden der Bilder</p>
        </div>
    </div>
    
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-nav lightbox-prev" onclick="previousImage()">‚Äπ</button>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="">
            <div style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px; z-index: 10;">
                <button class="download-btn" onclick="downloadImage()">üì• Download</button>
                <button class="download-btn" onclick="toggleSidebar()" id="feedback-toggle-btn">üí¨ Feedback</button>
            </div>
        </div>
        <button class="lightbox-nav lightbox-next" onclick="nextImage()">‚Ä∫</button>
        
        <!-- Feedback-Sidebar -->
        <div class="lightbox-sidebar" id="feedback-sidebar">
            <button onclick="toggleSidebar()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #e0e0e0; font-size: 24px; cursor: pointer;">&times;</button>
            <h3 id="feedback-image-name">Bild Feedback</h3>
            
            <!-- Bewertung -->
            <div class="feedback-section">
                <h4>‚≠ê Bewertung</h4>
                <div class="rating-stars" id="rating-stars">
                    <span class="star" data-rating="1" onclick="setRating(1)">‚òÖ</span>
                    <span class="star" data-rating="2" onclick="setRating(2)">‚òÖ</span>
                    <span class="star" data-rating="3" onclick="setRating(3)">‚òÖ</span>
                    <span class="star" data-rating="4" onclick="setRating(4)">‚òÖ</span>
                    <span class="star" data-rating="5" onclick="setRating(5)">‚òÖ</span>
                </div>
                <p id="rating-text" style="color: #888; font-size: 0.9em; margin-top: 5px;">Keine Bewertung</p>
            </div>
            
            <!-- Markierungen (Flags) -->
            <div class="feedback-section">
                <h4>üè∑Ô∏è Markierung</h4>
                <div class="flag-buttons">
                    <button class="flag-btn red" data-flag="reject" title="Ablehnen" onclick="setFlag('reject')">‚úó Ablehnen</button>
                    <button class="flag-btn yellow" data-flag="review" title="Pr√ºfen" onclick="setFlag('review')">‚ö† Pr√ºfen</button>
                    <button class="flag-btn green" data-flag="approve" title="Genehmigen" onclick="setFlag('approve')">‚úì Genehmigen</button>
                    <button class="flag-btn black" data-flag="final" title="Final" onclick="setFlag('final')">‚òÖ Final</button>
                </div>
            </div>
            
            <!-- Favorit -->
            <div class="feedback-section">
                <h4>‚ù§Ô∏è Favorit</h4>
                <button class="gallery-item-btn gallery-item-like" id="favorite-btn" onclick="toggleFavorite()">
                    <span id="favorite-icon">ü§ç</span> <span id="favorite-text">Als Favorit markieren</span>
                </button>
            </div>
            
            <!-- Kommentare -->
            <div class="feedback-section">
                <h4>üí¨ Kommentare</h4>
                <textarea class="comment-input" id="comment-input" placeholder="Ihr Kommentar..."></textarea>
                <button class="btn-primary" onclick="addComment()" style="width: 100%;">Kommentar hinzuf√ºgen</button>
                <div class="comment-list" id="comment-list"></div>
            </div>
            
            <!-- Auswahl -->
            <div class="feedback-section">
                <h4>üìÅ Auswahl</h4>
                <input type="text" id="selection-name" placeholder="Auswahl-Name (z.B. 'Portraits')" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; margin-bottom: 10px;">
                <button class="btn-secondary" onclick="addToSelection()" style="width: 100%;">Zu Auswahl hinzuf√ºgen</button>
                <div id="current-selections" style="margin-top: 15px; font-size: 0.9em; color: #888;"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Konfiguration
        let galleryConfig = null;
        let currentGallery = null;
        let currentImages = [];
        let currentImageIndex = 0;
        
        // Feedback-Daten (wird in localStorage gespeichert)
        let feedbackData = {
            ratings: {},      // { imageId: rating (1-5) }
            flags: {},        // { imageId: 'reject'|'review'|'approve'|'final' }
            favorites: {},    // { imageId: true }
            comments: {},    // { imageId: [{ author, text, date }] }
            selections: {}    // { imageId: ['selection1', 'selection2'] }
        };
        
        // Lade Feedback-Daten
        function loadFeedbackData() {
            const saved = localStorage.getItem('gallery_feedback');
            if (saved) {
                try {
                    feedbackData = JSON.parse(saved);
                } catch (e) {
                    console.error('Fehler beim Laden der Feedback-Daten:', e);
                }
            }
        }
        
        // Speichere Feedback-Daten
        function saveFeedbackData() {
            localStorage.setItem('gallery_feedback', JSON.stringify(feedbackData));
        }
        
        // Initialisiere Feedback-System
        loadFeedbackData();
        
        // Lade Konfiguration von gallery.json
        async function loadConfig() {
            try {
                // Cache-Busting: F√ºge Timestamp hinzu um sicherzustellen, dass die neueste Version geladen wird
                const cacheBuster = '?t=' + Date.now();
                const response = await fetch('./gallery.json' + cacheBuster);
                if (response.ok) {
                    galleryConfig = await response.json();
                    console.log('gallery.json geladen', {
                        version: galleryConfig.version,
                        galleries: galleryConfig.galleries?.length || 0,
                        generated: galleryConfig.generated
                    });
                    return true;
                } else {
                    console.error('gallery.json konnte nicht geladen werden:', response.status, response.statusText);
                }
                return false;
            } catch (error) {
                console.error('Fehler beim Laden der Konfiguration:', error);
                return false;
            }
        }
        
        // Zeige Galerie-Auswahl
        function showGallerySelector() {
            document.getElementById('gallery-selector').style.display = 'block';
            document.getElementById('password-form').style.display = 'none';
            document.getElementById('gallery-container').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            const galleryList = document.getElementById('gallery-list');
            galleryList.innerHTML = '';
            
            if (!galleryConfig || !galleryConfig.galleries || galleryConfig.galleries.length === 0) {
                galleryList.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1 / -1;">Keine Galerien gefunden</p>';
                return;
            }
            
            galleryConfig.galleries.forEach((gallery) => {
                const card = document.createElement('div');
                card.className = 'gallery-card' + (gallery.password ? ' locked' : '');
                
                // Vorschaubild f√ºr nicht gesch√ºtzte Galerien
                let previewImage = '';
                if (!gallery.password && gallery.images && gallery.images.length > 0) {
                    const firstImage = gallery.images[0];
                    let thumbnailUrl = firstImage.thumbnailUrl || firstImage.url;
                    
                    // Verbessere Thumbnail-Qualit√§t f√ºr Vorschaubild (500x500px f√ºr Galerie-Karten)
                    if (thumbnailUrl.includes('res.cloudinary.com') && thumbnailUrl.includes('/upload/')) {
                        // Ersetze alte kleine Thumbnails durch gr√∂√üere
                        if (thumbnailUrl.includes('/c_limit,h_60,w_90/') || thumbnailUrl.includes('/c_fill,h_60,w_90/')) {
                            thumbnailUrl = thumbnailUrl.replace(
                                /\/upload\/[^\/]+\//,
                                '/upload/c_fill,h_500,w_500,q_auto:good,f_auto/'
                            );
                        } else if (!thumbnailUrl.includes('/c_') && !thumbnailUrl.includes('/w_') && !thumbnailUrl.includes('/h_')) {
                            // Keine Transformation - f√ºge hinzu
                            thumbnailUrl = thumbnailUrl.replace(
                                /\/upload\//,
                                '/upload/c_fill,h_500,w_500,q_auto:good,f_auto/'
                            );
                        }
                    }
                    
                    previewImage = `<img src="${thumbnailUrl}" alt="${gallery.name}" class="gallery-card-preview" loading="lazy">`;
                }
                
                card.innerHTML = `
                    ${gallery.password ? '<span class="lock-icon">üîí</span>' : previewImage}
                    <h3>${gallery.name || 'Unbenannte Galerie'}</h3>
                    <p>${gallery.description || ''}</p>
                    <p class="image-count">${gallery.images?.length || 0} Bilder</p>
                `;
                card.onclick = () => selectGallery(gallery);
                galleryList.appendChild(card);
            });
        }
        
        // W√§hle eine Galerie aus
        function selectGallery(gallery) {
            currentGallery = gallery;
            
            // Pr√ºfe ob Passwort erforderlich ist
            if (gallery.password) {
                document.getElementById('gallery-selector').style.display = 'none';
                document.getElementById('password-form').style.display = 'block';
                document.getElementById('gallery-name-display').textContent = gallery.name || 'Galerie';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            } else {
                // Kein Passwort - zeige Galerie direkt
                showGallery(gallery);
            }
        }
        
        // Passwort-Pr√ºfung
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');
            
            if (currentGallery && currentGallery.password) {
                if (input === currentGallery.password) {
                    showGallery(currentGallery);
                } else {
                    errorEl.style.display = 'block';
                    setTimeout(() => {
                        errorEl.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        // Enter-Taste f√ºr Passwort
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // Zeige Galerie
        function showGallery(gallery) {
            document.getElementById('gallery-selector').style.display = 'none';
            document.getElementById('password-form').style.display = 'none';
            document.getElementById('gallery-container').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            // Zeige Zur√ºck-Button nur wenn mehrere Galerien vorhanden
            if (galleryConfig && galleryConfig.galleries && galleryConfig.galleries.length > 1) {
                document.getElementById('back-button').style.display = 'block';
            } else {
                document.getElementById('back-button').style.display = 'none';
            }
            
            currentImages = gallery.images || [];
            console.log('Lade', currentImages.length, 'Bilder - "' + (gallery.name || 'Unbekannt') + '"');
            displayGallery(currentImages);
            document.getElementById('loading').style.display = 'none';
        }
        
        // Zeige Galerie-Bilder
        function displayGallery(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            if (images.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1 / -1;">Keine Bilder gefunden</p>';
                return;
            }
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.dataset.imageId = image.id || `img_${index}`;
                
                // Erstelle hochwertiges Thumbnail-URL
                let imgSrc = image.thumbnailUrl || image.url || `./images/${image.name}`;
                const fullSrc = image.url || `./images/${image.name}`;
                
                // Wenn Cloudinary-URL vorhanden, aber altes Format (h_60,w_90), ersetze durch gr√∂√üeres Thumbnail
                if (imgSrc.includes('res.cloudinary.com') && imgSrc.includes('/upload/')) {
                    // Pr√ºfe ob bereits Transformation vorhanden
                    if (imgSrc.includes('/c_limit,h_60,w_90/') || imgSrc.includes('/c_fill,h_60,w_90/')) {
                        // Ersetze durch hochwertiges Thumbnail (400x400px)
                        imgSrc = imgSrc.replace(
                            /\/upload\/[^\/]+\//,
                            '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                        );
                    } else if (!imgSrc.includes('/c_') && !imgSrc.includes('/w_') && !imgSrc.includes('/h_')) {
                        // Keine Transformation vorhanden - f√ºge hinzu
                        imgSrc = imgSrc.replace(
                            /\/upload\//,
                            '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                        );
                    }
                }
                
                const img = document.createElement('img');
                img.src = imgSrc;
                img.alt = image.name || 'Bild';
                img.loading = 'lazy';
                img.onerror = function() {
                    // Fallback 1: Versuche ohne ./ prefix
                    if (this.src.includes('./')) {
                        this.src = this.src.replace('./', '/');
                        return;
                    }
                    // Fallback 2: Versuche direkte URL wenn thumbnailUrl fehlgeschlagen
                    if (image.url && this.src !== image.url) {
                        // Versuche hochwertiges Thumbnail aus original URL zu erstellen
                        if (image.url.includes('res.cloudinary.com')) {
                            this.src = image.url.replace(
                                /\/upload\//,
                                '/upload/c_fill,h_400,w_400,q_auto:good,f_auto/'
                            );
                        } else {
                            this.src = image.url;
                        }
                        return;
                    }
                    // Fallback 3: Zeige Fehler-Placeholder
                    this.onerror = null; // Verhindere Endlosschleife
                    this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23222" width="200" height="200"/%3E%3Ctext fill="%23888" font-family="sans-serif" font-size="14" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EBild nicht gefunden%3C/text%3E%3C/svg%3E';
                };
                
                // Overlay mit Features
                const overlay = document.createElement('div');
                overlay.className = 'gallery-item-overlay';
                
                // Checkbox f√ºr Auswahl
                const checkbox = document.createElement('div');
                checkbox.className = 'gallery-item-checkbox';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleImageSelection(image.id || `img_${index}`);
                };
                overlay.appendChild(checkbox);
                
                // Actions (Like, Kommentare)
                const actions = document.createElement('div');
                actions.className = 'gallery-item-actions';
                
                const likeBtn = document.createElement('button');
                likeBtn.className = 'gallery-item-btn gallery-item-like';
                likeBtn.innerHTML = '<span>ü§ç</span> <span>0</span>';
                likeBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleFavorite(image.id || `img_${index}`);
                };
                actions.appendChild(likeBtn);
                
                const commentBtn = document.createElement('button');
                commentBtn.className = 'gallery-item-btn';
                commentBtn.innerHTML = '<span>üí¨</span> <span>0</span>';
                commentBtn.onclick = (e) => {
                    e.stopPropagation();
                    openLightbox(index, fullSrc);
                    setTimeout(() => toggleSidebar(), 300);
                };
                actions.appendChild(commentBtn);
                
                overlay.appendChild(actions);
                
                // Badges f√ºr Markierungen
                updateImageBadges(item, image.id || `img_${index}`);
                
                item.appendChild(img);
                item.appendChild(overlay);
                item.onclick = () => openLightbox(index, fullSrc);
                gallery.appendChild(item);
            });
            
            // Update alle Badges nach dem Rendern
            updateAllImageBadges();
        }
        
        // Lightbox
        function openLightbox(index, fullImageUrl = null) {
            currentImageIndex = index;
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-image');
            
            const image = currentImages[index];
            const imageUrl = fullImageUrl || image.url || `./images/${image.name}`;
            
            img.src = imageUrl;
            img.alt = image.name || 'Bild';
            lightbox.classList.add('active');
            
            // Update Feedback-Sidebar f√ºr aktuelles Bild
            updateFeedbackSidebar();
        }
        
        // Update Feedback-Sidebar
        function updateFeedbackSidebar() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = image.id || `img_${currentImageIndex}`;
            
            // Bild-Name
            document.getElementById('feedback-image-name').textContent = image.name || 'Bild Feedback';
            
            // Bewertung
            const rating = feedbackData.ratings[imageId] || 0;
            updateRatingStars(rating);
            
            // Markierung
            const flag = feedbackData.flags[imageId] || null;
            updateFlagButtons(flag);
            
            // Favorit
            updateFavoriteUI(imageId);
            
            // Kommentare
            displayComments(imageId);
            
            // Auswahlen
            displaySelections(imageId);
        }
        
        // Update Rating Stars
        function updateRatingStars(rating) {
            const stars = document.querySelectorAll('.star');
            const ratingText = document.getElementById('rating-text');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            if (ratingText) {
                ratingText.textContent = rating > 0 ? `${rating} von 5 Sternen` : 'Keine Bewertung';
            }
        }
        
        // Update Flag Buttons
        function updateFlagButtons(flag) {
            const flagButtons = document.querySelectorAll('.flag-btn');
            flagButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.flag === flag) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Display Comments
        function displayComments(imageId) {
            const commentList = document.getElementById('comment-list');
            const comments = feedbackData.comments[imageId] || [];
            
            commentList.innerHTML = '';
            
            if (comments.length === 0) {
                commentList.innerHTML = '<p style="color: #888; font-size: 0.9em;">Noch keine Kommentare</p>';
                return;
            }
            
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <div class="comment-author">${comment.author || 'Anonym'}</div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-date">${new Date(comment.date).toLocaleString('de-CH')}</div>
                `;
                commentList.appendChild(commentItem);
            });
        }
        
        // Display Selections
        function displaySelections(imageId) {
            const selectionsDiv = document.getElementById('current-selections');
            const selections = feedbackData.selections[imageId] || [];
            
            if (selections.length === 0) {
                selectionsDiv.textContent = 'Nicht in einer Auswahl';
            } else {
                selectionsDiv.innerHTML = selections.map(s => `<span style="background: #667eea; padding: 4px 8px; border-radius: 4px; margin-right: 5px; font-size: 0.85em;">üìÅ ${s}</span>`).join('');
            }
        }
        
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('feedback-sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Add Comment
        function addComment() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = image.id || `img_${currentImageIndex}`;
            const commentInput = document.getElementById('comment-input');
            const text = commentInput.value.trim();
            
            if (!text) {
                alert('Bitte geben Sie einen Kommentar ein');
                return;
            }
            
            if (!feedbackData.comments[imageId]) {
                feedbackData.comments[imageId] = [];
            }
            
            feedbackData.comments[imageId].push({
                author: 'Kunde', // K√∂nnte sp√§ter aus localStorage kommen
                text: text,
                date: new Date().toISOString()
            });
            
            saveFeedbackData();
            commentInput.value = '';
            displayComments(imageId);
            updateAllImageBadges();
            
            // Update Kommentar-Z√§hler in Gallery
            const item = document.querySelector(`[data-image-id="${imageId}"]`);
            if (item) {
                const commentBtn = item.querySelector('.gallery-item-actions .gallery-item-btn:last-child');
                if (commentBtn) {
                    const count = feedbackData.comments[imageId].length;
                    commentBtn.innerHTML = `<span>üí¨</span> <span>${count}</span>`;
                }
            }
        }
        
        // Add to Selection
        function addToSelection() {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = image.id || `img_${currentImageIndex}`;
            const selectionName = document.getElementById('selection-name').value.trim();
            
            if (!selectionName) {
                alert('Bitte geben Sie einen Auswahl-Namen ein');
                return;
            }
            
            if (!feedbackData.selections[imageId]) {
                feedbackData.selections[imageId] = [];
            }
            
            if (!feedbackData.selections[imageId].includes(selectionName)) {
                feedbackData.selections[imageId].push(selectionName);
                saveFeedbackData();
                document.getElementById('selection-name').value = '';
                displaySelections(imageId);
                updateAllImageBadges();
            }
        }
        
        // Set Rating
        function setRating(rating) {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = image.id || `img_${currentImageIndex}`;
            feedbackData.ratings[imageId] = rating;
            saveFeedbackData();
            updateRatingStars(rating);
        }
        
        // Set Flag
        function setFlag(flag) {
            const image = currentImages[currentImageIndex];
            if (!image) return;
            
            const imageId = image.id || `img_${currentImageIndex}`;
            
            // Toggle: Wenn bereits gesetzt, entfernen
            if (feedbackData.flags[imageId] === flag) {
                delete feedbackData.flags[imageId];
            } else {
                feedbackData.flags[imageId] = flag;
            }
            
            saveFeedbackData();
            updateFlagButtons(feedbackData.flags[imageId] || null);
            updateAllImageBadges();
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }
        
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            document.getElementById('lightbox-image').src = imageUrl;
            updateFeedbackSidebar();
        }
        
        function previousImage() {
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            document.getElementById('lightbox-image').src = imageUrl;
            updateFeedbackSidebar();
        }
        
        async function downloadImage() {
            const image = currentImages[currentImageIndex];
            const imageUrl = image.url || `./images/${image.name}`;
            const fileName = image.name || 'image.jpg';
            
            try {
                // F√ºr Cloudinary-URLs: Lade Bild als Blob und starte Download
                if (imageUrl.includes('res.cloudinary.com')) {
                    // Entferne Transformationen f√ºr Original-Download
                    let downloadUrl = imageUrl;
                    // Entferne Transformationen aus der URL um Original zu bekommen
                    if (downloadUrl.includes('/upload/')) {
                        // Finde die Version/Public ID nach den Transformationen
                        const match = downloadUrl.match(/\/upload\/[^\/]+\/(v\d+\/)?([^\/]+)$/);
                        if (match) {
                            // Erstelle URL ohne Transformationen (Original)
                            const cloudName = downloadUrl.match(/res\.cloudinary\.com\/([^\/]+)/)?.[1];
                            const version = match[1] || '';
                            const publicId = match[2];
                            downloadUrl = `https://res.cloudinary.com/${cloudName}/image/upload/${version}${publicId}`;
                        }
                    }
                    
                    // Lade Bild als Blob
                    const response = await fetch(downloadUrl);
                    if (!response.ok) {
                        throw new Error('Bild konnte nicht geladen werden');
                    }
                    
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    
                    // Erstelle Download-Link
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Cleanup
                    window.URL.revokeObjectURL(blobUrl);
                } else {
                    // F√ºr lokale Bilder: Direkter Download
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error('Download-Fehler:', error);
                // Fallback: √ñffne in neuem Tab
                window.open(imageUrl, '_blank');
            }
        }
        
        // Tastatur-Navigation
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('active')) {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowRight') nextImage();
                if (e.key === 'ArrowLeft') previousImage();
            }
        });
        
        // Initialisierung
        (async () => {
            await loadConfig();
            
            if (!galleryConfig) {
                document.getElementById('error').style.display = 'block';
                return;
            }
            
            // Pr√ºfe ob mehrere Galerien vorhanden sind
            console.log('Galerien gefunden:', galleryConfig.galleries?.length || 0);
            if (galleryConfig.galleries && galleryConfig.galleries.length > 0) {
                // Zeige immer Galerie-Auswahl (auch bei nur einer Galerie)
                console.log('Zeige Galerie-Auswahl');
                showGallerySelector();
            } else {
                // Fallback: Alte Struktur (nur images Array)
                if (galleryConfig.images && galleryConfig.images.length > 0) {
                    // Konvertiere alte Struktur zu neuer
                    currentImages = galleryConfig.images;
                    document.getElementById('gallery-container').style.display = 'block';
                    displayGallery(currentImages);
                } else {
                    document.getElementById('error').style.display = 'block';
                }
            }
        })();
    </script>
</body>
</html>
